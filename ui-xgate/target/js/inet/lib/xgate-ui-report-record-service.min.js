$(function(){iNet.ns("iNet.ui.report","iNet.ui.report.Record");iNet.ui.report.Record=function(){this.id="report-record-div";var g=this,b={record:iNet.resources.xgate.report.record,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},h={SEARCH:$("#report-record-search-btn"),PRINT:$("#report-record-print-btn"),VIEW:$("#report-record-view-btn"),EXPORT:$("#report-record-export-btn")},i={procedureList:iNet.getUrl("onegate/procedure/maplist"),
report:iNet.getUrl("firmtask/report/task"),view:iNet.getUrl("onegate/deptrecord/report"),generator:iNet.getUrl("onegate/excel/generator"),chkstatus:iNet.getUrl("report/file/chkstatus"),download:iNet.getUrl("report/file/download")},c={fromDate:$("#report-record-from"),toDate:$("#report-record-to"),procedure:$("#report-record-procedure"),status:$("#report-record-status"),report:$("#report-record-content")},m=c.fromDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",function(){m.hide()}).data("datepicker");
c.fromDate.val(CommonService.getFirstDate());var n=c.toDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",function(){n.hide()}).data("datepicker");c.toDate.val(CommonService.getCurrentDate());c.procedure=FormService.createSelect("report-record-procedure",[],"id",1,true,false);$.postJSON(i.procedureList,{},function(a){var d=a||{};if(CommonService.isSuccess(d)){var e=[];$.each(d.elements||[],function(f,j){e.push({id:j.uuid,code:j.uuid,name:j.subject})});c.procedure=FormService.createSelect("report-record-procedure",
e,"id",1,true,false)}});var o=[{id:"",code:"",name:b.record.statusAll},{id:"INPROCESS",code:"INPROCESS",name:b.record.statusINPROCESS},{id:"COMPLETED",code:"COMPLETED",name:b.record.statusCOMPLETED},{id:"REJECTED",code:"REJECTED",name:b.record.statusREJECTED},{id:"PUBLISHED",code:"PUBLISHED",name:b.record.statusPUBLISHED}];c.status=FormService.createSelect("report-record-status",o,"id",1,true,false);c.status.setValue("");var p=new DataSource({columns:[{property:"procedureName",label:b.record.procedureName,
sortable:true,disabled:true},{property:"subject",label:b.record.subject,sortable:true,disabled:true},{property:"fullName",label:b.record.fullName,sortable:true,disabled:true},{property:"recordBook",label:b.record.recordBook,sortable:true,disabled:true},{property:"recordOrder",label:b.record.recordOrder,sortable:true,disabled:true},{property:"status",label:b.record.status,sortable:true,disabled:true},{property:"created",label:b.record.created,sortable:true,disabled:true},{property:"appointment",label:b.record.appointment,
sortable:true,disabled:true},{property:"completed",label:b.record.completed,sortable:true,disabled:true}],delay:250}),k=new iNet.ui.grid.Grid({id:"report-record-grid",url:i.view,params:{},convertData:function(a){var d=a||{};$.each(d.items||[],function(e,f){f.status=b.record["status"+f.status]||"";f.created=f.created>0?(new Date(f.created)).format("H:i d/m/Y"):"";f.appointment=f.appointment>0?(new Date(f.appointment)).format("H:i d/m/Y"):"";f.completed=f.completed>0?(new Date(f.completed)).format("H:i d/m/Y"):
""});return d.items},dataSource:p,stretchHeight:false,editable:false,firstLoad:false,idProperty:"uuid"});h.SEARCH.on("click",function(){var a={};a.from=c.fromDate.val().dateToLong();a.to=c.toDate.val().endDateToLong();a.procedure=c.procedure.getValue()||"";a.status=c.status.getValue()||"";$.postJSON(i.report,a,function(d){var e=d||{};h.PRINT.hide();if(CommonService.isSuccess(e)){c.report.html(e);h.PRINT.show()}else g.notifyError(b.constant.submit_title,g.getNotifyContent(b.constant.submit_error,e.errors||
[]))},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})});h.PRINT.on("click",function(){var a=document.createElement("iframe");a.name="framePrint";a.style.position="absolute";a.style.top="-1000000px";document.body.appendChild(a);var d=a.contentWindow?a.contentWindow:a.contentDocument.document?a.contentDocument.document:a.contentDocument;d.document.open();d.document.write(c.report.html());d.document.close();setTimeout(function(){window.frames.framePrint.focus();window.frames.framePrint.print();
document.body.removeChild(a)},500)});h.VIEW.on("click",function(){var a={};a.from=c.fromDate.val().dateToLong();a.to=c.toDate.val().endDateToLong();a.procedure=c.procedure.getValue()||"";a.status=c.status.getValue()||"";k.setParams(a);k.load();h.EXPORT.show()});var l=function(a){$.postJSON(i.chkstatus,{reportID:a},function(d){var e=d||0;if(e==2)window.location.href=i.download+"?reportID="+a;else e==1&&setTimeout(function(){l(a)},2E3)},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})};h.EXPORT.on("click",
function(){var a=k.getParams()||{};a.type="Record";$.postJSON(i.generator,a,function(d){var e=d||{};CommonService.isSuccess(e)?setTimeout(function(){l(e.uuid)},2E3):g.notifyError(b.constant.submit_title,g.getNotifyContent(b.constant.submit_error,e.errors||[]))},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})});iNet.ui.report.Record.superclass.constructor.call(this)};iNet.extend(iNet.ui.report.Record,iNet.ui.app.widget);(new iNet.ui.report.Record).show()});