$(function(){iNet.ns("iNet.ui.report","iNet.ui.report.History");iNet.ui.report.History=function(){this.id="report-history-div";var g=this,e={report:iNet.resources.xgate.report.history,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},h={SEARCH:$("#report-history-search-btn"),PRINT:$("#report-history-print-btn"),VIEW:$("#report-history-view-btn"),EXPORT:$("#report-history-export-btn")},i={graphList:iNet.getUrl("cloud/workflow/defproc/list"),
userList:iNet.getUrl("system/account/role"),report:iNet.getUrl("firmtask/report/history"),view:iNet.getUrl("firmtask/view/history"),generator:iNet.getUrl("onegate/excel/generator"),chkstatus:iNet.getUrl("report/file/chkstatus"),download:iNet.getUrl("report/file/download")},b={fromDate:$("#report-history-from"),toDate:$("#report-history-to"),processor:$("#report-history-processor"),graph:$("#report-history-graph"),report:$("#report-history-content")},m=b.fromDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",
function(){m.hide()}).data("datepicker");b.fromDate.val(CommonService.getFirstDate());var n=b.toDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",function(){n.hide()}).data("datepicker");b.toDate.val(CommonService.getCurrentDate());b.processor=FormService.createSelect("report-history-processor",[],"id",1,true,false);$.postJSON(i.userList,{},function(a){var c=a||{};if(CommonService.isSuccess(c)){var d=[];$.each(c.items||[],function(f,j){d.push({id:j.username,code:j.username,name:j.fullname})});
b.processor=FormService.createSelect("report-history-processor",d,"id",1,true,false)}});b.graph=FormService.createSelect("report-history-graph",[],"id",1,true,false);$.postJSON(i.graphList,{zone:iNet.zone,context:iNet.context,version:"PRODUCTION"},function(a){var c=a||{};if(CommonService.isSuccess(c)){var d=[];$.each(c.items||[],function(f,j){d.push({id:j.uuid,code:j.uuid,name:j.name})});b.graph=FormService.createSelect("report-history-graph",d,"id",1,true,false)}});var o=new DataSource({columns:[{property:"taskName",
label:e.report.taskName,sortable:true,disabled:true},{property:"processorName",label:e.report.processorName,sortable:true,disabled:true},{property:"created",label:e.report.created,sortable:true,disabled:true},{property:"completedTime",label:e.report.completedTime,sortable:true,disabled:true},{property:"status",label:e.report.status,sortable:true,disabled:true}],delay:250}),k=new iNet.ui.grid.Grid({id:"report-history-grid",url:i.view,params:{},convertData:function(a){var c=a||{};$.each(c.items||[],
function(d,f){f.status=e.report.statusCreated;if(f.completedTime>0)f.status=e.report.statusCompleted;f.completedTime=(f.completedTime||0)>0?(f.completedTime||0).longToDate():"";f.created=(f.created||0).longToDate()});return c.items},dataSource:o,stretchHeight:false,editable:false,firstLoad:false,idProperty:"uuid"});h.SEARCH.on("click",function(){var a={};a.from=b.fromDate.val().dateToLong();a.to=b.toDate.val().endDateToLong();a.processor=b.processor.getValue()||"";a.graph=b.graph.getValue()||"";$.postJSON(i.report,
a,function(c){var d=c||{};h.PRINT.hide();if(CommonService.isSuccess(d)){b.report.html(d);h.PRINT.show()}else g.notifyError(e.constant.submit_title,g.getNotifyContent(e.constant.submit_error,d.errors||[]))},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})});h.PRINT.on("click",function(){var a=document.createElement("iframe");a.name="framePrint";a.style.position="absolute";a.style.top="-1000000px";document.body.appendChild(a);var c=a.contentWindow?a.contentWindow:a.contentDocument.document?
a.contentDocument.document:a.contentDocument;c.document.open();c.document.write(b.report.html());c.document.close();setTimeout(function(){window.frames.framePrint.focus();window.frames.framePrint.print();document.body.removeChild(a)},500)});h.VIEW.on("click",function(){var a={};a.from=b.fromDate.val().dateToLong();a.to=b.toDate.val().endDateToLong();a.processor=b.processor.getValue()||"";a.graph=b.graph.getValue()||"";k.setParams(a);k.load();h.EXPORT.show()});var l=function(a){$.postJSON(i.chkstatus,
{reportID:a},function(c){var d=c||0;if(d==2)window.location.href=i.download+"?reportID="+a;else d==1&&setTimeout(function(){l(a)},2E3)},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})};h.EXPORT.on("click",function(){var a=k.getParams()||{};a.type="Task";$.postJSON(i.generator,a,function(c){var d=c||{};CommonService.isSuccess(d)?setTimeout(function(){l(d.uuid)},2E3):g.notifyError(e.constant.submit_title,g.getNotifyContent(e.constant.submit_error,d.errors||[]))},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})});
iNet.ui.report.History.superclass.constructor.call(this)};iNet.extend(iNet.ui.report.History,iNet.ui.app.widget);(new iNet.ui.report.History).show()});