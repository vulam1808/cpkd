$(function(){iNet.ns("iNet.ui.workflow","iNet.ui.workflow.WFActorMap");iNet.ui.workflow.WFActorMap=function(){this.id="actor-map-div";console.log(">>>> C,E,D,V >>>> ",roleCreate,roleEdit,roleDelete,roleView);var p=iNet.zone,q=iNet.context,d=[],k={},h=this,n=null,o=false,e={actormap:iNet.resources.workflow.actormap,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},i={BACK:$("#actor-map-back-btn"),CREATE:$("#actor-map-create-btn"),
SAVE:$("#actor-map-save-btn"),DELETE:$("#actor-map-delete-btn")};i.DELETE.hide();i.CREATE.hide();i.SAVE.hide();var f={actor:$("#actor-map-actor-txt"),name:$("#actor-map-name-txt"),list:$("#actor-map-list"),user:$("#actor-map-user")},l={view:iNet.getUrl("firmtask/actormap/list"),create:iNet.getUrl("firmtask/actormap/create"),update:iNet.getUrl("firmtask/actormap/update"),del:iNet.getUrl("firmtask/actormap/delete"),load_user:iNet.getUrl("system/account/role")};this.loadData=function(b,c){if(iNet.isEmpty(c))c=
true;var a=b||{};k=a;f.actor.val(a.actor||"");f.name.val(a.name||"");d=a.members||[];c&&g.load();if(iNet.isEmpty(a.uuid)){FormService.enable(f.actor);FormService.enable(f.name)}else{FormService.disable(f.actor);FormService.disable(f.name)}};this.setPageBack=function(b){n=b};var m=new DataSource({columns:[{property:"map",label:e.actormap.map,sortable:true,type:"checkbox",width:30},{property:"username",label:e.actormap.username,sortable:true,disabled:true,type:"text",width:150},{property:"fullname",
label:e.actormap.fullname,sortable:true,disabled:true,type:"text",width:150}],delay:250}),g=new iNet.ui.grid.Grid({id:"actor-map-grid",url:l.load_user,params:{},convertData:function(b){var c=b||{};b=c.items||[];$.each(b,function(a,j){j.map=d.indexOf(j.username)>=0});return b},dataSource:m,stretchHeight:false,editable:roleEdit,firstLoad:false,idProperty:"uuid"});g.on("save",function(){});g.on("update",function(){});g.on("blur",function(){});g.on("selectionchange",function(){});g.on("change",function(b,
c){var a=iNet.apply(b,c);g.update(a);g.commit();console.log(">> grid change >>",a.map,a.username,d);if(a.map)d.push(a.username);else d.indexOf(a.username)>=0&&d.splice(d.indexOf(a.username),1);r()});var r=function(){var b={zone:p,context:q,member:d.join(iNet.splitChar),actor:f.actor.val(),name:f.name.val()};if(!iNet.isEmpty(k.uuid))b.uuid=k.uuid;if(iNet.isEmpty(b.actor))h.notifyError(e.constant.save_title,h.getNotifyContent(e.validate.is_not_blank,e.actormap.actor));else{var c=iNet.isEmpty(b.uuid)?
l.create:l.create;$.postJSON(c,b,function(a){var j=a||{};if(CommonService.isSuccess(j))o=true;else h.notifyError(e.constant.save_title,h.getNotifyContent(e.constant.save_error,j.errors||[]))},{msg:iNet.resources.ajaxLoading.processing,mask:h.getMask()})}};m=function(){h.hide();n.show();o&&this.fireEvent("finish")}.createDelegate(this);i.BACK.on("click",m);i.CREATE.on("click",function(){h.loadData({})});iNet.ui.workflow.WFActorMap.superclass.constructor.call(this)};iNet.extend(iNet.ui.workflow.WFActorMap,
iNet.ui.app.widget)});