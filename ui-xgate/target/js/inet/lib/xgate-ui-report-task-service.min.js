$(function(){iNet.ns("iNet.ui.report","iNet.ui.report.Task");iNet.ui.report.Task=function(){this.id="report-task-div";var g=this,e={task:iNet.resources.xgate.report.task,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},h={SEARCH:$("#report-task-search-btn"),PRINT:$("#report-task-print-btn"),VIEW:$("#report-task-view-btn"),EXPORT:$("#report-task-export-btn")},i={procedurelist:iNet.getUrl("onegate/procedurelist"),userList:iNet.getUrl("system/account/role"),
report:iNet.getUrl("onegate/taskreport"),view:iNet.getUrl("onegate/taskreport"),generator:iNet.getUrl("onegate/excel/generator"),chkstatus:iNet.getUrl("report/file/chkstatus"),download:iNet.getUrl("report/file/download")},d={fromDate:$("#report-task-from"),toDate:$("#report-task-to"),processor:$("#report-task-processor"),procedure:$("#report-task-procedure"),type:$("#report-task-type"),keyword:$("#report-task-keyword"),serialNo:$("#report-task-serialNo"),receiptNo:$("#report-task-receiptNo"),report:$("#report-task-content")},
n=d.fromDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",function(){n.hide()}).data("datepicker");d.fromDate.val(CommonService.getFirstDate());var o=d.toDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",function(){o.hide()}).data("datepicker");d.toDate.val(CommonService.getCurrentDate());d.processor=FormService.createSelect("report-task-processor",[],"id",2,true,false);$.postJSON(i.userList,{},function(a){var c=a||{};if(CommonService.isSuccess(c)){var f=[];$.each(c.items||[],function(b,
j){f.push({id:j.username,code:j.username,name:j.fullname})});d.processor=FormService.createSelect("report-task-processor",f,"id",2,true,false)}});d.procedure=FormService.createSelect("report-task-procedure",[],"id",1,true,false);$.postJSON(i.procedurelist,{},function(a){var c=a||{};if(CommonService.isSuccess(c)){var f=[];$.each(c.elements||[],function(b,j){f.push({id:j.uuid,code:j.uuid,name:j.subject})});d.procedure=FormService.createSelect("report-task-procedure",f,"id",1,true,false)}});var q=[{id:1,
code:1,name:e.task.typeLate},{id:2,code:2,name:e.task.typeProcess},{id:3,code:3,name:e.task.typeComplete}],p=new DataSource({columns:[{property:"subject",label:e.task.subject,sortable:true,disabled:true},{property:"serialNo",label:e.task.serialNo,sortable:true,disabled:true},{property:"receiptNo",label:e.task.receiptNo,sortable:true,disabled:true},{property:"taskName",label:e.task.taskName,sortable:true,disabled:true},{property:"taskProcessorName",label:e.task.processorName,sortable:true,disabled:true},
{property:"taskCreated",label:e.task.created,sortable:true,disabled:true},{property:"taskExpiredTask",label:e.task.expiredTime,sortable:true,disabled:true},{property:"taskCompletedTime",label:e.task.completedTime,sortable:true,disabled:true}],delay:250}),k=new iNet.ui.grid.Grid({id:"report-task-grid",url:i.view,params:{pageNumber:0,pageSize:10},convertData:function(a){var c=a||{};k.setTotal(c.total);$.each(c.items||[],function(f,b){b.status=e.task.statusCreated;if(b.taskCompletedTime>0)b.status=e.task.statusCompleted;
if(b.taskName=="xgate.receiver")b.taskName=e.task.xgateReceiver||"";if(b.appointment>0&&(b.taskExpiredTask||0)==0)b.taskExpiredTask=b.appointment;b.taskExpiredTask=b.taskExpiredTask>0?(new Date).getTime()>b.taskExpiredTask&&b.taskCompletedTime==0||b.taskCompletedTime>b.taskExpiredTask?'<label style="color: #ff0511;font-weight: bolder;">'+(new Date(b.taskExpiredTask)).format("H:i d/m/Y")+"</label>":'<label style="color:#0000C0;font-weight: bolder;">'+(new Date(b.taskExpiredTask)).format("H:i d/m/Y")+
"</label>":"";b.taskCompletedTime=(b.taskCompletedTime||0)>0?(new Date(b.taskCompletedTime)).format("H:i d/m/Y"):"";b.taskCreated=(new Date(b.taskCreated)).format("H:i d/m/Y")});return c.items},dataSource:p,stretchHeight:false,editable:false,firstLoad:false,remotePaging:true,idProperty:"uuid"}),l=function(){var a=k.getParams()||{};a.from=d.fromDate.val().dateToLong();a.to=d.toDate.val().endDateToLong();if(d.processor!=null)a.processor=d.processor.getValue()||"";if(d.procedure!=null)a.procedureID=
d.procedure.getValue()||"";a.keyword=d.keyword.val();a.serial=d.serialNo.val();a.receipt=d.receiptNo.val();return a};h.SEARCH.on("click",function(){$.postJSON(i.report,l(),function(a){var c=a||{};h.PRINT.hide();if(CommonService.isSuccess(c)){d.task.html(c);h.PRINT.show()}else g.notifyError(e.constant.submit_title,g.getNotifyContent(e.constant.submit_error,c.errors||[]))},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})});h.PRINT.on("click",function(){var a=document.createElement("iframe");
a.name="framePrint";a.style.position="absolute";a.style.top="-1000000px";document.body.appendChild(a);var c=a.contentWindow?a.contentWindow:a.contentDocument.document?a.contentDocument.document:a.contentDocument;c.document.open();c.document.write(d.task.html());c.document.close();setTimeout(function(){window.frames.framePrint.focus();window.frames.framePrint.print();document.body.removeChild(a)},500)});h.VIEW.on("click",function(){k.setParams(l());k.load();h.EXPORT.show()});var m=function(a){$.postJSON(i.chkstatus,
{reportID:a},function(c){var f=c||0;if(f==2)window.location.href=i.download+"?reportID="+a;else f==1&&setTimeout(function(){m(a)},2E3)},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})};h.EXPORT.on("click",function(){var a=k.getParams()||{};a.type="Task";$.postJSON(i.generator,a,function(c){var f=c||{};CommonService.isSuccess(f)?setTimeout(function(){m(f.uuid)},2E3):g.notifyError(e.constant.submit_title,g.getNotifyContent(e.constant.submit_error,f.errors||[]))},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})});
iNet.ui.report.Task.superclass.constructor.call(this)};iNet.extend(iNet.ui.report.Task,iNet.ui.app.widget);(new iNet.ui.report.Task).show()});