(function(d){var j={url:document.URL,method:"POST",extraData:{},maxFileSize:0,maxFiles:0,allowedTypes:"*",extFilter:null,dataType:null,fileName:"file",onInit:function(){},onFallbackMode:function(){},onNewFile:function(){},onBeforeUpload:function(){},onComplete:function(){},onUploadProgress:function(){},onUploadSuccess:function(){},onUploadError:function(){},onFileTypeError:function(){},onFileSizeError:function(){},onFileExtError:function(){},onFilesMaxError:function(){}},h=function(a,b){this.element=
d(a);this.settings=d.extend({},j,b);if(!this.checkBrowser())return false;this.init();return true};h.prototype.checkBrowser=function(){if(window.FormData===undefined){this.settings.onFallbackMode.call(this.element,"Browser doesn't support Form API");return false}if(this.element.find("input[type=file]").length>0)return true;if(!this.checkEvent("drop",this.element)||!this.checkEvent("dragstart",this.element)){this.settings.onFallbackMode.call(this.element,"Browser doesn't support Ajax Drag and Drop");
return false}return true};h.prototype.checkEvent=function(a,b){b=b||document.createElement("div");a="on"+a;var f=a in b;if(!f){b.setAttribute||(b=document.createElement("div"));if(b.setAttribute&&b.removeAttribute){b.setAttribute(a,"");f=typeof b[a]=="function";if(typeof b[a]!="undefined")b[a]=undefined;b.removeAttribute(a)}}return f};h.prototype.init=function(){var a=this;a.queue=[];a.queuePos=-1;a.queueRunning=false;a.element.on("drop",function(b){b.preventDefault();a.queueFiles(b.originalEvent.dataTransfer.files)});
a.element.find("input[type=file]").on("change",function(b){a.queueFiles(b.target.files);d(this).val("")});this.settings.onInit.call(this.element)};h.prototype.queueFiles=function(a){for(var b=this.queue.length,f=0;f<a.length;f++){var c=a[f];if(this.settings.maxFileSize>0&&c.size>this.settings.maxFileSize)this.settings.onFileSizeError.call(this.element,c);else if(this.settings.allowedTypes!="*"&&!c.type.match(this.settings.allowedTypes))this.settings.onFileTypeError.call(this.element,c);else{if(this.settings.extFilter!=
null){var g=this.settings.extFilter.toLowerCase().split(";"),i=c.name.toLowerCase().split(".").pop();if(d.inArray(i,g)<0){this.settings.onFileExtError.call(this.element,c);continue}}if(this.settings.maxFiles>0)if(this.queue.length>=this.settings.maxFiles){this.settings.onFilesMaxError.call(this.element,c);continue}this.queue.push(c);this.settings.onNewFile.call(this.element,this.queue.length-1,c)}}if(this.queueRunning)return false;if(this.queue.length==b)return false;this.processQueue();return true};
h.prototype.processQueue=function(){var a=this;a.queuePos++;if(a.queuePos>=a.queue.length){a.settings.onComplete.call(a.element);a.queuePos=a.queue.length-1;a.queueRunning=false}else{var b=a.queue[a.queuePos],f=new FormData;f.append(a.settings.fileName,b);if(false!==a.settings.onBeforeUpload.call(a,a.queuePos)){d.each(a.getExData(),function(c,g){f.append(c,g)});a.queueRunning=true;d.ajax({url:a.settings.url,type:a.settings.method,dataType:a.settings.dataType,data:f,cache:false,contentType:false,processData:false,
forceSync:false,xhr:function(){var c=d.ajaxSettings.xhr();c.upload&&c.upload.addEventListener("progress",function(g){var i=0,k=g.loaded||g.position,l=g.total||e.totalSize;if(g.lengthComputable)i=Math.ceil(k/l*100);a.settings.onUploadProgress.call(a.element,a.queuePos,i)},false);return c},success:function(c){a.settings.onUploadSuccess.call(a.element,a.queuePos,c)},error:function(c,g,i){a.settings.onUploadError.call(a.element,a.queuePos,i)},complete:function(){a.processQueue()}})}}};h.prototype.setExData=
function(a){this.settings.extraData=a};h.prototype.getExData=function(){return this.settings.extraData};d.fn.dmUploader=function(a){return this.each(function(){d.data(this,"dmUploader")||d.data(this,"dmUploader",new h(this,a))})};d(document).on("dragenter",function(a){a.stopPropagation();a.preventDefault()});d(document).on("dragover",function(a){a.stopPropagation();a.preventDefault()});d(document).on("drop",function(a){a.stopPropagation();a.preventDefault()})})(jQuery);