$(function(){iNet.ns("iNet.ui.task","iNet.ui.task.TQueue");iNet.ui.task.TQueue=function(B){this.id="queue-div";var i=this,p={};p.itemsSelected=[];var q=null,m=null,r=B||{},g={isBack:false,queueID:typeof queueID=="undefined"?"":queueID,keyword:typeof keyword=="undefined"?"":keyword,pageParent:typeof pageParent=="undefined"?"":pageParent,pageUrl:typeof pageUrl=="undefined"?"":pageUrl};if(!iNet.isEmpty((iNet.getLayout()||{}).parentParams||{})){iNet.apply(r,(iNet.getLayout()||{}).parentParams||{});iNet.getLayout().parentParams=
{}}if(!iNet.isEmpty(r)){g.queueID=r.queueID;g.keyword=r.keyword;g.pageParent=r.pageParent;g.pageUrl=r.pageUrl}if(!iNet.isEmpty(g.pageParent)||!iNet.isEmpty(g.pageUrl)||!iNet.isEmpty(g.queueID))g.isBack=true;console.log("ctx",g);var s={queue:iNet.resources.receiver.queue,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},j={search_request:iNet.getUrl("firmtask/process/queue"),view_request:iNet.getUrl("onegate/deptrecord/load"),
view_record:iNet.getUrl("onegate/deptrecord/view"),update_request:iNet.getUrl("onegate/deptrecord/update"),submit_request:iNet.getUrl("onegate/process/submit"),delete_queue:iNet.getUrl("firmtask/reject/queue"),signverify:iNet.getUrl("onegate/externaldata/signverify"),downloadFile:iNet.getUrl("onegate/binary/download")},v=iNet.getLayout().taskMenu;v.on("menuchange",function(){});v.on("create",function(){x()});var C=function(){if(m==null){m=new iNet.ui.UserProfile;m.on("back",function(a){m.hide();iNet.isEmpty(a)||
t();i.show()})}return m},x=function(){if(q==null)q=new iNet.ui.task.TRequest;q.on("finish",function(a){i.show();q.hide();iNet.isEmpty(a)||t()});q.setData({});q.show();i.hide()},c=new iNet.ui.listview({id:"queue-list",uiItemId:"queue-list-item-ui",url:j.search_request,basicSearch:function(){this.id="queue-list-basic-search";this.intComponent=function(){var a=this,e=$("#queue-list-basic-search-expand-btn"),d=$("#queue-list-basic-search-search-btn");this.$keyword=$("#queue-list-basic-search-txt-keyword");
this.$keyword.val(g.keyword||"");this.$keyword.on("keyup",function(h){if(h.which==13){var n=c.getParams()||{};n.keyword=a.$keyword.val();c.setParams(n);c.load()}});d.on("click",function(){var h=c.getParams()||{};h.keyword=a.$keyword.val();c.setParams(h);c.load()});e.on("click",function(){})}},toolbar:function(){this.id="queue-list-toolbar";this.intComponent=function(){this.$addBtn=$("#queue-list-add-btn");this.$addBtn.removeClass("hide");this.$addBtn.on("click",function(){x()}.createDelegate(this));
this.$sendBtn=$("#queue-list-send-btn");this.$sendBtn.on("click",function(){y(c.getSelected()||[])})}},pullLeft:function(){this.id="queue-list-pull-left";this.intComponent=function(){}},params:{pageSize:20,pageNumber:0,status:"QUEUE",queueID:g.queueID,keyword:g.keyword},convertData:function(a){var e=a||{};c.setTotal(e.total);$.each(e.items||[],function(d,h){c.addItem(h)})}});c.on("itemselected",function(a){p.itemsSelected=a||[];(a||[]).length>0?c.toolbar.$sendBtn.show():c.toolbar.$sendBtn.hide()});
c.on("indexchange",function(a){b.reset();iNet.isEmpty(a.uuid)||$.postJSON(j.view_request,{request:a.uuid},function(e){var d=e||{};console.log("view_request result >>",d);b.setData(d);var h={subject:a.subject||"",showAttachmentIcon:false,showCommentIcon:false,showDetailsIcon:false},n={name:a.requestorName,date:" ("+$.timeago(a.requestTime)+")",showDetailsIcon:false};b.setHeader({subject:h,sender:n,object:d});b.setSubmitContent(d.content);var f=(d.request||{}).comments||[],w=(d.request||{}).attachments||
[];$.postJSON(j.view_record,{request:a.uuid},function(k){var u=k||{},l=(u.record||{}).documents||[];b.setFooter({comments:f,attBriefs:w,docRecord:l})},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})});c.on("typechange",function(a){a=="max"?b.setType("min"):b.setType("full")});var z=new iNet.ui.fileview;z.setPageBack(i);var o=new iNet.ui.modalview;o.on("success",function(){this.hide();t()});var y=function(){var a=0;$(p.itemsSelected).each(function(e,
d){var h=d.value||{};if(d.submited)a++;else{d.submited=true;b.setSubmitContent("");b.resetBodyHidden();b.addBodyHidden("request",h.uuid);b.addBodyHidden("subject",h.subject);b.addBodyHidden("form",h.formID);b.submit(j.submit_request);return false}})},A=function(a){var e=!iNet.isFunction(((iNet||{}).requestData||{}).messageValidate)?"":((iNet||{}).requestData||{}).messageValidate();console.log(">> submitRequest validate >>",{messageValidate:e});var d=a||"";iNet.isEmpty(e)&&!iNet.isEmpty(d)?b.submit(d):
i.notifyError(s.constant.warning_title,e)},b=new iNet.ui.itemview({id:"queue-view",resource:s,url:j,toolbar:function(){this.id="queue-toolbar";this.intComponent=function(){var a=$("#queue-view-save-btn"),e=$("#queue-view-send-btn"),d=$("#queue-view-delete-btn");this.$backBtn=$("#queue-view-back-btn");var h=$("#queue-view-print-formNo03-btn"),n=$("#queue-view-print-formNo04-btn");d.on("click",function(){var f=c.getData()||{};o.setTitle($(this).text());o.setDescription(f.subject);o.setParams({queueID:f.uuid});
o.setUrl(j.delete_queue);o.setTop(50);o.show()});a.on("click",function(){$("#"+b.id).find('[type="file"]').each(function(w,k){var u=$(k).attr("name")||"",l=$(k).parent().parent();if(l.find(".data-content[data-content]:first").css("display")!="none")iNet.isEmpty($(k).val())&&l.append('<div data-action="fileRemove" class="hide"><input type="text" name="'+u+'_removed" value="removed"></div>');else l.find('[data-action="fileRemove"]').remove()});var f=c.getData()||{};b.resetBodyHidden();b.addBodyHidden("request",
f.uuid);b.addBodyHidden("subject",f.subject);A(j.update_request)});e.on("click",function(){$("#"+b.id).find('[type="file"]').each(function(w,k){var u=$(k).attr("name")||"",l=$(k).parent().parent();if(l.find(".data-content[data-content]:first").css("display")!="none")iNet.isEmpty($(k).val())&&l.append('<div data-action="fileRemove" class="hide"><input type="text" name="'+u+'_removed" value="removed"></div>');else l.find('[data-action="fileRemove"]').remove()});var f=c.getData()||{};b.resetBodyHidden();
b.addBodyHidden("request",f.uuid);b.addBodyHidden("subject",f.subject);b.addBodyHidden("form",f.formID);A(j.submit_request)});h.on("click",function(){var f=(c.getData()||{}).uuid||"";iNet.isEmpty(f)||window.open(iNet.getUrl(CommonService.pageRequest.formNo03)+"?task="+f,"_blank")});n.on("click",function(){var f=(c.getData()||{}).uuid||"";iNet.isEmpty(f)||window.open(iNet.getUrl(CommonService.pageRequest.formNo04)+"?task="+f,"_blank")});this.$backBtn.on("click",function(){if(iNet.isEmpty(g.pageUrl)){if(!iNet.isEmpty(g.pageParent)){i.hide();
g.pageParent.show()}}else{var f=iNet.getUrl(CommonService.pageRequest.xgate)+CommonService.pageRequest.hashtag[g.pageUrl];iNet.getLayout().window.location.href=f}i.fireEvent("back")}.createDelegate(this));$("#queue-view-userprofile-btn").on("click",function(){var f=(((c.getData()||{}).requestData||{}).userProfile||{}).uuid||"";console.log("__profileID",f);if(!iNet.isEmpty(f)){m=C();m.setProfile(f);m.show();i.hide()}})}},ajaxMaskId:"ajax-mask",headerDetails:{subject:"queue-subject-details",sender:"queue-sender-details"}});
b.on("submitted",function(a){var e=a||{},d=0;$(p.itemsSelected).each(function(h,n){if(n.submited)d++;else{y();return false}});if(d>0){if(p.itemsSelected.length==d){p.itemsSelected=[];t()}}else if(e.type=="error")i.notifyError(s.constant.submit_title,i.getNotifyContent(s.constant.submit_error,e.errors||[]));else{i.notifySuccess(s.constant.submit_title,s.constant.submit_success);g.isBack?b.$backBtn.trigger("click"):t()}});b.on("headerchange",function(a){console.log(">>headerchange>>",a)});b.on("menuclick",
function(){c.setType("menu")});b.on("fileclick",function(a){var e=a||{};if(!iNet.isEmpty(e.uuid)){if(e.action=="viewfile"){z.viewFile(e.uuid);i.hide()}e.action=="downfile"&&window.open(j.downloadFile+"?binary="+e.uuid,"_blank")}});this.setData=function(a){var e=a||{},d=c.getParams()||{};d.queueID=e.queueID||"";c.setParams(d);c.refresh();g.isBack=true;b.toolbar.$backBtn.show()};var t=function(){v.refresh("queue");c.refresh();c.toolbar.$sendBtn.hide()};g.isBack&&b.toolbar.$backBtn.show();iNet.ui.task.TQueue.superclass.constructor.call(this)};
iNet.extend(iNet.ui.task.TQueue,iNet.ui.app.widget)});