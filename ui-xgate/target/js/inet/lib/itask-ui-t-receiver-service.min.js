$(function(){iNet.ns("iNet.ui.task","iNet.ui.task.TReceiver");iNet.ui.task.TReceiver=function(){this.id="receiver-div";var i=this,q=null,t={status:typeof status=="undefined"?"CREATED":status,assign:typeof assign=="undefined"?true:assign,replyForOrgID:typeof replyForOrgID=="undefined"?false:replyForOrgID},e={task:iNet.resources.receiver.task,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},j={task_query:iNet.getUrl("onegate/additional/taskquery"),
get_task_view:iNet.getUrl("onegate/additional/view"),reject_ticket:iNet.getUrl("onegate/ticketreject"),signverify:iNet.getUrl("onegate/externaldata/signverify"),downloadFile:iNet.getUrl("onegate/binary/download"),firms:iNet.getUrl("onegate/expwayfirms"),transfer:iNet.getUrl("onegate/additional/expway"),additional_view:iNet.getUrl("onegate/externaldata/request"),additional_submit:iNet.getUrl("onegate/externaldata/reqsubmit"),additional_create:iNet.getUrl("onegate/dictadditional/create"),generator:iNet.getUrl("onegate/excel/generator"),
chkstatus:iNet.getUrl("report/file/chkstatus"),download:iNet.getUrl("report/file/download")},u=iNet.getLayout().taskMenu;u.on("menuchange",function(){});u.on("create",function(){x()});q=null;var x=function(a){if(q==null)q=new iNet.ui.task.TRequest;q.on("finish",function(d){i.show();q.hide();iNet.isEmpty(d)||v()});q.setData(a);q.show();i.hide()},y=function(a){$.postJSON(j.chkstatus,{reportID:a},function(d){var b=d||0;if(b==2)window.location.href=j.download+"?reportID="+a;else b==1&&setTimeout(function(){y(a)},
2E3)},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})},o=function(a){k.hide();n.hide();l.hide();p.hide();if(a=="item"){k.show();A()}if(a=="transfer"){n.show();n.reset();n.dataContent.$grid.load();n.setDataContent("view")}if(a=="additional"){l.show();l.reset();var d=f.getData()||{};l.dataContent.$grid.setParams({"package":d.uuid});l.dataContent.$grid.load();l.setDataContent("view")}if(a=="refuse"){p.show();B()}},w=function(){var a=f.getParams()||{};a.keyword=f.basicSearch.$keyword.val();
a.warnHour=f.advanceSearch.$warnHour.val()||0;f.setParams(a);f.load()},f=new iNet.ui.listview({id:"receiver-list",uiItemId:"receiver-list-item-ui",url:j.task_query,basicSearch:function(){this.id="receiver-list-basic-search";this.intComponent=function(){var a=$("#receiver-list-basic-search-expand-btn"),d=$("#receiver-list-basic-search-search-btn");this.$keyword=$("#receiver-list-basic-search-txt-keyword");this.$keyword.on("keyup",function(b){if(b.which==13){f.advanceSearch.hide();w()}});d.on("click",
function(){f.advanceSearch.hide();w()});a.on("click",function(){f.advanceSearch.show()})}},advanceSearch:function(){this.id="receiver-list-advance-search";this.intComponent=function(){var a=$("#receiver-list-advance-search-search-btn"),d=$("#receiver-list-advance-search-close-btn");this.$warnHour=$("#receiver-list-advance-search-warnHour-txt");a.on("click",function(){f.advanceSearch.hide();w()});d.on("click",function(){f.advanceSearch.hide()})}},toolbar:function(){this.id="receiver-list-toolbar";
this.intComponent=function(){this.$excelBtn=$("#receiver-list-excel-btn");t.status=="REFUSE"&&this.$excelBtn.removeClass("hide");this.$excelBtn.on("click",function(){var a=f.getParams()||{};a.type="Refuse";$.postJSON(j.generator,a,function(d){var b=d||{};CommonService.isSuccess(b)?setTimeout(function(){y(b.uuid)},2E3):i.notifyError(e.constant.submit_title,i.getNotifyContent(e.constant.submit_error,b.errors||[]))},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})}.createDelegate(this))}},
pullLeft:function(){this.id="receiver-list-pull-left";this.intComponent=function(){}},params:{pageSize:20,pageNumber:0,status:t.status,assign:t.assign,replyForOrgID:t.replyForOrgID},convertData:function(a){var d=a||{};f.setTotal(d.total);$.each(d.items||[],function(b,c){f.addItem(c)})}});f.on("indexchange",function(){o("item")});f.on("typechange",function(a){if(a=="max"){k.setType("min");n.setType("min");l.setType("min")}else{k.setType("full");n.setType("full");l.setType("full")}});var z=new iNet.ui.fileview;
z.setPageBack(i);var r=new iNet.ui.modalview;r.on("success",function(){this.hide();v();u.refresh("receiver")});var A=function(){k.reset();var a=f.getData()||{};iNet.isEmpty(a.uuid)||$.postJSON(j.get_task_view,{"package":a.uuid},function(d){var b=d||{};k.setData(b);console.log("view_request result >>",b);var c={subject:a.subject||"",showAttachmentIcon:false,showCommentIcon:false,showDetailsIcon:false},g={name:(a.author||{}).fullName,date:" ("+$.timeago(a.requestTime)+")",showDetailsIcon:false};k.setHeader({subject:c,
sender:g,object:b});k.setSubmitContent(b.content);var h=[],m=(b.pkgdata||{}).attachments||[];k.setFooter({comments:h,attBriefs:m})},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})},k=new iNet.ui.itemview({id:"receiver-view",resource:e,url:j,toolbar:function(){this.id="receiver-view-toolbar";this.intComponent=function(){this.$groupBtn=$("#receiver-view-group-btn");this.$transferBtn=$("#receiver-view-transfer-btn");this.$additionalBtn=$("#receiver-view-additional-btn");this.$createBtn=$("#receiver-view-create-btn");
this.$cancelBtn=$("#receiver-view-cancel-btn");this.$infoBtn=$("#receiver-view-info-btn");if(t.status!="CREATED"){this.$groupBtn.hide();this.$createBtn.hide();this.$cancelBtn.hide();this.$infoBtn.show()}else{this.$groupBtn.show();this.$createBtn.show();this.$cancelBtn.show();this.$infoBtn.hide()}this.$transferBtn.on("click",function(){o("transfer")});this.$additionalBtn.on("click",function(){o("additional")});this.$createBtn.on("click",function(){var a={};a.info=f.getData()||{};a.item=k.getData()||
{};x(a)});this.$cancelBtn.on("click",function(){var a=(k.getData().pkgdata||{}).uuid||"";r.setTop(30);r.setTitle($(this).attr("title"));r.setDescription($(this).attr("description"));r.setAreaName("note");r.setAdditional(j.reject_ticket,{additionalID:a});r.show()});this.$infoBtn.on("click",function(){o("refuse")})}},ajaxMaskId:"ajax-mask",headerDetails:{subject:"receiver-view-subject-details",sender:"receiver-view-sender-details"}});k.on("headerchange",function(a){console.log(">>headerchange>>",a)});
k.on("menuclick",function(){f.setType("menu")});k.on("fileclick",function(a){var d=a||{};if(!iNet.isEmpty(d.uuid)){if(d.action=="viewfile"){z.viewFile(d.uuid);i.hide()}d.action=="downfile"&&window.open(j.downloadFile+"?binary="+d.uuid,"_blank")}});var n=new iNet.ui.itemview({id:"receiver-transfer",resource:e,url:j,toolbar:function(){this.id="receiver-transfer-toolbar";this.intComponent=function(){this.$briefcaseBtn=$("#receiver-transfer-briefcase-btn");this.$additionalBtn=$("#receiver-transfer-additional-btn");
this.$sendBtn=$("#receiver-transfer-send-btn");this.$briefcaseBtn.on("click",function(){o("item")});this.$additionalBtn.on("click",function(){o("additional")});this.$sendBtn.on("click",function(){var a=(k.getData().pkgdata||{}).uuid||"",d=n.dataContent.$dataReceiver||"";if(!iNet.isEmpty(d)&&!iNet.isEmpty(a)){var b=n.dataContent.$remove.prop("checked"),c=n.dataContent.$note.val();$.postJSON(j.transfer,{"package":a,receiver:d,remove:b,note:c},function(g){console.log("transfer result >>",g);if(CommonService.isSuccess(g)){v();
i.notifySuccess(e.constant.submit_title,e.constant.submit_success)}else i.notifyError(e.constant.submit_title,i.getNotifyContent(e.constant.submit_error,g.errors||[]))},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})}})}},dataContent:function(){this.id="receiver-transfer-data-content";this.intComponent=function(){var a=this;this.$dataReceiver="";this.$remove=$("#receiver-transfer-agency-remove-chk");this.$note=$("#receiver-transfer-agency-note-txt");var d=new DataSource({columns:[{align:"center",
type:"selection",width:30},{property:"organName",label:e.task.organName,sortable:true,disabled:true},{property:"organAdd",label:e.task.organAdd,sortable:true,disabled:true},{property:"email",label:e.task.email,sortable:true,disabled:true},{property:"telephone",label:e.task.telephone,sortable:true,disabled:true},{property:"fax",label:e.task.fax,sortable:true,disabled:true},{property:"website",label:e.task.website,sortable:true,disabled:true}],delay:250});this.$grid=new iNet.ui.grid.Grid({id:"receiver-transfer-agency-grid",
url:j.firms,params:{},convertData:function(b){var c=b||{};return c.items},dataSource:d,stretchHeight:false,editable:false,firstLoad:false,idProperty:"uuid"});this.$grid.on("selectionchange",function(b){b=b.getSelection();for(var c=b.length,g=[],h=0;h<c;h++){var m=b[h];g.push(m.organId)}if(g.length>0){n.toolbar.$sendBtn.show();a.$dataReceiver=g.join(iNet.splitChar)}else{n.toolbar.$sendBtn.hide();a.$dataReceiver=""}});this.$grid.on("loaded",function(){n.toolbar.$sendBtn.hide()})}},ajaxMaskId:"ajax-mask",
headerDetails:{subject:"receiver-transfer-subject-details",sender:"receiver-transfer-sender-details"}});n.on("menuclick",function(){f.setType("menu")});var l=new iNet.ui.itemview({id:"receiver-additional",resource:e,url:j,toolbar:function(){this.id="receiver-additional-toolbar";this.intComponent=function(){this.$briefcaseBtn=$("#receiver-additional-briefcase-btn");this.$transferBtn=$("#receiver-additional-transfer-btn");this.$sendBtn=$("#receiver-additional-send-btn");this.$addBtn=$("#receiver-additional-add-btn");
this.$briefcaseBtn.on("click",function(){o("item")});this.$transferBtn.on("click",function(){o("transfer")});this.$sendBtn.on("click",function(){var a=(k.getData().pkgdata||{}).uuid||"",d=l.dataContent.$dataFieldName||"",b=l.dataContent.$dataBrief||"";if(!iNet.isEmpty(a)&&!iNet.isEmpty(d)){var c={"package":a,brief:l.dataContent.$brief.val()},g=b.split(",");$.each(d.split(","),function(h,m){iNet.isEmpty(m||"")||(c[m]=g[h]||"")});$.postJSON(j.additional_submit,c,function(h){console.log("additional_submit result >>",
h);CommonService.isSuccess(h)?i.notifySuccess(e.constant.submit_title,e.constant.submit_success):i.notifyError(e.constant.submit_title,i.getNotifyContent(e.constant.submit_error,h.errors||[]))},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})}});this.$addBtn.on("click",function(){l.dataContent.$grid.newRecord({brief:""})})}},dataContent:function(){this.id="receiver-additional-data-content";this.intComponent=function(){var a=this;this.$dataBrief=this.$dataFieldName="";this.$brief=$("#receiver-additional-brief-info-txt");
var d=new DataSource({columns:[{align:"center",type:"selection",width:30},{property:"brief",label:e.task.brief,sortable:true,type:"text"},{label:"",type:"action",separate:"&nbsp;",align:"center",buttons:[{text:iNet.resources.message.button.edit,icon:"icon-pencil",labelCls:"label label-info",fn:function(b){a.$grid.edit(b[a.$grid.getIdProperty()])}}]}],delay:250});this.$grid=new iNet.ui.grid.Grid({id:"receiver-additional-grid",url:j.additional_view,params:{},convertData:function(b){var c=b||{};if(iNet.isEmpty(c.brief))c.brief=
c.fieldName;a.procedureID=c.procedureID;return c.items},dataSource:d,stretchHeight:false,editable:false,firstLoad:false,idProperty:"uuid"});this.$grid.on("selectionchange",function(b){b=b.getSelection();for(var c=b.length,g=[],h=[],m=0;m<c;m++){var s=b[m];if(!iNet.isEmpty(s.fieldName||"")){g.push(s.fieldName);h.push(s.brief)}}if(g.length>0){l.toolbar.$sendBtn.show();a.$dataFieldName=g.join(iNet.splitChar);a.$dataBrief=h.join(iNet.splitChar)}else{l.toolbar.$sendBtn.hide();a.$dataFieldName="";a.$dataBrief=
""}});this.$grid.on("loaded",function(){l.toolbar.$sendBtn.hide()});this.$grid.on("save",function(b){var c=b||{},g=f.getData()||{},h=((g||{}).requestData||{}).procedureID||"";if(!(iNet.isEmpty(c.brief)||iNet.isEmpty(h))){c.fieldName="file"+iNet.generateId().substring(0,6);c.procedureID=h;$.postJSON(j.additional_create,c,function(m){var s=m||{};if(CommonService.isSuccess(s)){a.$grid.insert(s);i.notifySuccess(e.constant.save_title,e.constant.save_success)}else i.notifyError(e.constant.save_title,i.getNotifyContent(e.constant.save_error,
s.errors||[]))})}});this.$grid.on("update",function(b,c){var g=c||{};g.brief=b.brief||"";a.$grid.update(g);a.$grid.commit()})}},ajaxMaskId:"ajax-mask",headerDetails:{subject:"receiver-additional-subject-details",sender:"receiver-additional-sender-details"}});l.on("menuclick",function(){f.setType("menu")});var B=function(){p.reset();p.setDataContent("view");var a=f.getData()||{};p.dataContent.$files.html("");p.dataContent.$note.text(a.note||"");if((a.files||[]).length>0){var d="";$(a.files||[]).each(function(b,
c){var g=c.contentID||c.gridfsUUID||"",h=c.file||c.filename||"";h=c.file||c.filename||"";var m=(new Date(c.created)).format("H:i d/m/Y");if(d!=m){p.dataContent.$files.append('<div style="padding: 5px;"><div style="border: 1px solid #DDD;border-radius:10px;padding: 5px;background-color: #B98F43;color: #FFF;">'+m+"</div></div>");d=m}iNet.isEmpty(g)||p.dataContent.$files.append('<div style="padding: 5px;padding-left:30px;"><a style="padding: 5px;" href="'+j.downloadFile+"?role=processor&binary="+g+'">'+
(b+1)+'. <i class="'+iNet.FileFormat.getFileIcon(h)+'"></i> '+h+" - "+iNet.FileFormat.getSize(c.size||0)+' <i class="icon-download"></i></a></div>')})}},p=new iNet.ui.itemview({id:"receiver-refuse",resource:e,url:j,toolbar:function(){this.id="receiver-refuse-toolbar";this.intComponent=function(){this.$briefcaseBtn=$("#receiver-refuse-briefcase-btn");this.$briefcaseBtn.on("click",function(){o("item")})}},dataContent:function(){this.id="receiver-refuse-data-content";this.intComponent=function(){this.$files=
$("#receiver-refuse-file-list");this.$note=$("#receiver-refuse-note")}},ajaxMaskId:"ajax-mask",headerDetails:{subject:"receiver-refuse-subject-details",sender:"receiver-refuse-sender-details"}}),v=function(){u.refresh("receiver");f.refresh()};iNet.ui.task.TReceiver.superclass.constructor.call(this)};iNet.extend(iNet.ui.task.TReceiver,iNet.ui.app.widget);(new iNet.ui.task.TReceiver).show()});