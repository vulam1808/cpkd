$(function(){iNet.ns("iNet.ui.builder","iNet.ui.builder.TPage");iNet.ui.builder.TPage=function(){function E(){$(".demo").delegate(".remove","click",function(a){a.preventDefault();$(this).parent().remove();!$(".demo .lyrow").length>0&&$(".demo").empty()});$(".demo").delegate(".configuration","click",function(a){a.preventDefault();b.ctrlSelected=$($(this).parent().find(".view").children());a=b.ctrlSelected;var c=b.accordionAttribute;console.log(">> initProperty >>",a,a.find("target").length);PropertyService.RenderPropertyTarget(a,
c);$(".property-nav").addClass("show");$(".demo").addClass("properties")});$(".demo").delegate("[data-control]","dragstop",function(a){a.preventDefault();console.log(">> dragstop >>",a)});$(".lyrow .preview input").bind("keyup",function(){var a=0,c="",d=false,g=$(this).val().split(" ",12);$.each(g,function(i,k){if(!d){if(parseInt(k)<=0)d=true;a+=parseInt(k);c+='<div class="span'+k+' column"></div>'}});if(a==12&&!d){$(this).parent().next().children().html(c);$(this).parent().prev().show()}else $(this).parent().prev().hide()})}
function y(a){iNet.isEmpty(a)||b.design.find('[data-control="'+a+'"]').each(function(){var c=$(this),d=c.find("[data-design]");RenderService.DesignData(d);c=c.find("[data-content]");RenderService.DesignContent(c)})}function m(a,c,d){if(iNet.isEmpty(a)&&iNet.isEmpty(c)&&iNet.isEmpty(d)){if(b.bootstrapV3.prop("checked")){m(".row-fluid","row");for(a=1;a<=12;a++){var g=".span"+a,i="col-md-"+a+" col-xs-"+a+" col-sm-"+a;m(g,i)}m(".icon-calendar","ace-icon icon-calendar");m('[class="ace-file-input"] label[data-title]',
"ace-file-container file-label");m('[class="ace-file-input"] span[data-title]',"ace-file-name file-name");m('[class="ace-file-input"] span[data-title] i',"ace-icon")}}else{b.webContent.find(a).addClass(c).removeClass(d);b.mobileContent.find(a).addClass(c).removeClass(d)}}function F(a){var c=$("<div>").html(a);c.find(".mobile-control,[mobile-content],[data-design],[page-javascript-mobile-content]").remove();a=c.find(".view");for(var d=a.length-1;d>=0;d--){var g=a[d],i=g.children[0];i.classList.remove("clearfix");
g.parentNode.outerHTML=i.outerHTML}c.find("[web-content]").removeClass("hide");c.find(".ui-sortable").removeClass("column ui-sortable");b.webContent.html(c.html())}function G(a){var c=$("<div>").html(a),d={};c.find(".web-control,[data-design],[page-javascript-web-content],[page-javascript-content]").remove();c.find("[data-properties]").each(function(){H($(this),d)});a=c.find(".view");for(var g=a.length-1;g>=0;g--){var i=a[g];i.parentNode.outerHTML=i.children[0].innerHTML}c.find("[mobile-content]").each(function(){this.outerHTML=
this.innerHTML});c.find(".ui-sortable").removeClass("column ui-sortable");c.append('<script type="text/properties">'+JSON.stringify(d)+"<\/script>");b.mobileContent.html(c.html())}function H(a,c){var d={};a.find("properties").each(function(){d[this.getAttribute("rel")]=this.getAttribute("property-value")});c[d.name]=d;a.remove()}this.id="page-div";console.log(">>>> C,E,D,V >>>> ",roleCreate,roleEdit,roleDelete,roleView);var p=false,q=null,j={},n=null,e=this,r=null,t=null,f={page:iNet.resources.builder.page,
global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},h={CREATE:$("#page-create-btn"),DELETE:$("#page-delete-btn"),SAVE:$("#page-save-btn"),DESIGN:$("#page-design-btn"),PREVIEW:$("#page-preview-btn"),BACK:$("#page-back-btn"),PUBLISHED_XGATE:$("#page-published-xgate-btn"),PUBLISHED_EXPWAY:$("#page-published-expway-btn"),INFORMATION:$("#page-information-btn")};h.DELETE.hide();h.PUBLISHED_XGATE.hide();h.PUBLISHED_EXPWAY.hide();roleCreate||
roleEdit?h.SAVE.show():h.SAVE.hide();var o={view_info:iNet.getUrl("design/page/load"),create_info:iNet.getUrl("design/page/create"),update_info:iNet.getUrl("design/page/update"),del_info:iNet.getUrl("design/page/delete"),check_exists:iNet.getUrl("design/page/checkexists")},b={name:$("#page-name-txt"),brief:$("#page-brief-txt"),bootstrapV2:$("#page-bootstrap-v2-check"),bootstrapV3:$("#page-bootstrap-v3-check"),tool:$("#page-tool"),design:$("#page-design"),javascript:{WEB:$("#page-javascript-web"),
MOBILE:$("#page-javascript-mobile")},information:$("#page-information"),webContent:$("#page-web"),mobileContent:$("#page-mobile"),designBtn:$("#page-container-btn"),javascriptBtn:$("#page-javascript-btn"),javascriptContent:{WEB:$("#page-javascript-web-content"),MOBILE:$("#page-javascript-mobile-content")},javascriptHtml:{WEB:'<div style="display: none" page-javascript-web-content>{0}</div>',MOBILE:'<div style="display: none" page-javascript-mobile-content>{0}</div>'},javascriptEditor:{WEB:null,MOBILE:null},
accordionAttribute:$("#accAttribute"),ctrlSelected:null};b.javascriptEditor.WEB=CodeMirror.fromTextArea(document.getElementById("page-javascript-web-content"),{mode:"javascript",theme:"eclipse",lineNumbers:true,extraKeys:{"Ctrl-Space":"autocomplete"},matchBrackets:true,indentUnit:2,indentWithTabs:true,enterMode:"keep",tabMode:"shift",tabSize:2});b.javascriptEditor.MOBILE=CodeMirror.fromTextArea(document.getElementById("page-javascript-mobile-content"),{mode:"javascript",theme:"eclipse",lineNumbers:true,
extraKeys:{"Ctrl-Space":"autocomplete"},matchBrackets:true,indentUnit:2,indentWithTabs:true,enterMode:"keep",tabMode:"shift",tabSize:2});b.designBtn.on("click",function(){b.design.show();b.design.removeClass("hide");b.javascript.WEB.hide();b.javascript.MOBILE.hide();s()});b.javascriptBtn.on("click",function(){b.design.hide();b.design.addClass("hide");if($("#page-design-mode-btn").prop("checked")){b.javascript.WEB.show();b.javascript.MOBILE.hide()}else{b.javascript.MOBILE.show();b.javascript.WEB.hide()}s()});
var u=this.confirmDialog(iNet.resources.message.dialog_confirm_title,e.getNotifyContent(f.constant.del_content,t),function(){if(!iNet.isEmpty(r)){u.hide();$.postJSON(o.del_info,{page:r},function(a){var c=a||{};if(CommonService.isSuccess(c)){p=true;r=null;e.notifySuccess(f.constant.del_title,f.constant.del_success);z()}else e.notifyError(f.constant.del_title,e.getNotifyContent(f.constant.del_error,c.errors||[]))},{mask:e.getMask(),msg:iNet.resources.ajaxLoading.deleting})}});this.loadData=function(a){b.bootstrapV2.prop("checked",
true);b.bootstrapV3.prop("checked",true);if(a!=null){j=a;A(j)}else v()};this.setPageBack=function(a){q=a;q==null&&h.BACK.hide()};this.createPage=function(a){$.postJSON(o.check_exists,{name:a},function(c){var d=c||{};if(CommonService.isSuccess(d))iNet.isEmpty(d.uuid)?$.postJSON(o.create_info,{name:a},function(g){var i=g||{};CommonService.isSuccess(i)?e.loadData(i):e.notifyError(f.constant.del_title,e.getNotifyContent(f.constant.del_error,i.errors||[]))},{mask:e.getMask(),msg:iNet.resources.ajaxLoading.loading}):
e.loadData(d);else e.notifyError(f.constant.del_title,e.getNotifyContent(f.constant.del_error,d.errors||[]))},{mask:e.getMask(),msg:iNet.resources.ajaxLoading.loading})};var I=function(){$(".demo, .demo .column").sortable({connectWith:".column",opacity:0.35,handle:".drag"});$(".sidebar-nav .lyrow").draggable({connectToSortable:".demo",helper:"clone",handle:".drag",drag:function(a,c){c.helper.width(400)},stop:function(a){$(".demo .column").sortable({opacity:0.35,connectWith:".column"});y($(a.target).find("[data-control]:first").attr("data-control"))}});
$(".sidebar-nav .box").draggable({connectToSortable:".column",helper:"clone",handle:".drag",drag:function(a,c){c.helper.width(400)},stop:function(a){y($(a.target).find("[data-control]:first").attr("data-control"))}});$(".sidebar-nav .boxes, .sidebar-nav .rows").hide();$(".property-nav .csss, .property-nav .javascripts").hide();$(".sidebar-nav .nav-header").click(function(){$(".sidebar-nav .boxes, .sidebar-nav .rows").hide();$(this).next().slideDown()});$(".property-nav .nav-header").click(function(){$(".property-nav .attrs, .property-nav .csss, .property-nav .javascripts").hide();
$(this).next().slideDown()});$(".sidebar-nav, .container-dsn").on("click",function(a){$(a.target).attr("data-configuration")||B()});B();E();s();$(".demo .lyrow.ui-draggable").each(function(a,c){!$(c).hasClass("web-control")&&!$(c).hasClass("mobile-control")&&$(c).addClass("web-control")})},B=function(){$(".property-nav").removeClass("show");$(".demo").removeClass("properties")},s=function(){$(".demo").css("min-height",$(window).height()-76);b.javascriptEditor.WEB!=null&&b.javascriptEditor.WEB.setSize("100%",
b.design.height()-15);b.javascriptEditor.MOBILE!=null&&b.javascriptEditor.MOBILE.setSize("100%",b.design.height()-15)},C=function(){if($("#page-design-mode-btn").prop("checked")){$("#"+e.id).find(".wg-content").removeClass("mobile-mode").addClass("web-mode");$("#page-design-mode-btn").attr("title",f.page.webMode)}else{$("#"+e.id).find(".wg-content").removeClass("web-mode").addClass("mobile-mode");$("#page-design-mode-btn").attr("title",f.page.mobileMode)}b.design.hasClass("hide")?b.javascriptBtn.trigger("click"):
b.designBtn.trigger("click")},v=function(){j={};A(j);h.DELETE.hide()},A=function(a){$("#page-design-mode-btn").prop("checked",true);C();b.designBtn.trigger("click");var c=a||{};b.name.val(c.name||"");b.design.html(c.design||"");var d=b.design.find("[page-javascript-web-content]").text()||"";b.javascriptContent.WEB.val(d);b.javascriptEditor.WEB!=null&&b.javascriptEditor.WEB.setValue(d);var g=b.design.find("[page-javascript-mobile-content]").text()||"";b.javascriptContent.MOBILE.val(g);b.javascriptEditor.MOBILE!=
null&&b.javascriptEditor.MOBILE.setValue(g);console.log(">> setData >>",{data:c,javascript:{web:d,mobile:g}});roleDelete&&h.DELETE.show();I()},J=function(){if(b.javascriptEditor.WEB!=null){b.design.find("[page-javascript-web-content]").remove();b.design.append(String.format(b.javascriptHtml.WEB,b.javascriptEditor.WEB.getValue()))}if(b.javascriptEditor.MOBILE!=null){b.design.find("[page-javascript-mobile-content]").remove();b.design.append(String.format(b.javascriptHtml.MOBILE,b.javascriptEditor.MOBILE.getValue()))}F(b.design.html());
G(b.design.html());m();var a=b.webContent.html();a+=PublicService.iNetScript(b.webContent);var c=PublicService.MobileScript(b.mobileContent),d=true;b.webContent.find("[name]").each(function(i,k){if(iNet.isEmpty($(k).attr("name")||""))return d=false});if(d){var g={templateID:"",design:b.design.html(),content:a,mcontent:c};return g=iNet.apply(j,g)||{}}else return null},x=function(a,c){var d=iNet.isFunction(a)?a.createDelegate(this):iNet.emptyFn,g=iNet.isEmpty(c)?true:c,i=J(),k;if(iNet.isEmpty(i)){e.notifyError(f.constant.warning_title,
String.format(f.constant.warning_error,String.format(f.validate.is_not_blank,f.page.propertyName)));k=false}else k=true;if(k){console.log("onSave",i);i.uuid==null?$.postJSON(o.create_info,i,function(w){var l=w||{};console.log("create_info",l);if(CommonService.isSuccess(l)){p=true;roleDelete&&h.DELETE.show();j=l;d(j);g&&e.notifySuccess(f.constant.save_title,f.constant.save_success)}else e.notifyError(f.constant.save_title,e.getNotifyContent(f.constant.save_error,l.errors||[]))}):$.postJSON(o.update_info,
i,function(w){var l=w||{};console.log("update_info",l);if(CommonService.isSuccess(l)){p=true;j=l;d(j);g&&e.notifySuccess(f.constant.save_title,f.constant.save_success)}else e.notifyError(f.constant.save_title,e.getNotifyContent(f.constant.save_error,l.errors||[]))})}},D=function(a){if(n==null)n=new iNet.ui.admin.Published;n.on("back",function(){n.hide();e.show()});n.setData({published:a,type:"page",uuid:j.uuid||"",name:j.name});n.show();e.hide()},z=function(){if(q!=null){e.hide();q.show();p&&this.fireEvent("finish")}else v()}.createDelegate(this);
h.INFORMATION.on("click",function(){b.information.hasClass("hide")?b.information.removeClass("hide"):b.information.addClass("hide")});h.PUBLISHED_XGATE.on("click",function(){x(D("xgate"),false)});h.PUBLISHED_EXPWAY.on("click",function(){x(D("expway"),false)});h.DESIGN.on("click",function(){$("#page-container").removeClass("devpreview sourcepreview");$("#page-container").addClass("edit");h.PREVIEW.show();h.DESIGN.hide()});h.PREVIEW.on("click",function(){$("#page-container").removeClass("edit");$("#page-container").addClass("devpreview sourcepreview");
h.PREVIEW.hide();h.DESIGN.show()});h.CREATE.on("click",function(){v();b.name.focus()});h.DELETE.on("click",function(){r=j.uuid;t=j.name;u.setContent(String.format(f.constant.del_content,t));u.show()});h.SAVE.on("click",x);h.BACK.on("click",z);$("#page-design-mode-btn").on("change",function(){C()});$(window).resize(function(){s()});iNet.ui.builder.TPage.superclass.constructor.call(this)};iNet.extend(iNet.ui.builder.TPage,iNet.ui.app.widget)});