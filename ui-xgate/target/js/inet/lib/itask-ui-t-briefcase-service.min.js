$(function(){iNet.ns("iNet.ui.task","iNet.ui.task.TBriefcase");iNet.ui.task.TBriefcase=function(H){this.id="briefcase-div";var i=this,w={itemsSelected:[]},q=H||{},g={isBack:false,briefcaseStatus:typeof briefcaseStatus=="undefined"?"":briefcaseStatus,recordID:typeof recordID=="undefined"?"":recordID,keyword:typeof keyword=="undefined"?"":keyword,pageParent:typeof pageParent=="undefined"?"":pageParent,pageUrl:typeof pageUrl=="undefined"?"":pageUrl,context:iNet.context,zone:iNet.zone};if(!iNet.isEmpty((iNet.getLayout()||
{}).parentParams||{})){iNet.apply(q,(iNet.getLayout()||{}).parentParams||{});iNet.getLayout().parentParams={}}if(!iNet.isEmpty(q)){g.recordID=q.recordID;g.briefcaseStatus=q.briefcaseStatus;g.keyword=q.keyword;g.pageParent=q.pageParent;g.pageUrl=q.pageUrl;g.isBack=true}if(!iNet.isEmpty(g.pageParent)||!iNet.isEmpty(g.pageUrl)||!iNet.isEmpty(g.recordID))g.isBack=true;console.log(">>ctx>>",g);var f={completed:iNet.resources.receiver.completed,processor:iNet.resources.receiver.processor,global:iNet.resources.global,
errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},o={task_search:iNet.getUrl("onegate/deptrecord/search"),update_request:iNet.getUrl("onegate/deptrecord/update"),get_request_view:iNet.getUrl("onegate/deptrecord/load"),get_record_view:iNet.getUrl("onegate/deptrecord/view"),get_request_history:iNet.getUrl("firmtask/process/history"),submit_result:iNet.getUrl("onegate/resultupload"),signverify:iNet.getUrl("onegate/externaldata/signverify"),readComment:iNet.getUrl("firmtask/comment/read"),
downloadFile:iNet.getUrl("onegate/binary/download"),avatarUser:iNet.getUrl("system/userprofile/photo"),loadGraphs:iNet.getUrl("onegate/deptgraphs/load"),generator:iNet.getUrl("onegate/excel/generator"),chkstatus:iNet.getUrl("report/file/chkstatus"),download:iNet.getUrl("report/file/download")},x=iNet.getLayout().taskMenu;x.on("menuchange",function(){});x.on("create",function(){I()});var s=null,I=function(){if(s==null)s=new iNet.ui.task.TRequest;s.on("finish",function(a){i.show();s.hide();iNet.isEmpty(a)||
y()});s.setData({});s.show();i.hide()},C=function(a){$.postJSON(o.chkstatus,{reportID:a},function(b){var c=b||0;if(c==2)window.location.href=o.download+"?reportID="+a;else c==1&&setTimeout(function(){C(a)},2E3)},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})},p=function(a){h.hide();l.hide();k.hide();if(a=="item"){h.show();J()}if(a=="workflow"){l.show();K()}if(a=="result"){k.show();L()}},z=function(){var a=d.getParams()||{};a.keyword=d.basicSearch.$keyword.val();a.receipt=d.advanceSearch.$receipt.val();
a.serial=d.advanceSearch.$serial.val();var b=d.advanceSearch.$warnHour.val()||0;if(b>0){a.type="overdue";a.warnHour=b}else{delete a.warnHour;delete a.type}d.setParams(a);d.load()},d=new iNet.ui.listview({id:"briefcase-list",uiItemId:"briefcase-list-item-ui",url:o.task_search,toolbar:function(){this.id="briefcase-list-toolbar";this.intComponent=function(){this.$excelBtn=$("#briefcase-list-excel-btn");this.$excelBtn.on("click",function(){var a=d.getParams()||{};a.records="";$(w.itemsSelected).each(function(b,
c){a.records+=c.key+","});$.postJSON(o.loadGraphs,{},function(b){var c=b||[];console.log(">>graphs>>",c,c.toString());a.graphs=c.toString();a.type="CheckList";$.postJSON(o.generator,a,function(m){var n=m||{};CommonService.isSuccess(n)?setTimeout(function(){C(n.uuid)},2E3):i.notifyError(f.constant.submit_title,i.getNotifyContent(f.constant.submit_error,n.errors||[]))},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})})}.createDelegate(this))}},basicSearch:function(){this.id="briefcase-list-basic-search";
this.intComponent=function(){var a=$("#briefcase-list-basic-search-expand-btn"),b=$("#briefcase-list-basic-search-search-btn");this.$keyword=$("#briefcase-list-basic-search-txt-keyword");this.$keyword.val(g.keyword||"");this.$keyword.on("keyup",function(c){if(c.which==13){d.advanceSearch.hide();z()}});b.on("click",function(){d.advanceSearch.hide();z()});a.on("click",function(){d.advanceSearch.show()})}},advanceSearch:function(){this.id="briefcase-list-advance-search";this.intComponent=function(){var a=
$("#briefcase-list-advance-search-search-btn"),b=$("#briefcase-list-advance-search-close-btn");this.$receipt=$("#briefcase-list-advance-search-receipt-txt");this.$serial=$("#briefcase-list-advance-search-serial-txt");this.$warnHour=$("#briefcase-list-advance-search-warnHour-txt");a.on("click",function(){d.advanceSearch.hide();var c=d.getParams()||{};z()});b.on("click",function(){d.advanceSearch.hide()})}},pullLeft:function(){this.id="briefcase-list-pull-left";this.intComponent=function(){}},params:{pageSize:20,
pageNumber:0,status:g.briefcaseStatus,keyword:g.keyword,recordID:g.recordID},convertData:function(a){var b=a||{};d.setTotal(b.total);$.each(b.items||[],function(c,m){d.addItem(m)})}});d.on("indexchange",function(a){!iNet.isEmpty(a.uuid)&&g.briefcaseStatus=="PUBLISHED"?p("result"):p("item")});d.on("typechange",function(a){if(a=="max"){h.setType("min");l.setType("min");k.setType("min")}else{h.setType("full");l.setType("full");k.setType("full")}});d.on("itemselected",function(a){w.itemsSelected=a||[];
console.log(">>selfData.itemsSelected>>",w.itemsSelected)});var D=new iNet.ui.fileview;D.setPageBack(i);var E=new iNet.ui.signature;E.setPageBack(i);var J=function(){h.reset();h.toolbar.$updateBtn.hide();var a=d.getData()||{};iNet.isEmpty(a.uuid)||$.postJSON(o.get_request_view,{request:a.requestID},function(b){var c=b||{};h.setData(c);console.log("view_request result >>",c);if((c.request||{}).status=="UPDATE")h.toolbar.$updateBtn.show();var m={subject:a.subject||"",showAttachmentIcon:false,showCommentIcon:false,
showDetailsIcon:false},n={name:a.creatorName,date:" ("+$.timeago(a.created)+")",showDetailsIcon:false};h.setHeader({subject:m,sender:n,object:c});h.setSubmitContent(c.content);var r=(c.request||{}).comments||[],t=(c.request||{}).attachments||[],j=(c.request||{}).externalData||[];$.postJSON(o.get_record_view,{request:a.requestID},function(e){var u=e||{},v=(u.record||{}).documents||[];h.setFooter({comments:r,attBriefs:t,attExternalData:j,docRecord:v})},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})},
{mask:i.getMask(),msg:iNet.resources.ajaxLoading.loading})},h=new iNet.ui.itemview({id:"briefcase-view",resource:f,url:o,toolbar:function(){this.id="briefcase-view-toolbar";this.intComponent=function(){this.$workflowBtn=$("#briefcase-view-workflow-btn");this.$resultBtn=$("#briefcase-view-result-btn");this.$printBtn=$("#briefcase-view-print-btn");this.$updateBtn=$("#briefcase-view-update-btn");this.$backBtn=$("#briefcase-view-back-btn");this.$workflowBtn.on("click",function(){p("workflow")});this.$resultBtn.on("click",
function(){p("result")});this.$updateBtn.on("click",function(){var a=d.getData()||{};h.resetBodyHidden();h.addBodyHidden("request",a.requestID);var b=o.update_request,c=!iNet.isFunction(((iNet||{}).requestData||{}).messageValidate)?"":((iNet||{}).requestData||{}).messageValidate();console.log(">> submitRequest validate >>",{messageValidate:c});var m=b||"";iNet.isEmpty(c)&&!iNet.isEmpty(m)?h.submit(m):i.notifyError(f.constant.warning_title,c)});this.$printBtn.on("click",function(){var a=(d.getData()||
{}).requestID||"";iNet.isEmpty(a)||window.open(iNet.getUrl(CommonService.pageRequest.formNo03)+"?task="+a,"_blank")});this.$backBtn.on("click",function(){if(iNet.isEmpty(g.pageUrl)){if(!iNet.isEmpty(g.pageParent)){i.hide();g.pageParent.show()}}else{var a=iNet.getUrl(CommonService.pageRequest.xgate)+CommonService.pageRequest.hashtag[g.pageUrl];iNet.getLayout().window.location.href=a}i.fireEvent("back")}.createDelegate(this))}},ajaxMaskId:"ajax-mask",headerDetails:{subject:"briefcase-view-subject-details",
sender:"briefcase-view-sender-details"}});h.on("submitted",function(a){var b=a||{};if(b.type=="error")i.notifyError(f.constant.submit_title,i.getNotifyContent(f.constant.submit_error,b.errors||[]));else{i.notifySuccess(f.constant.submit_title,f.constant.submit_success);g.isBack?h.$backBtn.trigger("click"):y()}});h.on("headerchange",function(a){console.log(">>headerchange>>",a)});h.on("menuclick",function(){d.setType("menu")});h.on("fileclick",function(a){var b=a||{};if(!iNet.isEmpty(b.uuid)){if(b.action==
"viewfile"){D.viewFile(b.uuid);i.hide()}b.action=="downfile"&&window.open(o.downloadFile+"?binary="+b.uuid,"_blank");b.action=="verifyfile"&&E.viewVerify(b.uuid)}});h.on("viewcomment",function(){var a=((h.getData()||{}).request||{}).uuid||"";$.postJSON(o.readComment,{task:a,graph:__graphID},function(b){var c=b||{};CommonService.isSuccess(c)&&console.log("readComment>>",c)},{mask:i.getMask(),msg:iNet.resources.ajaxLoading.processing})});var K=function(){l.reset();var a=(d.getData()||{}).graphID||"",
b=(d.getData()||{}).requestID||"";if(!(iNet.isEmpty(a)||iNet.isEmpty(b))){var c={uuid:a,zone:g.zone,context:g.context,version:"VIEW"},m=[];$.postJSON(o.get_request_history,{request:b},function(n){var r=n||{};if(CommonService.isSuccess(r))$.each(r.items||[],function(t,j){var e={},u="orange",v="orange",F=f.processor.infoTaskCompleted,G=f.processor.taskAlterInprocess,A=f.processor.infoTaskTimeNoLimit;if(j.completedTime==0){v=u="blue";F=f.processor.infoTaskProcessing}var B=j.completedTime||(new Date).getTime();
console.log(">>get_request_history>>",B,j.expiredTask,B>j.expiredTask);if(B>j.expiredTask)G=f.processor.taskAlterOverdue;if(j.timeProcess>0){A=j.timeProcess+" ";A+=j.timeUnit==0?f.processor.infoTaskTimeMinutes:j.timeUnit==1?f.processor.infoTaskTimeHours:f.processor.infoTaskTimeDay}e=iNet.apply(e,j);e.nodeColor=u;e.statusColor=v;e.nodeHtmlContent="";e.nodeHtmlContent+="<b>+ "+f.processor.infoTo+"</b>";e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<b>"+f.processor.infoToUser+": </b>"+j.senderName;
e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<b>"+f.processor.infoToDate+": </b>"+(new Date(j.created)).format("H:i d/m/Y");e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<b>+ "+f.processor.infoProcess+"</b>";e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<b>"+f.processor.infoProcessUser+": </b>"+(j.processorName||"");e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<b>"+f.processor.infoProcessDate+": </b>";e.nodeHtmlContent+=j.completedTime>0?(new Date(j.completedTime)).format("H:i d/m/Y"):
"";e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<b>+ "+f.processor.infoTask+"</b>";e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<b>"+f.processor.infoTaskStatus+": </b>";e.nodeHtmlContent+=F;e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<b>"+f.processor.infoTaskTime+": </b>";e.nodeHtmlContent+=A;e.nodeHtmlContent+="<br/>";e.nodeHtmlContent+="<b>"+f.processor.infoTaskAlter+": </b>";e.nodeHtmlContent+=G;e.nodeTitle="";e.nodeName=j.taskName;m.push(e)});console.log(">>workflowView.dataContent>>",
l.dataContent);l.dataContent.$wfDesign.loadGraph(c,m);l.dataContent.$wfDesign.show();l.setDataContent("view")})}},l=new iNet.ui.itemview({id:"briefcase-workflow",resource:f,url:o,toolbar:function(){this.id="briefcase-workflow-toolbar";this.intComponent=function(){this.$briefcaseBtn=$("#briefcase-workflow-briefcase-btn");this.$resultBtn=$("#briefcase-workflow-result-btn");this.$printBtn=$("#briefcase-workflow-print-btn");this.$backBtn=$("#briefcase-workflow-back-btn");this.$briefcaseBtn.on("click",
function(){p("item")});this.$resultBtn.on("click",function(){p("result")});this.$printBtn.on("click",function(){var a=(d.getData()||{}).requestID||"";iNet.isEmpty(a)||window.open(iNet.getUrl(CommonService.pageRequest.formNo03)+"?task="+a,"_blank")});this.$backBtn.on("click",function(){i.fireEvent("back")}.createDelegate(this))}},dataContent:function(){this.id="briefcase-workflow-data-content";this.intComponent=function(){this.$wfDesign=new iNet.ui.workflow.Workflow({id:"briefcase-workflow-data-content-view",
context:g.context})}},ajaxMaskId:"ajax-mask",headerDetails:{subject:"briefcase-workflow-subject-details",sender:"briefcase-workflow-sender-details"}});l.on("menuclick",function(){d.setType("menu")});var L=function(){var a=d.getData()||{};a.replyFor?k.formContent.$reply.show():k.formContent.$reply.hide();k.formContent.$organ.text("");k.formContent.$notes.val("");k.formContent.$listAttachment.html("");var b=k.formContent.$oldAttachment.find("#briefcase-result-form-attachment-list-old");b.html("");if((a.attachments||
[]).length>0){k.formContent.$oldAttachment.show();var c="";$(a.attachments||[]).each(function(m,n){var r=n.contentID||n.gridfsUUID||"",t=n.file||n.filename||"";t=n.file||n.filename||"";var j=(n.brief||"")+" - "+(new Date(n.created)).format("H:i d/m/Y");if(c!=j){b.append('<div style="padding: 5px;"><div style="border: 1px solid #DDD;border-radius:10px;padding: 5px;background-color: #B98F43;color: #FFF;">'+j+"</div></div>");c=j}iNet.isEmpty(r)||b.append('<div style="padding: 5px;padding-left:30px;"><a style="padding: 5px;" href="'+
o.downloadFile+"?role=receiver&binary="+r+'">'+(m+1)+'. <i class="'+iNet.FileFormat.getFileIcon(t)+'"></i> '+t+" - "+iNet.FileFormat.getSize(n.size||0)+' <i class="icon-download"></i></a></div>')})}else k.formContent.$oldAttachment.hide();k.setFormContent("view")},k=new iNet.ui.itemview({id:"briefcase-result",resource:f,url:o,toolbar:function(){this.id="briefcase-result-toolbar";this.intComponent=function(){this.$briefcaseBtn=$("#briefcase-result-briefcase-btn");this.$workflowBtn=$("#briefcase-result-workflow-btn");
this.$printBtn=$("#briefcase-result-print-btn");this.$submitBtn=$("#briefcase-result-submit-btn");this.$backBtn=$("#briefcase-result-back-btn");this.$briefcaseBtn.on("click",function(){p("item")});this.$workflowBtn.on("click",function(){p("workflow")});this.$printBtn.on("click",function(){var a=(d.getData()||{}).requestID||"";iNet.isEmpty(a)||window.open(iNet.getUrl(CommonService.pageRequest.formNo03)+"?task="+a,"_blank")});this.$submitBtn.on("click",function(){var a=d.getData()||{};k.resetBodyHidden();
k.addBodyHidden("record",a.uuid);k.submit(o.submit_result)});this.$backBtn.on("click",function(){i.fireEvent("back")}.createDelegate(this))}},formContent:function(){this.id="briefcase-result-form-content";this.intComponent=function(){var a=this;this.$notes=$("#briefcase-result-form-notes");this.$organ=$("#briefcase-result-form-organ");this.$reply=$("#briefcase-result-form-reply");this.$oldAttachment=$("#briefcase-result-form-attachment-old");this.$listAttachment=$("#briefcase-result-form-attachment-list");
this.$addAttachment=$("#briefcase-result-form-attachment-add");this.$oldAttachment.find("div:first").on("click",function(){a.$oldAttachment.find("div:last").hasClass("hide")?a.$oldAttachment.find("div:last").removeClass("hide"):a.$oldAttachment.find("div:last").addClass("hide")});this.$addAttachment.on("click",function(){var b="";b+='<div class="row-fluid">';b+='    <label class="span2">'+f.completed.attachmentFile+"</label>";b+='    <div class="ace-file-input span10" data-container data-name="{0}">';
b+='         <label data-name="{0}" data-title="Click here" class="ace-file-container file-label">';b+='             <span data-title="..." class="ace-file-name file-name"><i class="icon-upload-alt ace-icon"></i></span>';b+="         </label>";b+='         <a data-remove data-name="{0}" class="remove" href="#"><i class=" ace-icon fa fa-times"></i></a>';b+="    </div>";b+='    <input type="file" name="{0}" style="display:none;" data-file data-name="{0}"/>';b+="</div>";var c=iNet.generateId();a.$listAttachment.append(String.format(b,
c));a.$listAttachment.find('[data-file][data-name="'+c+'"]').on("change",function(){if(this.files.length<1)this.files=[];else{var m=this.files[0].name;$(this).parent().find("span[data-title]").attr("data-title",m);$(this).parent().find(".ace-file-container").addClass("selected")}});a.$listAttachment.find('[data-remove][data-name="'+c+'"]').on("click",function(){$(this).parent().parent().remove()});a.$listAttachment.find('[data-container][data-name="'+c+'"] label').on("click",function(){var m=$(this).attr("data-name");
a.$listAttachment.find('[data-file][data-name="'+m+'"]').trigger("click")});a.$listAttachment.find('[data-file][data-name="'+c+'"]').trigger("click")});this.$reply.on("change",function(){a.$reply.find('[name="reply"]').attr("value",a.$reply.find('[name="reply"]').prop("checked"))})}},ajaxMaskId:"ajax-mask",headerDetails:{subject:"briefcase-result-subject-details",sender:"briefcase-result-sender-details"}});k.on("menuclick",function(){d.setType("menu")});k.on("submitted",function(a){var b=a||{};if(b.type==
"error")i.notifyError(f.constant.submit_title,i.getNotifyContent(f.constant.submit_error,b.errors||[]));else{i.notifySuccess(f.constant.submit_title,f.constant.submit_success);y()}});this.setData=function(a){var b=a||{},c=d.getParams()||{};c.recordID=b.recordID||"";d.setParams(c);d.refresh();l.toolbar.$backBtn.show();k.toolbar.$backBtn.show();g.isBack=true;h.toolbar.$backBtn.show();if(b.briefcaseStatus=="INPROCESS"){l.toolbar.$resultBtn.hide();h.toolbar.$resultBtn.hide()}else{l.toolbar.$resultBtn.show();
h.toolbar.$resultBtn.show()}};var y=function(){x.refresh("process");d.refresh();if(g.briefcaseStatus=="INPROCESS"){l.toolbar.$resultBtn.hide();h.toolbar.$resultBtn.hide()}else{l.toolbar.$resultBtn.show();h.toolbar.$resultBtn.show()}};d.setType("max");if(g.briefcaseStatus=="INPROCESS"){l.toolbar.$resultBtn.hide();h.toolbar.$resultBtn.hide()}if(g.briefcaseStatus!="INPROCESS"){l.toolbar.$printBtn.hide();h.toolbar.$printBtn.hide();k.toolbar.$printBtn.hide()}g.isBack&&h.toolbar.$backBtn.show();iNet.ui.task.TBriefcase.superclass.constructor.call(this)};
iNet.extend(iNet.ui.task.TBriefcase,iNet.ui.app.widget)});