(function(D){D.plot.plugins.push({init:function(p){function H(a){for(var b=0,i=0,k=0,j=d.series.pie.combine.color,h=[],c=0;c<a.length;++c){var g=a[c].data;if(D.isArray(g)&&g.length==1)g=g[0];if(D.isArray(g))g[1]=!isNaN(parseFloat(g[1]))&&isFinite(g[1])?+g[1]:0;else g=!isNaN(parseFloat(g))&&isFinite(g)?[1,+g]:[1,0];a[c].data=[g]}for(c=0;c<a.length;++c)b+=a[c].data[0][1];for(c=0;c<a.length;++c){g=a[c].data[0][1];if(g/b<=d.series.pie.combine.threshold){i+=g;k++;if(!j)j=a[c].color}}for(c=0;c<a.length;++c){g=
a[c].data[0][1];if(k<2||g/b>d.series.pie.combine.threshold)h.push(D.extend(a[c],{data:[[1,g]],color:a[c].color,label:a[c].label,angle:g*Math.PI*2/b,percent:g/(b/100)}))}k>1&&h.push({data:[[1,i]],color:j,label:d.series.pie.combine.label,angle:i*Math.PI*2/b,percent:i/(b/100)});return h}function N(a,b){function i(){e.clearRect(0,0,h,c);B.children().filter(".pieLabel, .pieLabelBackground").remove()}function k(){var f=d.series.pie.shadow.left,m=d.series.pie.shadow.top,n=d.series.pie.shadow.alpha,u=d.series.pie.radius>
1?d.series.pie.radius:s*d.series.pie.radius;if(!(u>=h/2-f||u*d.series.pie.tilt>=c/2-m||u<=10)){e.save();e.translate(f,m);e.globalAlpha=n;e.fillStyle="#000";e.translate(o,C);e.scale(1,d.series.pie.tilt);for(f=1;f<=10;f++){e.beginPath();e.arc(0,0,u,0,Math.PI*2,false);e.fill();u-=f}e.restore()}}function j(){function f(x,F,G){if(!(x<=0||isNaN(x))){if(G)e.fillStyle=F;else{e.strokeStyle=F;e.lineJoin="round"}e.beginPath();Math.abs(x-Math.PI*2)>1.0E-9&&e.moveTo(0,0);e.arc(0,0,u,q,q+x/2,false);e.arc(0,0,u,
q+x/2,q+x,false);e.closePath();q+=x;G?e.fill():e.stroke()}}function m(){function x(y,z,t){if(y.data[0][1]==0)return true;var v=d.legend.labelFormatter,r=d.series.pie.label.formatter;v=v?v(y.label,y):y.label;if(r)v=r(v,y);r=(z+y.angle+z)/2;z=o+Math.round(Math.cos(r)*G);r=C+Math.round(Math.sin(r)*G)*d.series.pie.tilt;B.append("<span class='pieLabel' id='pieLabel"+t+"' style='position:absolute;top:"+r+"px;left:"+z+"px;'>"+v+"</span>");t=B.children("#pieLabel"+t);v=r-t.height()/2;r=z-t.width()/2;t.css("top",
v);t.css("left",r);if(0-v>0||0-r>0||c-(v+t.height())<0||h-(r+t.width())<0)return false;if(d.series.pie.label.background.opacity!=0){z=d.series.pie.label.background.color;if(z==null)z=y.color;y="top:"+v+"px;left:"+r+"px;";D("<div class='pieLabelBackground' style='position:absolute;width:"+t.width()+"px;height:"+t.height()+"px;"+y+"background-color:"+z+";'></div>").css("opacity",d.series.pie.label.background.opacity).insertBefore(t)}return true}for(var F=n,G=d.series.pie.label.radius>1?d.series.pie.label.radius:
s*d.series.pie.label.radius,E=0;E<l.length;++E){if(l[E].percent>=d.series.pie.label.threshold*100)if(!x(l[E],F,E))return false;F+=l[E].angle}return true}var n=Math.PI*d.series.pie.startAngle,u=d.series.pie.radius>1?d.series.pie.radius:s*d.series.pie.radius;e.save();e.translate(o,C);e.scale(1,d.series.pie.tilt);e.save();for(var q=n,A=0;A<l.length;++A){l[A].startAngle=q;f(l[A].angle,l[A].color,true)}e.restore();if(d.series.pie.stroke.width>0){e.save();e.lineWidth=d.series.pie.stroke.width;q=n;for(A=
0;A<l.length;++A)f(l[A].angle,d.series.pie.stroke.color,false);e.restore()}J(e);e.restore();return d.series.pie.label.show?m():true}if(B){var h=a.getPlaceholder().width(),c=a.getPlaceholder().height(),g=B.children().filter(".legend").children().width()||0;e=b;I=false;s=Math.min(h,c/d.series.pie.tilt)/2;C=c/2+d.series.pie.offset.top;o=h/2;if(d.series.pie.offset.left=="auto"){if(d.legend.position.match("w"))o+=g/2;else o-=g/2;if(o<s)o=s;else if(o>h-s)o=h-s}else o+=d.series.pie.offset.left;var l=a.getData();
g=0;do{if(g>0)s*=0.95;g+=1;i();d.series.pie.tilt<=0.8&&k()}while(!j()&&g<10);if(g>=10){i();B.prepend("<div class='error'>Could not draw pie with labels contained inside canvas</div>")}if(a.setSeries&&a.insertLegend){a.setSeries(l);a.insertLegend()}}}function J(a){if(d.series.pie.innerRadius>0){a.save();var b=d.series.pie.innerRadius>1?d.series.pie.innerRadius:s*d.series.pie.innerRadius;a.globalCompositeOperation="destination-out";a.beginPath();a.fillStyle=d.series.pie.stroke.color;a.arc(0,0,b,0,Math.PI*
2,false);a.fill();a.closePath();a.restore();a.save();a.beginPath();a.strokeStyle=d.series.pie.stroke.color;a.arc(0,0,b,0,Math.PI*2,false);a.stroke();a.closePath();a.restore()}}function O(a){K("plothover",a)}function P(a){K("plotclick",a)}function K(a,b){var i=p.offset(),k=parseInt(b.pageX-i.left);a:{i=parseInt(b.pageY-i.top);var j=p.getData(),h=p.getOptions();h=h.series.pie.radius>1?h.series.pie.radius:s*h.series.pie.radius;for(var c,g,l=0;l<j.length;++l){var f=j[l];if(f.pie.show){e.save();e.beginPath();
e.moveTo(0,0);e.arc(0,0,h,f.startAngle,f.startAngle+f.angle/2,false);e.arc(0,0,h,f.startAngle+f.angle/2,f.startAngle+f.angle,false);e.closePath();c=k-o;g=i-C;if(e.isPointInPath){if(e.isPointInPath(k-o,i-C)){e.restore();k={datapoint:[f.percent,f.data],dataIndex:0,series:f,seriesIndex:l};break a}}else{var m=[[0,0],[h*Math.cos(f.startAngle),h*Math.sin(f.startAngle)],[h*Math.cos(f.startAngle+f.angle/4),h*Math.sin(f.startAngle+f.angle/4)],[h*Math.cos(f.startAngle+f.angle/2),h*Math.sin(f.startAngle+f.angle/
2)],[h*Math.cos(f.startAngle+f.angle/1.5),h*Math.sin(f.startAngle+f.angle/1.5)],[h*Math.cos(f.startAngle+f.angle),h*Math.sin(f.startAngle+f.angle)]];c=[c,g];g=false;for(var n=-1,u=m.length,q=u-1;++n<u;q=n)(m[n][1]<=c[1]&&c[1]<m[q][1]||m[q][1]<=c[1]&&c[1]<m[n][1])&&c[0]<(m[q][0]-m[n][0])*(c[1]-m[n][1])/(m[q][1]-m[n][1])+m[n][0]&&(g=!g);if(g){e.restore();k={datapoint:[f.percent,f.data],dataIndex:0,series:f,seriesIndex:l};break a}}e.restore()}}k=null}if(d.grid.autoHighlight)for(i=0;i<w.length;++i){j=
w[i];if(j.auto==a&&!(k&&j.series==k.series)){j=j.series;if(j==null){w=[];p.triggerRedrawOverlay()}j=L(j);if(j!=-1){w.splice(j,1);p.triggerRedrawOverlay()}}}if(k){i=k.series;j=L(i);if(j==-1){w.push({series:i,auto:a});p.triggerRedrawOverlay()}else if(!a)w[j].auto=false}B.trigger(a,[{pageX:b.pageX,pageY:b.pageY},k])}function L(a){for(var b=0;b<w.length;++b)if(w[b].series==a)return b;return-1}function Q(a,b){function i(c){if(!(c.angle<=0||isNaN(c.angle))){b.fillStyle="rgba(255, 255, 255, "+k.series.pie.highlight.opacity+
")";b.beginPath();Math.abs(c.angle-Math.PI*2)>1.0E-9&&b.moveTo(0,0);b.arc(0,0,j,c.startAngle,c.startAngle+c.angle/2,false);b.arc(0,0,j,c.startAngle+c.angle/2,c.startAngle+c.angle,false);b.closePath();b.fill()}}var k=a.getOptions(),j=k.series.pie.radius>1?k.series.pie.radius:s*k.series.pie.radius;b.save();b.translate(o,C);b.scale(1,k.series.pie.tilt);for(var h=0;h<w.length;++h)i(w[h].series);J(b);b.restore()}var M=null,B=null,d=null,s=null,o=null,C=null,I=false,e=null,w=[];p.hooks.processOptions.push(function(a,
b){if(b.series.pie.show){b.grid.show=false;if(b.series.pie.label.show=="auto")b.series.pie.label.show=b.legend.show?false:true;if(b.series.pie.radius=="auto")b.series.pie.radius=b.series.pie.label.show?0.75:1;if(b.series.pie.tilt>1)b.series.pie.tilt=1;else if(b.series.pie.tilt<0)b.series.pie.tilt=0}});p.hooks.bindEvents.push(function(a,b){var i=a.getOptions();if(i.series.pie.show){i.grid.hoverable&&b.unbind("mousemove").mousemove(O);i.grid.clickable&&b.unbind("click").click(P)}});p.hooks.processDatapoints.push(function(a){if(a.getOptions().series.pie.show)if(!I){I=
true;M=a.getCanvas();B=D(M).parent();d=a.getOptions();a.setData(H(a.getData()))}});p.hooks.drawOverlay.push(function(a,b){a.getOptions().series.pie.show&&Q(a,b)});p.hooks.draw.push(function(a,b){a.getOptions().series.pie.show&&N(a,b)})},options:{series:{pie:{show:false,radius:"auto",innerRadius:0,startAngle:1.5,tilt:1,shadow:{left:5,top:15,alpha:0.02},offset:{top:0,left:"auto"},stroke:{color:"#fff",width:1},label:{show:"auto",formatter:function(p,H){return"<div style='font-size:x-small;text-align:center;padding:2px;color:"+
H.color+";'>"+p+"<br/>"+Math.round(H.percent)+"%</div>"},radius:1,background:{color:null,opacity:0},threshold:0},combine:{threshold:-1,color:null,label:"Other"},highlight:{opacity:0.5}}}},name:"pie",version:"1.1"})})(jQuery);