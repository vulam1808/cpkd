$(function(){iNet.ns("iNet.ui.task","iNet.ui.task.TTask");iNet.ui.task.TTask=function(){this.id="task-div";var b=this;this.taskData={list:[],index:{}};var h={task:iNet.resources.task.task,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},m=iNet.getLayout().taskMenu;m.on("menuchange",function(){console.log(">>>$taskMenu menuchange >>")});m.on("create",function(){console.log(">>>$taskMenu create >>")});var j={task_open:iNet.getUrl("firmtask/process/openlist"),
urgent_update:iNet.getUrl("onegate/record/urgent"),externaldata_update:iNet.getUrl("onegate/externaldata/update")},g={iframeTask:$("#task-iframe")};g.iframeTask.on("load",function(){if((b.appLayout||"")=="iDesk"){console.log(">> iframeTask loaded >>");var a=g.iframeTask.get(0).contentWindow.document.body,c="";c+='<span style="padding-right: 5px;">';c+='<button class="btn btn-warning hide" style="padding-right: 10px" data-action="iDeskTaskList">';c+='<i class="icon-list"></i>';c+="</button>";c+="</span>";
c+='<button type="button" data-action="iDeskBack" class="btn btn-default">';c+='<i class="icon-arrow-left"></i>';c+="</button>";if(iNet.isEmpty(b.typeLayout||"")){c+='<button type="button" data-action="iDeskAdd" class="btn btn-default" style="margin-left: 5px;">';c+='<i class="icon-plus"></i>';c+="</button>";c=String.format('<div style="min-height: 30px; padding: 5px; background-color: rgb(245, 245, 245); border-bottom: 1px solid rgb(229, 229, 229);">{0}</div>',c);$(a).prepend(c);b.searchWidget=g.iframeTask.get(0).contentWindow.searchWidget;
$(a).find('[data-action="iDeskTaskList"]').on("click",function(){console.log(">> iDeskTaskList >>");b.setListTaskType("menu")});$(a).find('[data-action="iDeskBack"]').on("click",function(){console.log(">> iDeskBack >>",b.href);b.changeLayout(b.href)});$(a).find('[data-action="iDeskAdd"]').on("click",function(){console.log(">> iDeskAdd >>",b.searchWidget.getData());var d=b.searchWidget.getData()||[],f={task:b.taskInfo.taskId,graph:b.taskInfo.graphId};$.each(d,function(i,k){f.signNumber=k.id;f.subject=
"["+((k.edSearchDto||{}).signNumber||"")+"] "+((k.edSearchDto||{}).subject||"");$.postJSON(j.externaldata_update,f,function(n){console.log(">>>>>>",n)});if(i==d.length-1){b.notifySuccess(h.constant.submit_title,h.constant.submit_success);$(a).find('[data-action="iDeskBack"]').trigger("click")}})});b.on("typechange",function(d){d=="menu"?$(a).find('[data-action="iDeskTaskList"]').show():$(a).find('[data-action="iDeskTaskList"]').hide()})}else{$(a).find("#ed-view-widget .viewToolbar").append(c);$(a).find('[data-action="iDeskTaskList"]').on("click",
function(){console.log(">> iDeskTaskList >>");b.setListTaskType("menu")});$(a).find('[data-action="iDeskBack"]').on("click",function(){console.log(">> iDeskBack >>",b.href);b.changeLayout(b.href)});b.on("typechange",function(d){d=="menu"?$(a).find('[data-action="iDeskTaskList"]').show():$(a).find('[data-action="iDeskTaskList"]').hide()})}}});var l=function(){var a=e.getParams()||{};a.keyword=e.basicSearch.$keyword.val();a.type=e.advanceSearch.$type.getValue()||"";if("inprocess"==a.type)a.type="";
a.warnHour=e.advanceSearch.$warnHour.val()||-1;parseFloat(a.warnHour)<=0&&delete a.warnHour;e.setParams(a);e.load()},e=new iNet.ui.listview({id:"task-list",uiItemId:"task-list-item-ui",url:j.task_open,basicSearch:function(){this.id="task-list-basic-search";this.intComponent=function(){var a=$("#task-list-basic-search-expand-btn"),c=$("#task-list-basic-search-search-btn");this.$keyword=$("#task-list-basic-search-txt-keyword");this.$keyword.on("keyup",function(d){if(d.which==13){e.advanceSearch.hide();
l()}});c.on("click",function(){e.advanceSearch.hide();l()});a.on("click",function(){e.advanceSearch.show()})}},advanceSearch:function(){this.id="task-list-advance-search";this.intComponent=function(){var a=this;this.$warnHour=$("#task-list-advance-search-txt-warnHour");this.$type=FormService.createSelect("task-list-advance-search-txt-type",[{id:"inprocess",code:"inprocess",name:h.task.typeInprocess},{id:"overdue",code:"overdue",name:h.task.typeOverdue},{id:"urgent",code:"urgent",name:h.task.typeUrgent}],
"id",1,false,false);this.$type.setValue("inprocess");this.$type.on("change",function(){a.$type.getValue()=="urgent"&&$.postJSON(j.urgent_update,{},function(f){console.log(">>>>>>",f)})});var c=$("#task-list-advance-search-search-btn"),d=$("#task-list-advance-search-close-btn");c.on("click",function(){e.advanceSearch.hide();l()});d.on("click",function(){e.advanceSearch.hide()})}},pullLeft:function(){this.id="task-list-pull-left";this.intComponent=function(){}},params:{pageSize:20,pageNumber:0,warnHour:-1},
convertData:function(a){var c=a||{};b.taskData.list=c.elements||[];e.setTotal(b.taskData.list.length);$.each(b.taskData.list,function(d,f){if(iNet.isEmpty(f.uuid))f.uuid=f.history.uuid;e.addItem(f)})}});e.on("indexchange",function(a){var c=a||{};b.taskData.index=c;var d=(c.history||{}).screenID||"",f="",i=iNet.getUrl("xgate/page/task/screen");if(!iNet.isEmpty(d))if(FormService.checkPageExists(iNet.getUrl(d)))i=iNet.getUrl(d);b.changeLayout(i);b.taskInfo=c});e.on("typechange",function(a){g.iframeTask.removeClass("full min");
b.fireEvent("typechange",a);a=="max"?g.iframeTask.addClass("min"):g.iframeTask.addClass("full")});g.iframeTask.height($(iNet.getLayout().window).height()-92);$(iNet.getLayout()).on("resize",function(){try{g.iframeTask.height($(iNet.getLayout().window).height()-92)}catch(a){}});this.setListTaskType=function(){e.setType("menu")};this.refresh=function(){e.load()};this.getTaskDataIndex=function(){return this.taskData.index||{}};this.changeLayout=function(a,c,d){b.appLayout=c||"";b.typeLayout=d||"";b.href=
g.iframeTask.get(0).contentWindow.location.href;if(!iNet.isEmpty(d)&&c=="iDesk")a+="?id="+d;g.iframeTask.get(0).contentWindow.location.replace(a)};iNet.ui.task.TTask.superclass.constructor.call(this)};iNet.extend(iNet.ui.task.TTask,iNet.ui.app.widget);taskFrame=new iNet.ui.task.TTask;taskFrame.show()});