$(function(){iNet.ns("iNet.ui.task","iNet.ui.task.TFollow");iNet.ui.task.TFollow=function(){this.id="follow-div";var m=this,k={record:iNet.resources.receiver.record,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},g={commentCreate:iNet.getUrl("firmtask/comment/create"),urgent:iNet.getUrl("onegate/record/urgent"),deptrecord:iNet.getUrl("onegate/deptrecord/search"),pcstrecord:iNet.getUrl("onegate/pcstrecord/search"),mngtrecord:iNet.getUrl("onegate/mngtrecord/search"),
deptcount:iNet.getUrl("onegate/deptrecord/count"),pcstcount:iNet.getUrl("onegate/pcstrecord/count"),mngtcount:iNet.getUrl("onegate/mngtrecord/count"),recordSearch:"",recordCount:"",avatar:iNet.getUrl("system/userprofile/photo")},l={backPage:$('[data-type="row-pagging"] [data-action="backPage"]'),nextPage:$('[data-type="row-pagging"] [data-action="nextPage"]'),menuChange:$('[data-action="menuChange"]'),search:$('[data-action="search"]')},a={table:$("#chart-record-table"),tableKeyword:$("#chart-record-table-keyword"),
rowPagging:$('#chart-record-table [data-type="row-pagging"]'),pageNumber:$("#chart-record-table [data-page-number]"),pageTotal:$("#chart-record-table [data-page-total]"),rowTemp:$('#chart-record-table [data-type="row-template"]'),tableData:$('#chart-record-table tbody[data-type="data"]'),totalProcess:$('[total-process][data-type="number"]'),totalOverdue:$('[total-overdue][data-type="number"]'),totalUrgent:$('[total-urgent][data-type="number"]')};if(!iNet.isEmpty(iNet.roles)){var u=iNet.roles||{};
if(u.management){g.recordSearch=g.mngtrecord;g.recordCount=g.mngtcount}else if(u.processor){g.recordSearch=g.pcstrecord;g.recordCount=g.pcstcount}else if(u.receiver){g.recordSearch=g.deptrecord;g.recordCount=g.deptcount}}l.menuChange.on("click",function(){var b=$(this).attr("href")||"";if(!iNet.isEmpty(b))iNet.getLayout().location.href=iNet.getUrl("xgate/page/index")+b});l.backPage.on("click",function(){var b=CommonService.getNumber(a.pageNumber.attr("pageNumber"),0),d=CommonService.getNumber(a.pageTotal.attr("pageTotal"),
0);b--;if(b<0)b=0;n(b)});l.nextPage.on("click",function(){var b=CommonService.getNumber(a.pageNumber.attr("pageNumber"),0),d=CommonService.getNumber(a.pageTotal.attr("pageTotal"),0);b++;if(b>=d)b=d-1;n(b)});l.search.on("click",function(){var b=$(this).attr("data-type")||"",d=$(this).attr("class-disabled")||"",e=$(this).attr("class-enabled")||"";if(b=="inprocess"||b=="overdue"||b=="urgent")if($(this).hasClass(d)){l.search.each(function(f,h){var i=$(h).attr("class-disabled")||"",j=$(h).attr("class-enabled")||
"";$(h).removeClass(j).addClass(i)});w();$(this).removeClass(d).addClass(e)}else $(this).removeClass(e).addClass(d);n(0)});a.tableKeyword.on("keyup",function(b){b.which==13&&n(0)});var z=function(){a.tableData.find("[data-action]").unbind("click");a.tableData.find('[data-action="dropdown"]').each(function(b,d){$(d).on("click",function(){$('[data-action="dropdown"] li.dropdown').removeClass("open");var e=$(this);e.find("li.dropdown").addClass("open");setTimeout(function(){e.find("li.dropdown").removeClass("open")},
3E3)})});a.tableData.find('[data-action="print"]').each(function(b,d){$(d).on("click",function(){var e=$(this).attr("requestID")||"",f=$(this).attr("formNo")||"";if(!iNet.isEmpty(e)&&!iNet.isEmpty(f)){window.open(iNet.getUrl(CommonService.pageRequest[f])+"?task="+e,"_blank");$(this).parent().parent().removeClass("open")}})});a.tableData.find('[data-action="view"]').each(function(b,d){$(d).on("click",function(){var e=$(this).attr("serialNo")||"",f=$(this).attr("recordStatus")||"",h="chart";if(!iNet.isEmpty(e)&&
!iNet.isEmpty(f)){var i=iNet.getUrl(CommonService.pageRequest.xgate);f=f.toLowerCase();i+=CommonService.pageRequest.hashtag[f];iNet.getLayout().window.location.href=i;iNet.getLayout().parentParams={keyword:e,pageUrl:h}}})});a.tableData.find('[data-action="comment"]').each(function(b,d){$(d).on("click",function(){var e=$(this).attr("uuid")||"";if(!iNet.isEmpty(e)){$('[data-action="dropdown"] li.dropdown').removeClass("open");v(e,[1,7])}})});a.tableData.find('[data-action="comment-submit"]').each(function(b,
d){$(d).on("click",function(){var e=$(this).parent().parent().find("textarea"),f=$(this).attr("uuid")||"",h=$(this).attr("requestID")||"",i=e.val();!iNet.isEmpty(h)&&!iNet.isEmpty(i)&&$.postJSON(g.commentCreate,{task:h,note:i},function(j){var r=j||{};if(CommonService.isSuccess(r)){e.val("");v(f,[1,2,3,4,5,6]);m.notifySuccess(k.constant.submit_title,k.constant.submit_success)}},{mask:m.getMask(),msg:iNet.resources.ajaxLoading.processing})})});a.tableData.find('[data-action="comment-cancel"]').each(function(b,
d){$(d).on("click",function(){var e=$(this).attr("uuid")||"";iNet.isEmpty(e)||v(e,[1,2,3,4,5,6])})});a.tableData.find('[data-action="urgent"]').each(function(b,d){$(d).on("click",function(){var e=$(this).attr("additionalID")||"",f=$(this).attr("uuid")||"";iNet.isEmpty(e)||$.postJSON(g.urgent,{additionalID:e},function(h){var i=h||{};if(CommonService.isSuccess(i)){y(f,i.urgent);m.notifySuccess(k.constant.submit_title,k.constant.submit_success)}},{mask:m.getMask(),msg:iNet.resources.ajaxLoading.processing})})})},
w=function(){a.totalProcess.text(0);a.totalOverdue.text(0);a.totalUrgent.text(0);$.postJSON(g.recordCount,{},function(b){if(CommonService.isSuccess(b)){var d=b||{};a.totalProcess.text(d.onegateProcess||"0");a.totalOverdue.text(d.onegateOverdue||"0");a.totalUrgent.text(d.onegateUrgent||"0")}})};w();var y=function(b,d){var e=a.tableData.find('tr[uuid="'+b+'"] [data-display="urgent"]');d?e.css("display",""):e.css("display","none")},n=function(b){a.tableData.html("");a.pageNumber.attr("pageNumber",b||
0);a.pageNumber.text(0);a.pageTotal.attr("pageTotal",0);a.pageTotal.text(0);var d=a.tableKeyword.val(),e={context:iNet.context,zone:iNet.zone,pageNumber:b,pageSize:10,keyword:d},f="";l.search.each(function(h,i){var j=$(i).attr("class-enabled")||"";if(!iNet.isEmpty(j))if($(i).hasClass(j)){f=$(i).attr("data-type")||"";return false}});if(f=="urgent"||f=="overdue")e.type=f;if(f=="inprocess")e.status="INPROCESS";iNet.isEmpty(g.recordSearch)?m.notifyError(k.constant.warning_title,"SERVICE_NOT_FOUND"):$.postJSON(g.recordSearch,
e,function(h){a.pageNumber.text(0);a.pageNumber.attr("pageNumber",0);a.pageTotal.text(0);a.pageTotal.attr("pageTotal",0);if(CommonService.isSuccess(h)){var i=h||{},j=i.total||0,r=CommonService.getTotalPage(j,10),A=(b||0)+1;if(j>0){a.pageNumber.text(A);a.pageNumber.attr("pageNumber",b||0);a.pageTotal.text(r);a.pageTotal.attr("pageTotal",r)}$.each(i.items,function(E,c){c.recordStatus=c.status;var s="bg-success";if(c.status=="INPROCESS")s="bg-blue";else if(c.status=="REJECTED"||c.status=="COMPLETED")s=
"bg-danger";else if(c.status=="PUBLISHED")s="bg-grey";a.rowTemp.find('[data-color="status-color"]').removeClass("bg-success bg-danger bg-grey bg-blue");a.rowTemp.find('[data-color="status-color"]').addClass(s);var o="text-success",B="text-success text-info text-violet text-error",p="text-success",C="text-success text-info text-violet text-error",q="border-success",D="border-success border-info border-violet border-danger",t=CommonService.getPercentCurrentDate(c.created,c.appointment,c.completed);
if(CommonService.getNumber(t,0)<=25){p=o="text-success";q="border-success"}else if(CommonService.getNumber(t,0)<=50){p=o="text-info";q="border-info"}else if(CommonService.getNumber(t,0)<=75){p=o="text-violet";q="border-violet"}else if(CommonService.getNumber(t,0)<=100){p=o="text-error";q="border-danger"}a.rowTemp.find('[data-color="percent-color"]').removeClass(B);a.rowTemp.find('[data-color="percent-color"]').addClass(o);c.percent=CommonService.getPercentCurrentDate(c.created,c.appointment,c.completed);
c.avatar=g.avatar+"?thumbnail=48&usercode="+c.creator;a.rowTemp.find('[data-col="avatar"]').attr("src",c.avatar);c.status=k.record["status"+c.status]||"";c.created=c.created>0?(new Date(c.created)).format("H:i d/m/Y"):"";a.rowTemp.find('[data-color="appointment-color"]').removeClass(C);a.rowTemp.find('[data-color="appointment-color"]').addClass(p);a.rowTemp.find('[data-color="appointment-border-color"]').removeClass(D);a.rowTemp.find('[data-color="appointment-border-color"]').addClass(q);c.appointment=
c.appointment>0?(new Date(c.appointment)).format("H:i d/m/Y"):"";c.completed=c.completed>0?(new Date(c.completed)).format("H:i d/m/Y"):"";for(var x in c)a.rowTemp.find('[data-col="'+x+'"]').text(c[x]);c.urgent?a.rowTemp.find('[data-display="urgent"]').css("display",""):a.rowTemp.find('[data-display="urgent"]').css("display","none");a.rowTemp.find("[uuid]").attr("uuid",c.uuid);a.rowTemp.find("[recordStatus]").attr("recordStatus",c.recordStatus);a.rowTemp.find("[requestID]").attr("requestID",c.requestID);
a.rowTemp.find("[serialNo]").attr("serialNo",c.serialNo);a.rowTemp.find("[additionalID]").attr("additionalID",c.additionalID);a.tableData.append('<tr uuid="'+c.uuid+'">'+a.rowTemp.html()+"</tr>")});z()}})};n(0);var v=function(b,d){iNet.isEmpty(d)||iNet.isEmpty(b)||a.tableData.find('tr[uuid="'+b+'"] td[data-cell]').each(function(e,f){var h=$(f).attr("data-cell")||"";if(!iNet.isEmpty(h)&&h.isNumeric())d.indexOf(parseInt(h))<0?$(f).css("display","none"):$(f).css("display","")})};iNet.ui.task.TFollow.superclass.constructor.call(this)};
iNet.extend(iNet.ui.task.TFollow,iNet.ui.app.widget);(new iNet.ui.task.TFollow).show()});