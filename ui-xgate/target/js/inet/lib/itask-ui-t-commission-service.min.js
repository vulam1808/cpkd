$(function(){iNet.ns("iNet.ui.task","iNet.ui.task.TCommission");iNet.ui.task.TCommission=function(){this.id="commission-div";var f=this,i=null,c={commission:iNet.resources.task.commission,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},k={load_user:iNet.getUrl("system/account/role"),view:iNet.getUrl("cloud/workflow/commission/list"),create:iNet.getUrl("cloud/workflow/commission/create"),del:iNet.getUrl("cloud/workflow/commission/delete")},
o={CREATE:$("#commission-create-btn")},m=this.confirmDialog(iNet.resources.message.dialog_confirm_title,f.getNotifyContent(c.constant.del_content,null),function(){if(!iNet.isEmpty(i)){m.hide();$.postJSON(k.del,{commissionID:i},function(a){var b=a||{};if(CommonService.isSuccess(b)){var e=i.split(",");for(a=0;a<e.length;a++)g.remove(e[a]);i=null;f.notifySuccess(c.constant.del_title,c.constant.del_success)}else f.notifyError(c.constant.del_title,f.getNotifyContent(c.constant.del_error,b.errors||[]))},
{mask:f.getMask(),msg:iNet.resources.ajaxLoading.deleting})}}),h=[];$.postJSON(k.load_user,{},function(a){var b=a||{};if(CommonService.isSuccess(b)){h=[];$.each(b.items||[],function(e,d){h.push({id:d.username,code:d.username,name:d.fullname})});g.load()}});var n=function(a){var b="";$.each(h,function(e,d){if(a.indexOf(d.id.toString())!=-1){if(iNet.isEmpty(d.name))d.name="empty";b+='<label class="label label-info" style="margin-right: 5px;">'+d.name+"</label>"}});return b},p=new DataSource({columns:[{property:"authorizedPerson",
label:c.commission.authorizedPerson,sortable:true,disabled:true,editData:h,type:"selectx",displayField:"name",valueField:"id",config:{multiple:true,data:[],minimumInputLength:0,initSelection:function(a,b){var e=$(a).val();if(e!=""){var d=e.split(",");if(h.length>0){var j=[];$.each(h,function(q,l){if(d.indexOf(l.id.toString())!=-1){if(iNet.isEmpty(l.name))l.name="empty";j.push(l)}});b(j)}}},formatResult:function(a){return a.name},formatSelection:function(a){return a.name},query:function(a){var b={results:[]};
$.each(h,function(){if(a.term.length==0||this.name.toUpperCase().indexOf(a.term.toUpperCase())>=0)b.results.push({id:this.id,name:this.name})});a.callback(b)},escapeMarkup:function(a){return a}},validate:function(a){if($.trim(a)=="")return String.format(c.validate.is_not_blank,c.commission.authorizedPerson)}},{property:"formDate",label:c.commission.formDate,sortable:true,disabled:true,type:"datetime",validate:function(a){if($.trim(a)=="")return String.format(c.validate.is_not_blank,c.commission.formDate)},
width:150},{property:"toDate",label:c.commission.toDate,sortable:true,disabled:true,type:"datetime",validate:function(a){if($.trim(a)=="")return String.format(c.validate.is_not_blank,c.commission.toDate)},width:150},{property:"note",label:c.commission.note,sortable:true,disabled:true,type:"text",width:250},{label:"",type:"action",width:32,align:"center",buttons:[{text:iNet.resources.message.button.del,icon:"icon-trash",labelCls:"label label-important",fn:function(a){i=a.uuid.toString();m.setContent(String.format(c.constant.del_content,
""));m.show()}}]}],delay:250}),g=new iNet.ui.grid.Grid({id:"commission-grid",url:k.view,params:{zone:iNet.zone,context:iNet.context},convertData:function(a){var b=a||{};g.setTotal(b.total);var e=b.items||[];$.each(e,function(d,j){j.authorizedPerson=n(j.authorizedPerson)});return e},dataSource:p,stretchHeight:false,editable:false,firstLoad:false,idProperty:"uuid"});g.on("save",function(a){var b=a||{};b.zone=iNet.zone;b.context=iNet.context;b.formDate=b.formDate.dateToLong();b.toDate=b.toDate.dateToLong();
b.persons=b.authorizedPerson.toString();delete b.authorizedPerson;$.postJSON(k.create,b,function(e){var d=e||{};if(CommonService.isSuccess(d)){d.authorizedPerson=n(d.authorizedPerson);g.insert(d);f.notifySuccess(c.constant.save_title,c.constant.save_success)}else f.notifyError(c.constant.save_title,f.getNotifyContent(c.constant.save_error,d.errors||[]))})});o.CREATE.on("click",function(){g.newRecord();var a=g.getColumnModel(),b=null;b=a.getColumnByName("authorizedPerson").getCellAdd(1);b.setDisabled(false);
b.setValue("");b=a.getColumnByName("formDate").getCellAdd(1);b.setDisabled(false);b=a.getColumnByName("toDate").getCellAdd(1);b.setDisabled(false);b=a.getColumnByName("note").getCellAdd(1);b.setDisabled(false);b.setValue("")});iNet.ui.task.TCommission.superclass.constructor.call(this)};iNet.extend(iNet.ui.task.TCommission,iNet.ui.app.widget);(new iNet.ui.task.TCommission).show()});