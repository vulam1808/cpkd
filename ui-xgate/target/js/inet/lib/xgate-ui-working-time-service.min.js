$(function(){iNet.ns("iNet.ui.admin","iNet.ui.admin.WorkingTime");iNet.ui.admin.WorkingTime=function(){this.id="working-time-div";var m=this,n=false,h={workingtime:iNet.resources.xgate.admin.workingtime,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},r={SAVE:$("#working-time-save-btn")},s={AddSchedule:$("#addSchedule")},l={load:iNet.getUrl("onegate/deptadditional/load"),update:iNet.getUrl("onegate/deptadditional/update"),
load_user:iNet.getUrl("system/account/role"),gRecever_load:iNet.getUrl("onegate/receivergroup/load"),gRecever_create:iNet.getUrl("onegate/receivergroup/create")},c={tableSchedule:$("#working-time-schedule-tbl"),tableContainer:$("#working-time-container"),tableState:$("#working-time-saturdayState"),maxAppt:$("#working-time-txt-maxAppt"),warnBeforeLate:$("#working-time-txt-warnBeforeLate"),waitHourOfReceiver:$("#working-time-txt-waitHourOfReceiver"),waitHourOfCitizenReturn:$("#working-time-txt-waitHourOfCitizenReturn"),
receiptPattern:$("#working-time-txt-receiptPattern"),edgeTimeAccept:$("#working-time-txt-edgeTimeAccept"),resetFlag:$("#working-time-txt-resetFlag"),centerPlace:$("#working-time-select-centerPlace")};c.centerPlace=FormService.createSelect("working-time-select-centerPlace",[],"id",2,true,true);$.postJSON(l.load_user,{},function(f){var b=f||{};if(CommonService.isSuccess(b)){var a=[];$.each(b.items||[],function(e,d){a.push({id:d.username,code:d.username,name:d.fullname})});c.centerPlace=FormService.createSelect("working-time-select-centerPlace",
a,"id",2,true,true);c.centerPlace.on("change",function(){n=true});$.postJSON(l.gRecever_load,{group:"CENTER"},function(e){var d=e||{};if(CommonService.isSuccess(d))c.centerPlace.setValue([(d.users||[]).toString()])})}});c.tableContainer.find("input.time-picker").each(function(f,b){$(b).timepicker({minuteStep:1,showSeconds:false,showMeridian:false})});var o=function(f){var b=f||"",a=0,e=0;if(iNet.isEmpty(b))b="00:00";else{a=Math.floor(b/60);e=b%60;if(a<10)a="0"+a;if(e<10)e="0"+e;b=a+":"+e}return b},
p=function(f){var b=f||{},a='<tr data-action="row"><td>';a+='<select style="width: 100%;" id="'+iNet.generateId()+'" class="multiselect" multiple="multiple">';a+='<option value="2">'+h.workingtime.mon+"</option>";a+='<option value="3">'+h.workingtime.tue+"</option>";a+='<option value="4">'+h.workingtime.wed+"</option>";a+='<option value="5">'+h.workingtime.thu+"</option>";a+='<option value="6">'+h.workingtime.fri+"</option>";a+='<option value="7">'+h.workingtime.sat+"</option>";a+='<option value="8">'+
h.workingtime.sun+"</option>";a+="</select>";a+="</td>";a+="<td>";a+='<div class="input-icon input-icon-right date bootstrap-timepicker" style="width: 100px;">';a+='<input type="text" value="08:00" class="span12 time-picker">';a+='<i class="add-on icon-time"></i>';a+="</div></td>";a+="<td>";a+='<div class="input-icon input-icon-right date bootstrap-timepicker" style="width: 100px;">';a+='<input type="text" value="11:30" class="span12 time-picker">';a+='<i class="add-on icon-time"></i>';a+="</div></td>";
a+="<td>";a+='<div class="input-icon input-icon-right date bootstrap-timepicker" style="width: 100px;">';a+='<input type="text" value="13:30" class="span12 time-picker">';a+='<i class="add-on icon-time"></i>';a+="</div></td>";a+="<td>";a+='<div class="input-icon input-icon-right date bootstrap-timepicker" style="width: 100px;">';a+='<input type="text" value="17:30" class="span12 time-picker">';a+='<i class="add-on icon-time"></i>';a+="</div></td>";a+='<td><span data-action="delete" style="cursor: pointer" title="Delete" class="label label-important"><i class="icon-trash icon-white"></i></span></td>';
a+="</tr>";f=$(a);c.tableSchedule.find("tbody:first").append(f);f.find("input.time-picker").each(function(e,d){$(d).timepicker({minuteStep:1,showSeconds:false,showMeridian:false});if((b.schedule||[]).length==4)$(d).val(o(b.schedule[e]))});f.find('[multiple="multiple"]').each(function(e,d){d=new iNet.ui.form.select.Select({placeholder:h.workingtime.selectPlaceholder,allowClear:true,id:$(d).prop("id"),formatResult:function(i){var g=i||{};return g.text},formatSelection:function(i){var g=i||{};return g.text}});
d.setValue(b.dayofweek||"")});f.find('[data-action="delete"]').each(function(e,d){$(d).on("click",function(){$(this).parent().parent().remove()})})};s.AddSchedule.on("click",function(){p()});r.SAVE.on("click",function(){var f="",b="",a="",e=c.tableSchedule.find('tbody:first [data-action="row"]')||[];e.each(function(k,j){var t=$(j).find('[multiple="multiple"]').prop("id");f+=($("#"+t).val()||"").toString()+(e.length==k+1?"":"/");var q=$(j).find(".time-picker")||[];q.each(function(u,v){b+=$(v).val()+
(q.length==u+1?"":",")});b+=e.length==k+1?"":"/"});var d=c.tableContainer.find(".time-picker")||[];d.each(function(k,j){a+=$(j).val()+(d.length==k+1?"":",")});var i=c.tableState.find('[name="saturdayState"]:checked').val(),g={maxAppt:c.maxAppt.val(),receiptPattern:c.receiptPattern.val(),waitHourOfCitizenReturn:c.waitHourOfCitizenReturn.val(),waitHourOfReceiver:c.waitHourOfReceiver.val(),warnBeforeLate:c.warnBeforeLate.val(),edgeTimeAccept:c.edgeTimeAccept.val(),resetFlag:c.resetFlag.val(),schedule:b,
scheduledow:f,saturdayState:i,worktimes:a};$.postJSON(l.update,g,function(k){var j=k||{};CommonService.isSuccess(j)?m.notifySuccess(h.constant.save_title,h.constant.save_success):m.notifyError(h.constant.save_title,m.getNotifyContent(h.constant.save_error,j.errors||[]))});if(n){n=false;g={group:"CENTER",users:c.centerPlace!=null?c.centerPlace.getValue().toString():""};iNet.isEmpty(g.users)||$.postJSON(l.gRecever_create,g,function(k){var j=k||{};console.log(">>gRecever_create>>",j)})}});$.postJSON(l.load,
{},function(f){var b=f||{};if(CommonService.isSuccess(b)){var a=b.appointments||[],e=b.worktime||[],d=b.saturdayState||0;$.each(a,function(i,g){p(g)});e.length==4?c.tableContainer.find(".time-picker").each(function(i,g){$(g).val(o(e[i]))}):c.tableContainer.find(".time-picker").each(function(i,g){$(g).val("00:00")});c.maxAppt.val(b.maxAppt||0);c.receiptPattern.val(b.receiptPattern||"");c.waitHourOfCitizenReturn.val(b.waitHourOfCitizenReturn||0);c.waitHourOfReceiver.val(b.waitHourOfReceiver||0);c.warnBeforeLate.val(b.warnBeforeLate||
0);c.edgeTimeAccept.val(b.edgeTimeAccept||0);c.resetFlag.val(iNet.isEmpty(b.resetFlag)?2:b.resetFlag);c.tableState.find('[name="saturdayState"][value="'+d+'"]').prop("checked",true)}});iNet.ui.admin.WorkingTime.superclass.constructor.call(this)};iNet.extend(iNet.ui.admin.WorkingTime,iNet.ui.app.widget);(new iNet.ui.admin.WorkingTime).show()});