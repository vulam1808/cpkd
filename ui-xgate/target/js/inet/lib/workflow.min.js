$(function(){iNet.ns("iNet.ui.workflow","iNet.ui.workflow.Virtual");iNet.ui.workflow.Virtual=function(k){var w={element:"statemachine-design",selector:".statemachine-design .w"},g=k||w;iNet.apply(this,g);var c=this;this.$element=$("#"+this.element);this.label="";this.data={connections:[]};this.template={node:'<div class="w" id="{0}" data-type="{5}" style="left: {2}px; top: {3}px;"><i class="{4}"></i> {1} <div class="ep"></div></div>',end:'<div class="w" id="{0}" style="left: 482px; top: 229px;">{1}</div>',
begin:'<div class="w w-n-start" id="{0}" data-type="{5}" style="left: {2}px; top: {3}px;"><i class="{4}"></i> {1} <div class="ep"></div></div>',history:'<div class="w" id="{0}" data-type="{5}" style="left: {2}px; top: {3}px; background-color: {6}; color: {7};" data-toggle="popover" data-trigger="hover" title="{9}" data-placement={11} data-content="{10}"><i class="{4}"></i> {1} <div class="ep"  style="box-shadow: none; background-color: {8};"></div></div>',view:'<div class="w" id="{0}" data-type="{5}" style="left: {2}px; top: {3}px;"><i class="{4}"></i> {1} <div class="ep" style="box-shadow: none; background-color: #FFF;"></div></div>'};
this.instance=jsPlumb.getInstance({Endpoint:["Dot",{radius:2}],HoverPaintStyle:{strokeStyle:"#1e8151",lineWidth:2},ConnectionOverlays:[["Arrow",{location:1,id:"arrow",length:14,foldback:0.8}],["Label",{label:"Connections",id:"label",cssClass:"aLabel"}]],Container:this.element});this.windows=jsPlumb.getSelector(this.selector);this.instance.draggable(this.windows);this.instance.bind("click",function(p){c.removeCssSelected();for(var C=p.sourceId,I=p.targetId,R=c.data.connections,N=0;N<R.length;N++)if(C==
R[N].source&&I==R[N].target){p.uuid=R[N].uuid;break}(C=p.getOverlay("label").canvas)&&$(C).addClass("selected");c.fireEvent("connectionclick",p)});this.instance.bind("endpointClick",function(p,C){c.fireEvent("endpointclick",p,C)});this.instance.bind("connection",function(){});this.instance.bind("connectionDragStop",function(p){c.fireEvent("connectiondragstop",p)});this.$element.on("click","div.w",function(p){c.removeCssSelected();$(this).addClass("selected");c.fireEvent("nodeclick",p,this)});this.draggable=
function(p){c.instance.draggable(p);p.on("dragstop",function(C,I){c.fireEvent("dragstop",I)})};this.makeSource=function(p){c.instance.makeSource(p,{filter:".ep",anchor:"Continuous",connector:["Flowchart",{stub:[40,60],gap:10,cornerRadius:5,alwaysRespectStubs:true}],connectorStyle:{strokeStyle:"#5c96bc",lineWidth:3,outlineColor:"transparent",outlineWidth:4}})};this.makeTarget=function(p){c.instance.makeTarget(p,{dropOptions:{hoverClass:"dragHover"},anchor:"Continuous"})};this.removeCssSelected=function(){c.$element.find("div.selected").removeClass("selected");
for(var p=c.instance.getAllConnections(),C=0;C<p.length;C++){var I=p[C].getOverlay("label").canvas;I&&$(I).removeClass("selected")}}};iNet.extend(iNet.ui.workflow.Virtual,iNet.Component,{addNode:function(k){var w=this.template.node;if(k.start&&!k.endway)w=this.template.begin;if(k.history){var g=k.historyData||{};if(iNet.isEmpty(g)){w=this.template.view;this.$element.append(String.format(w,k.id,k.name,k.x,k.y,k.icon,k.type))}else{w=this.template.history;this.$element.append(String.format(w,k.id,k.name,
k.x,k.y,k.icon,k.type,g.nodeColor,"#FFF",g.statusColor,g.nodeTitle,g.nodeHtmlContent,g.notePlacement))}}else this.$element.append(String.format(w,k.id,k.name,k.x,k.y,k.icon,k.type));k=$.getCmp(k.id);this.draggable(k);this.makeSource(k);this.makeTarget(k)},removeNode:function(k){k=$.getCmp(k);this.instance.detachAllConnections(k);this.instance.unmakeSource(k);k.remove()},moveNode:function(k,w,g){$.getCmp(k).css({left:w,top:g})},connect:function(k,w,g,c){this.instance.connect({source:k,target:w}).getOverlay("label").setLabel(g);
this.data.connections.push({uuid:c,source:k,target:w})},detach:function(k){this.instance.detach(k)},reset:function(){var k=this;$.each(this.data.connections||[],function(w,g){k.detach(g)});this.data.connections=[];jsPlumb.reset();this.$element.empty()}});iNet.ui.workflow.Workflow=function(k){var w=k||{};iNet.apply(this,w);var g={wfConstant:iNet.resources.wfTool.constant,wfGraph:iNet.resources.wfTool.graph,wfNode:iNet.resources.wfTool.node,wfConnection:iNet.resources.wfTool.connection,wfBiz:iNet.resources.wfTool.biz};
$("#"+w.id).html(function(){var d="";d+='<div class="row-fluid control">';d+='   <span class="span4"><label for="node-name-txt" class="control-label">{0} <span class="required"></span></label></span>';d+='   <span class="span8"><input id="node-name-txt" class="span12" type="text"></span>';d+="</div>";d=String.format(d,g.wfNode.name);var a="";a+='<div id="node-actor-select" class="row-fluid">';a+='   <span class="span4"><label for="node-actor-cbo" class="control-label">{0} <span class="required"></span></label></span>';
a+='   <span class="span8">';a+='      <input id="node-actor-cbo" class="span11">';a+='      <span id="node-actor-add" class="span1" style="border: 1px solid #AAA;border-radius:3px;background-color: #F4F4F4;color: #888888;padding-top: 5px;padding-left: 1px;cursor: pointer;">';a+='          <i class="icon-plus"></i>';a+="      </span>";a+="   </span>";a+="</div>";a=String.format(a,g.wfNode.actor);var b="";b+='<div id="node-actor-new" class="row-fluid hide" style="padding-top: 5px;padding-bottom: 5px;">';
b+='  <div class="row-fluid hide">';b+='      <span class="span4"><label for="node-actor-code" class="control-label">{0} <span class="required"></span></label></span>';b+='      <span class="span8"><input id="node-actor-code" class="span12" type="text"></span>';b+="  </div>";b+='  <div class="row-fluid">';b+='      <span class="span4"><label for="node-actor-name" class="control-label">{1} <span class="required"></span></label></span>';b+='      <span class="span8"><input id="node-actor-name" class="span12" type="text"></span>';
b+="  </div>";b+='  <div class="row-fluid" style="text-align: center;">';b+='      <button id="node-actor-save" type="button" class="btn btn-small"><i class="icon-save"></i> </button>';b+='      <button id="node-actor-cancel" type="button" class="btn btn-small"><i class="icon-remove-sign"></i></button>';b+="  </div>";b+="</div>";b=String.format(b,g.wfNode.actorCode,g.wfNode.actorName);var e="";e+='<div class="row-fluid">';e+='   <span class="span5"><label for="node-multiDecision-check" class="control-label">{0} </label></span>';
e+='   <span class="span7">';e+="      <label>";e+='          <input id="node-multiDecision-check" type="checkbox" class="ace" ">';e+='          <span class="lbl"></span>';e+="      </label>";e+="   </span>";e+="</div>";e=String.format(e,g.wfNode.multiDecision);var h="";h+='<div class="row-fluid">';h+='   <span class="span5"><label for="node-reject-check" class="control-label">{0} </label></span>';h+='   <span class="span7">';h+="      <label>";h+='          <input id="node-reject-check" type="checkbox" class="ace" ">';
h+='          <span class="lbl"></span>';h+="      </label>";h+="   </span>";h+="</div>";h=String.format(h,g.wfNode.reject);var i="";i+='<div class="row-fluid">';i+='   <span class="span5"><label for="node-attr-camel-check" class="control-label">{0} </label></span>';i+='   <span class="span7">';i+="      <label>";i+='          <input id="node-attr-camel-check" type="checkbox" class="ace" ">';i+='          <span class="lbl"></span>';i+="      </label>";i+="   </span>";i+="</div>";i=String.format(i,
g.wfNode.attCamel);var l="";l+='<div class="row-fluid control hide">';l+='   <span class="span4"><label for="node-type-cbo" class="control-label">{0} </label></span>';l+='   <span class="span8"><input id="node-type-cbo" disabled="disabled" class="span12"></span>';l+="</div>";l=String.format(l,g.wfNode.type);var n="";n+='<div class="row-fluid control">';n+='   <span class="span4"><label for="node-join-type-cbo" class="control-label">{0} </label></span>';n+='   <span class="span8"><input id="node-join-type-cbo" class="span12"></span>';
n+="</div>";n=String.format(n,g.wfNode.joinType);var m="";m+='<div class="row-fluid control">';m+='   <span class="span4"><label for="node-svc-out-cbo" class="control-label">{0} </label></span>';m+='   <span class="span8"><input id="node-svc-out-cbo" class="span12"></span>';m+="</div>";m=String.format(m,g.wfNode.svcOut);var j="";j+='<div class="row-fluid control">';j+='   <span class="span4"><label for="node-svc-in-cbo" class="control-label">{0} </label></span>';j+='   <span class="span8"><input id="node-svc-in-cbo" class="span12"></span>';
j+="</div>";j=String.format(j,g.wfNode.svcIn);var q="";q+='<div class="row-fluid control hide">';q+='   <span class="span4"><label for="node-business-cbo" class="control-label">{0} </label></span>';q+='   <span class="span8"><input id="node-business-cbo" disabled="disabled" class="span12"></span>';q+="</div>";q=String.format(q,g.wfNode.business);var r="";r+='<div class="row-fluid control">';r+='   <span class="span4"><label for="node-screen-cbo" class="control-label">{0} </label></span>';r+='   <span class="span8"><input id="node-screen-cbo" class="span12"></span>';
r+="</div>";r=String.format(r,g.wfNode.screen);var t="";t+='<div class="row-fluid control hide">';t+='   <span class="span4"><label for="node-attribute-cbo" class="control-label">{0} </label></span>';t+='   <span class="span8"><input id="node-attribute-cbo" class="span12"></span>';t+="</div>";t=String.format(t,g.wfNode.attribute);var z="";z+='<div class="row-fluid control hide">';z+='   <div class="span12" style="display: inline-flex">';z+='      <div class="radio"><label><input id="node-value-rad" name="optionsValues" type="radio" class="ace" value=""><span class="lbl"> {0}</span></label></div>';
z+='      <div class="radio"><label><input id="node-variable-rad" name="optionsValues" type="radio" class="ace" value="$"><span class="lbl"> {1}</span></label></div>';z+='      <div class="radio"><label><input id="node-expressions-rad" name="optionsValues" type="radio" class="ace" value="express"><span class="lbl"> {2}</span></label></div>';z+="   </div>";z+="</div>";z=String.format(z,g.wfNode.value,g.wfNode.variable,g.wfNode.expressions);var J="";J+='<div class="row-fluid control hide">';J+='   <span class="span12"><textarea id="node-value-txt" class="span12" rows="7"></textarea></span>';
J+="</div>";J=String.format(J,"");var v="";v+='<div class="row-fluid control">';v+='   <span class="span4"><label for="node-attribute-cbo" class="control-label">{0} </label></span>';v+='   <span class="span3"><input id="node-time-process-txt" type="text" class="span12"></span>';v+='   <span class="span5"><input id="node-time-unit-cbo" class="span12"></span>';v+="</div>";v=String.format(v,g.wfNode.process);var s="";s+='<div id="wf-node-detail" class="wf-border wf-detail span12">';s+='  <form id="frm-node-detail">';
s+='      <div id="node-detail-div" class="wf-info">{0}{1}{13}{2}{10}{14}{15}{3}{4}{12}{11}{5}{6}{7}{8}{9}</div>';s+="  </form>";s+="</div>";s=String.format(s,d,a,l,n,q,j,m,t,z,J,e,r,v,b,h,i);var D="";D+='<div class="row-fluid control">';D+='   <span class="span4"><label for="connect-name-txt" class="control-label">{0} </label></span>';D+='   <span class="span8"><input id="connect-name-txt" class="span12" type="text"></span>';D+="</div>";D=String.format(D,g.wfConnection.name);var A="";A+='<div class="row-fluid control">';
A+='   <span class="span4"><label for="connect-priority-txt" class="control-label">{0} </label></span>';A+='   <span class="span8"><input id="connect-priority-txt" class="span12" type="text"></span>';A+="</div>";A=String.format(A,g.wfConnection.priority);var B="";B+='<div class="row-fluid control">';B+='   <span class="span4"><label for="connect-script-cbo" class="control-label">{0} </label></span>';B+='   <span class="span8"><input id="connect-script-cbo" class="span12"></span>';B+="</div>";B=String.format(B,
g.wfConnection.script);var L="";L+='<div class="row-fluid control">';L+='   <span class="span12"><textarea id="connect-script-txt" class="span12" rows="7"></textarea></span>';L+="</div>";L=String.format(L,"");var F="";F+='<div id="wf-connect-detail" class="wf-border wf-detail span12" style="display: none">';F+='   <form id="frm-connection-detail">';F+='       <div id="connection-detail-div" class="wf-info">{0}{3}{1}{2}</div>';F+="   </form>";F+="</div>";F=String.format(F,D,B,L,A);var S="";S+='<div id="wf-detail-div" class="wf-width4 hide">{0}{1}</div>';
S=String.format(S,s,F);var G="";G+='<div id="wf-design-div" class="wf-width12">';G+='   <div id="wf-design" class="wf-border wf-design span12"></div>';G+="</div>";G=String.format(G,"");var u="";u+='<div id="workflow-design-view" class="wf-design-view">';u+='  <div class="row-fluid">';u+='      <div class="span12 wf-view">{0}{1}</div>';u+="  </div>";u+="</div>";u=String.format(u,G,S);var W="";W+='<div id="workflow-design-business" class="wf-design-business">';W+='    <div id="wf-business-div"></div>';
W+="</div>";W=String.format(W,"");var ba="";ba+='<h4><i class="icon-random"></i> {0}: <span id="workflow-design-title"></span></h4>';ba=String.format(ba,g.wfConstant.title);var O="";O+='<div id="wf-node-action" class="wf-toolbar">';O+='     <a id="workflow-design-node-add" data-action="node-add" style="display: none" href="#"><i class="icon-plus"> {0}</i></a>';O+='     <a id="workflow-design-node-save" data-action="node-save" href="#"><i class="icon-save"> {1}</i></a>';O+='     <a id="workflow-design-node-del" data-action="node-delete" href="#"><i class="icon-trash"> {2}</i></a>';
O+=" </div>";O=String.format(O,g.wfNode.add,g.wfNode.save,g.wfNode["delete"]);var T="";T+='<div id="wf-connect-action" class="wf-toolbar" style="display: none">';T+='     <a id="workflow-design-conn-save" data-action="conn-save" href="#"><i class="icon-save"> {0}</i></a>';T+='     <a id="workflow-design-conn-del" data-action="conn-delete" href="#"><i class="icon-trash"> {1}</i></a>';T+=" </div>";T=String.format(T,g.wfConnection.save,g.wfConnection["delete"]);var P="";P+='<div id="wf-util-action" class="wf-toolbar">';
P+='    <a id="workflow-design-util-resize" data-action="resize" href="#"><i class="icon-resize-full"></i></a>';P+='    <a id="workflow-design-util-collapse" data-action="collapse" href="#"><i class="icon-th-list"></i></a>';P+='    <a id="workflow-design-util-business" data-action="business" href="#"><i class="icon-gears"></i></a>';P+="</div>";P=String.format(P,"");var fa="";fa+='<div id="wf-business-action" class="wf-toolbar">';fa+=" </div>";var ga='<div id="workflow-design-toolbar" class="wf-design-toolbar">{0}{4}{1}{2}{3}</div>';
ga=String.format(ga,ba,O,T,P,fa);var ha="";ha+='<div id="workflow-control" class="wf-content hide">{0}{1}{2}</div>';return ha=String.format(ha,ga,W,u)}());this.$id=$("#workflow-control");var c=this,p=null,C=null,I=null,R=false,N={uuid:null,graph:{},zone:"",context:w.context,nodeClick:false,nodes:[],node:{},nodeUuid:"",nodeUI:{},nodeAttr:[],nodeTemp:{uuid:"temp",nodeName:g.wfNode.temp,joinType:"OR",start:true,endway:false},connClick:false,conns:[],arcs:[],conn:{}};this.$mask=this.$element=this.$id;
this.owner=N;var x={loadGraph:iNet.getUrl("cloud/workflow/visualdesign"),loadNode:iNet.getUrl("cloud/workflow/member/view"),updateNode:iNet.getUrl("cloud/workflow/member/update"),createNode:iNet.getUrl("cloud/workflow/member/create"),delNode:iNet.getUrl("cloud/workflow/member/delete"),assignNode:iNet.getUrl("cloud/workflow/actor/assign"),updatePosition:iNet.getUrl("cloud/workflow/actor/update"),createNodeActor:iNet.getUrl("firmtask/actormap/create"),loadBusiness:iNet.getUrl("cloud/workflow/business"),
loadAlias:iNet.getUrl("cloud/workflow/alias/list"),loadBizRegister:iNet.getUrl("cloud/workflow/bizregister"),loadType:iNet.getUrl("onegate/application/pagelist"),loadScreen:iNet.getUrl("system/page/service"),arcCreate:iNet.getUrl("cloud/workflow/arc/create"),arcScript:iNet.getUrl("cloud/workflow/arccond/update"),arcDelete:iNet.getUrl("cloud/workflow/arc/delete"),loadScript:iNet.getUrl("cloud/workflow/script/list")},o={title:$("#workflow-design-title"),divToolbar:$("#workflow-design-toolbar"),divBusiness:$("#workflow-design-business"),
divView:$("#workflow-design-view"),businessMax:$("#wf-business-div"),businessMin:$("#wf-business-action"),design:$("#wf-design-div"),detail:$("#wf-detail-div")},K={NODEADD:$("#workflow-design-node-add"),NODESAVE:$("#workflow-design-node-save"),NODEDEL:$("#workflow-design-node-del"),ACTORADD:$("#node-actor-add"),ACTORSAVE:$("#node-actor-save"),ACTORCANCEL:$("#node-actor-cancel"),CONNSAVE:$("#workflow-design-conn-save"),CONNDEL:$("#workflow-design-conn-del")},f={nodeName:$("#node-name-txt"),nodeMultiDecision:$("#node-multiDecision-check"),
nodeActor:$("#node-actor-cbo"),nodeActorSelect:$("#node-actor-select"),nodeActorNew:$("#node-actor-new"),nodeActorCode:$("#node-actor-code"),nodeActorName:$("#node-actor-name"),nodeSvcOut:$("#node-svc-out-cbo"),nodeSvcIn:$("#node-svc-in-cbo"),nodeType:$("#node-type-cbo"),nodeJoinType:$("#node-join-type-cbo"),nodeBusiness:$("#node-business-cbo"),nodeAttribute:$("#node-attribute-cbo"),nodeScreen:$("#node-screen-cbo"),nodeRadValue:$("#node-value-rad"),nodeRadVariable:$("#node-variable-rad"),nodeRadExpressions:$("#node-expressions-rad"),
nodeValue:$("#node-value-txt"),nodeTimeProcess:$("#node-time-process-txt"),nodeTimeUnit:$("#node-time-unit-cbo"),nodeReject:$("#node-reject-check"),nodeAttrCamel:$("#node-attr-camel-check"),conName:$("#connect-name-txt"),conPriority:$("#connect-priority-txt"),conScript:$("#connect-script-cbo"),conValue:$("#connect-script-txt")},U={Resize:$("#workflow-design-util-resize"),Collapse:$("#workflow-design-util-collapse"),Business:$("#workflow-design-util-business")};U.Business.on("click",function(){var d=
U.Business.attr("data-status")||"";if(iNet.isEmpty(d)||d=="show"){o.divBusiness.hide();o.businessMin.show();U.Business.attr("data-status","hide")}else{o.divBusiness.show();o.businessMin.hide();U.Business.attr("data-status","show")}ca()});U.Resize.on("click",function(){c.fireEvent("resize");var d=$(this).find("i");console.log(">> icon >>",d)});U.Collapse.on("click",function(){M(true)});var y=function(d,a,b,e,h,i,l,n){var m=a||[],j=b||"id",q=e||1,r=iNet.isEmpty(h)?true:h,t=iNet.isEmpty(i)?false:i,z=
iNet.isEmpty(l)?{}:l,J=iNet.isFunction(n)?n:"",v={};v.id=d;v.allowClear=r;v.multiple=t;v.data={results:m,text:function(s){return iNet.isEmpty(s.name)?"":s.name}};v.idValue=function(s){return s[j]};v.initSelection=function(s,D){var A=j,B=s.val().split(",")||[],L=[],F="",S=t;if(!iNet.isEmpty(B))for(var G=0;G<B.length;G++)for(var u=0;u<m.length;u++)if(A=="id"?m[u][A].toString()==B[G].toString():m[u][A].toString()==B[G].toString()){m[u].name=iNet.isEmpty(m[u].name)?"":m[u].name;m[u].code=iNet.isEmpty(m[u].code)?
"":m[u].code;if(S)L.push(m[u]);else F=m[u];break}S?D(L):D(F)};v.formatResult=function(s){var D=iNet.isEmpty(s.code)?"":s.code,A=iNet.isEmpty(s.name)?"":s.name;s=A;var B=String.format('<span style="color: #c09853; text-align: right; padding-right: 5px"><strong>{0}<strong></strong></strong></span> {1}',D,A);return q==1?s:B};v.formatSelection=function(s){var D=iNet.isEmpty(s.code)?"":s.code,A=iNet.isEmpty(s.name)?"":s.name;s=A;var B=String.format('<label class="label label-info marg-b-0">{0}</label> {1}',
D,A);return q==1?s:B};if(!iNet.isEmpty(l))v.ajax=z;if(!iNet.isEmpty(J))v.query=n;return new iNet.ui.form.select.Select(v)},X=function(d,a){p||(p=new iNet.ui.form.Notify({delay:200}));p.setType("success");p.setTitle(d||"");p.setContent(a||"");p.show()},H=function(d,a){p||(p=new iNet.ui.form.Notify({delay:1E3}));p.setType("error");p.setTitle(d||"");p.setContent(a||"");p.show()},ca=function(){o.design.height($(window).height()-5-o.design.offset().top);o.detail.height(o.design.height());oa()},M=function(d){var a=
c.owner.nodeClick,b=c.owner.connClick,e=o.design.hasClass("wf-width8"),h=$("#wf-node-detail"),i=$("#wf-node-action"),l=$("#wf-connect-detail"),n=$("#wf-connect-action");if(a||b){if(d)if(e){o.detail.hide();o.design.removeClass("wf-width8");o.design.addClass("wf-width12")}else{o.detail.show();o.design.removeClass("wf-width12");o.design.addClass("wf-width8")}else{o.detail.show();o.design.removeClass("wf-width12");o.design.addClass("wf-width8")}e=o.design.hasClass("wf-width8");if(a&&e){h.show();i.show()}else{h.hide();
i.hide()}if(b&&e){l.show();n.show()}else{l.hide();n.hide()}}else{o.design.removeClass("wf-width8");o.design.addClass("wf-width12");o.detail.hide();h.hide();i.hide();l.hide();n.hide()}if(c.owner.graph.version=="VIEW"){i.hide();n.hide()}},E=new iNet.ui.workflow.Virtual({element:"wf-design",selector:".w-design .w"});E.on("dragstop",function(d){if(c.owner.graph.version!="VIEW"){console.log(">> node drapstop >>",d.position.left,d.position.top);var a=d.helper.attr("id"),b=d.position.top,e={task:a,x:parseInt(d.position.left),
y:parseInt(b)};c.owner.nodeUI=e;a!="temp"&&$.ajax({url:x.updatePosition,data:e,type:"POST"})}});E.on("connectionclick",function(d){if(c.owner.graph.version!="VIEW"){c.owner.nodeClick=false;c.owner.connClick=true;M(false);c.owner.nodeUuid="";c.owner.conn=d;var a=d.uuid,b={};$.each(c.owner.arcs||[],function(e,h){if(h.uuid==a){b=h;return false}});f.conName.val(b.arcName);f.conPriority.val(b.priority||0);f.conScript.setValue(b.scriptTemplateID||"");f.conValue.val(b.condition||"");if(iNet.isEmpty(b.scriptTemplateID||
""))f.conValue.show();else{f.conValue.val("");f.conValue.hide()}iNet.isEmpty(a)?f.conName.prop("readonly",false):f.conName.prop("readonly",true)}});E.on("nodeclick",function(d,a){if(c.owner.graph.version!="VIEW"){c.owner.nodeClick=true;c.owner.connClick=false;M(false);var b=$(a).prop("id");if(c.owner.nodeUuid!=b)if(b==="temp"){var e=c.owner.nodeTemp||{};e.type=$(a).attr("data-type");ia(e)}else qa(c.owner.graph.uuid,c.owner.graph.zone,b)}});E.on("connectiondragstop",function(d){if(c.owner.graph.version==
"VIEW")E.detach(d);else if(!iNet.isEmpty((d||{}).connector||"")){var a=(d||{}).sourceId||"",b=(d||{}).targetId||"";if(!iNet.isEmpty(a)&&!iNet.isEmpty(b)){var e=false;if(a==b)e=true;else{$.each(c.owner.conns||[],function(h,i){if(i.sourceId==a&&i.targetId==b)e=true});$.each(c.owner.arcs||[],function(h,i){$.each(c.owner.nodes||[],function(l,n){if(i.arcTo==n.nodeName)if(i.taskActorUUID==a&&n.uuid==b)e=true})})}e?E.detach(d):c.owner.conns.push(d)}}});var ja=function(d){var a=d||"";console.log(">> changeBusiness >>",
a);f.nodeBusiness.setValue(a);$.postJSON(x.loadBusiness,{type:a},function(b){var e=[],h=b||{};$.each(h.elements,function(n,m){e.push({id:m,code:m,name:m})});f.nodeAttribute=y("node-attribute-cbo",e,"id",1,false,false);f.nodeAttribute.on("change",function(){var n="_"+f.nodeAttribute.getValue();f.nodeValue.val("");$.each(c.owner.nodeAttr||[],function(m,j){if(n==(j||{}).id){pa(j);return false}})});var i=e[0]||{};if(iNet.isEmpty(i.id))f.nodeRadValue.prop("checked",true);else{f.nodeAttribute.setValue(i.id);
var l="_"+f.nodeAttribute.getValue();f.nodeValue.val("");$.each(c.owner.nodeAttr||[],function(n,m){if(l==(m||{}).id){pa(m);return false}})}})},ka=function(d){var a="icon-add";$.each(da||[],function(b,e){if(e.id==d){a=e.icon;return false}});return a};k=function(){var d="_"+f.nodeAttribute.getValue(),a="";if(f.nodeRadVariable.prop("checked"))a="$";else if(f.nodeRadExpressions.prop("checked"))a="express::";a+=f.nodeValue.val();var b=false;$.each(c.owner.nodeAttr||[],function(e,h){if(d==(h||{}).id){h.value=
a;b=true;return false}});console.log("__isExists >>",b);b||c.owner.nodeAttr.push({id:d,value:a})};var pa=function(d){var a=(d||{}).value||"";console.log(">> attr >>",d);if(a.indexOf("$")>=0)f.nodeRadVariable.prop("checked",true);else a.indexOf("express::")>=0?f.nodeRadExpressions.prop("checked",true):f.nodeRadValue.prop("checked",true);a=a.replace("$","");a=a.replace("express::","");f.nodeValue.val(a)},ra=[{id:"start",code:g.wfNode.typeStart,name:g.wfNode.typeStart},{id:"work",code:g.wfNode.typeWork,
name:g.wfNode.typeWork},{id:"end",code:g.wfNode.typeEnd,name:g.wfNode.typeEnd}],sa=[{id:"OR",code:"OR",name:"OR"},{id:"AND",code:"AND",name:"AND"}],da=[],Y=[],Z=[],la=[],ma=[],ta=[{id:"0",code:g.wfNode.byMinutes,name:g.wfNode.byMinutes},{id:"1",code:g.wfNode.byHours,name:g.wfNode.byHours},{id:"2",code:g.wfNode.byDay,name:g.wfNode.byDay}];f.nodeType=y("node-type-cbo",ra,"id",1,false,false);f.nodeJoinType=y("node-join-type-cbo",sa,"id",1,false,false);f.nodeActor=y("node-actor-cbo",Y,"id",1,true,true);
f.nodeSvcOut=y("node-svc-out-cbo",Z,"id",1,true,true);f.nodeSvcIn=y("node-svc-in-cbo",Z,"id",1,true,true);f.nodeBusiness=y("node-business-cbo",da,"id",1,false,false);f.nodeAttribute=y("node-attribute-cbo",[],"id",1,false,false);f.nodeScreen=y("node-screen-cbo",ma,"id",1,true,false);f.nodeTimeUnit=y("node-time-unit-cbo",ta,"id",1,true,false);f.nodeRadValue.on("change",k);f.nodeRadVariable.on("change",k);f.nodeRadExpressions.on("change",k);f.nodeValue.on("change",k);f.conScript=y("connect-script-cbo",
la,"id",1,true,false);var ua=function(d){o.divBusiness.hide();U.Business.attr("data-status","hide");var a=iNet.isFunction(d)?d.createDelegate(this):iNet.emptyFn;if(!R){R=true;$.postJSON(x.loadType,{graph:c.owner.uuid},function(b){var e=b||{};$.each(e.elements||[],function(h,i){ma.push({id:i.page,code:i.page,name:i.name||i.page});f.nodeScreen=y("node-screen-cbo",ma,"id",1,true,false)})});$.postJSON(x.loadBusiness,{},function(b){var e="";e+='<li><div id=wf-business-{0} data-id="{1}" class="circle-tile">';
e+='    <a data-code="{2}">';e+='        <div class="social-item">';e+='            <div class="social-info-wrap">';e+='                <div data-code="{3}" class="social-info">';e+='                    <div class="social-info-front social-dribbble">';e+='                        <i data-code="{4}" class="{5}"></i>';e+="                    </div>";e+="                </div>";e+="            </div>";e+="        </div>";e+="    </a>";e+='    <div class="circle-tile-content blue">';e+='        <a data-code="{6}" class="circle-tile-description" data-title="">{7}</a>';
e+="    </div>";e+="</div></li>";var h='<li><a data-id="{1}" href="#"><i class="{0}"></i> {2}</a></li>',i="<ul>",l='<div class="btn-group">';l+='<button style="border: none; background-color: transparent; color: #669fc7;" type="button" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">';l+=' <i class="icon-plus"></i> ';l+=g.wfNode.add+" "+g.wfNode.title;l+="</button>";l+='<ul class="dropdown-menu">';var n=b||{};$.each(n.elements,function(m,j){var q=(g.wfBiz[j]||
{}).name||j,r=(g.wfBiz[j]||{}).icon||"icon-gears";da.push({id:j,code:j,name:q,icon:r});i+=String.format(e,j,j,j,j,j,r,j,q);l+=String.format(h,r,j,q)});i+="</ul>";l+="</ul></div>";f.nodeBusiness=y("node-business-cbo",da,"id",1,false,false);o.businessMax.html(i);o.businessMax.find("div[data-id]").draggable();o.businessMax.find("div[data-id]").on("dragstop",function(m){console.log(">> business drapstop >>",m.clientX,m.clientY);var j=m.currentTarget.id||"";$("#"+j).css("left",0);$("#"+j).css("top",0);
var q=$("#"+j).attr("data-id")||"";c.owner.nodeTemp.type=q;c.owner.nodeTemp.icon=ka(q);K.NODEADD.trigger("click",{x:m.clientX,y:m.clientY});ja(q)});o.businessMin.html(l);o.businessMin.find("li a").on("click",function(m){console.log(">> business click >>",m.currentTarget);var j=$(m.currentTarget).attr("data-id")||"";c.owner.nodeTemp.type=j;c.owner.nodeTemp.icon=ka(j);K.NODEADD.trigger("click",{x:0,y:0});ja(j)})});$.postJSON(x.loadAlias,{zone:c.owner.zone,context:c.owner.context},function(b){var e=
b||{};$.each(e.items||[],function(h,i){Y.push({id:i.actor,code:i.actor,name:i.name})});f.nodeActor=y("node-actor-cbo",Y,"id",1,true,true)});$.postJSON(x.loadBizRegister,{},function(b){var e=b||{};$.each(e.elements||[],function(h,i){Z.push({id:i,code:i,name:i})});f.nodeSvcOut=y("node-svc-out-cbo",Z,"id",1,true,true);f.nodeSvcIn=y("node-svc-in-cbo",Z,"id",1,true,true)});$.postJSON(x.loadScript,{zone:c.owner.graph.zone},function(b){var e=b||{};$.each(e.items||[],function(h,i){la.push({id:i.uuid,code:i.uuid,
name:i.name})});f.conScript=y("connect-script-cbo",la,"id",1,true,false);f.conScript.on("change",function(){var h=f.conScript.getValue()||"";if(iNet.isEmpty(h))f.conValue.show();else{f.conValue.val("");f.conValue.hide()}})})}a()},Q=function(d,a){var b=d||c.owner.graph;c.resetData();console.log(">> reloadGraph >>",b);c.owner.graph=b;c.owner.uuid=b.uuid;$.postJSON(x.loadGraph,{graph:b.uuid,zone:b.zone},function(e){var h=e||{};if(iNet.isEmpty(h.graph)){ca();H(g.wfGraph.title,String.format(g.wfConstant.load_error,
""))}else{c.setData(h,a);ca()}},{mask:c.$mask,msg:g.wfConstant.process})},oa=function(d){var a=iNet.isEmpty(d)?100:d,b=o.title.attr("title")||"";if(b.length>a)b=b.substring(0,a)+" ....";o.title.text(b);o.divToolbar.height()>50&&oa(a-10)};this.resetData=function(){c.owner=iNet.apply(c.owner,N);E.reset();M(false)};this.setData=function(d,a){var b=d||{};o.title.attr("title",b.graph.name||"");var e=b.nodes||[];c.owner.nodes=e;for(var h=0;h<e.length;h++){var i=e[h];if((i.nodeName||"").toLowerCase()!="__blank"){b=
{};b.id=i.uuid;b.name=i.nodeName;b.start=i.start;b.endway=i.endway;b.x=i.x;b.y=i.y;b.type=i.type;b.icon=ka(i.type);if(c.owner.graph.version=="VIEW"){b.history=true;var l=$(window).height()/2;$.each(a||[],function(m,j){if(i.nodeName==j.nodeName){try{j.notePlacement=b.y>l?"top":"bottom"}catch(q){}b.historyData=j;$.each(a||[],function(r,t){if(t.created>=b.historyData.created&&i.nodeName==t.nodeName){try{t.notePlacement=b.y>l?"top":"bottom"}catch(z){}b.historyData=t}})}})}E.addNode(b);E.moveNode(i.uuid,
i.x,i.y)}}c.owner.graph.version=="VIEW"&&$('[data-toggle="popover"]').each(function(m,j){var q=$(j).attr("data-placement")||"bottom";$(j).popover({trigger:"hover",container:"body",placement:q,html:true})});var n=d.arcs||[];c.owner.conns=[];c.owner.arcs=[];$.each(d.arcs||[],function(m,j){var q=ea(j.taskActorUUID,"uuid")||{},r=ea(j.arcTo,"nodeName")||{},t=q.uuid||"",z=r.uuid||"";if(z!=t){E.connect(t,z,j.arcName,j.uuid);c.owner.arcs.push(j)}})};this.loadGraph=function(d,a){var b=d||{};c.owner.graph=
b;c.owner.uuid=b.uuid;c.owner.zone=b.zone;c.owner.context=b.context||w.context;var e=function(){c.owner.nodeClick=false;c.owner.connClick=false;o.detail.hide();o.design.removeClass("wf-width8");o.design.addClass("wf-width12");Q(d,a);c.owner.graph.version=="VIEW"&&o.divToolbar.hide()};ua(e)};var va=function(d,a,b){var e=iNet.isFunction(b)?b.createDelegate(this):iNet.emptyFn;C||(C=new iNet.ui.dialog.ModalDialog({id:iNet.generateId(),title:d||"",content:a||"",buttons:[{text:iNet.resources.message.button.ok,
cls:"btn-primary",icon:"icon-ok icon-white",fn:e},{text:iNet.resources.message.button.cancel,cls:"btn-default",icon:"icon-remove",fn:function(){this.hide()}}]}));return C},wa=function(d,a){var b=iNet.isFunction(a)?a.createDelegate(this):iNet.emptyFn,e=d||{},h=c.owner.graph.uuid||"",i=e.name||"",l=e.actor||"",n={graph:h,name:i,actor:l};console.log(">> assignNode param >>",n);!iNet.isEmpty(h)&&!iNet.isEmpty(i)&&!iNet.isEmpty(l)?$.postJSON(x.assignNode,n,function(m){var j=m||{};console.log(">> assignNode result >>",
j);i==j.nodeName?b({status:1,result:e}):b({status:0,result:e})},{mask:c.$mask,msg:g.wfConstant.process}):b({status:0,result:e})},aa=function(d,a){var b=iNet.isFunction(a)?a.createDelegate(this):iNet.emptyFn,e=d||{},h=iNet.isEmpty(e.task)?x.createNode:x.updateNode;console.log(">> saveNode param >>",e);$.postJSON(h,e,function(i){var l=i||{};console.log(">> saveNode result >>",l);if(iNet.isEmpty(l.uuid))b({status:0,result:l});else{f.nodeName.prop("readonly",true);wa(e,a)}},{mask:c.$mask,msg:g.wfConstant.process})},
qa=function(d,a,b){var e={graph:d,zone:a,task:b};$.postJSON(x.loadNode,e,function(h){var i=h||{};iNet.isEmpty(i.uuid)||ia(i)},{mask:c.$mask,msg:g.wfConstant.process})},na=function(d){var a=d||{};a.graph=c.owner.graph.uuid;a.zone=c.owner.graph.zone;a.task=a.uuid;a.actor=(a.actors||[]).toString();for(var b in a.attributes||{})a["_"+b]=a.attributes[b];delete a.actors;delete a.attributes;return a},ea=function(d,a){var b=a||"uuid",e={};$.each(c.owner.nodes||[],function(h,i){if((i[a]||"")==d){e=i||{};return false}});
return e},ia=function(d){var a=d||{};console.log(">> setNode >>",a);c.owner.nodeAttr=[];c.owner.node=a||{};c.owner.nodeUuid=a.uuid||"temp";f.nodeName.prop("readonly",a.uuid!="temp");f.nodeName.val(a.nodeName);f.nodeMultiDecision.prop("checked",a.multiDecision?true:false);var b=((c.owner.nodes||[])[a.uuid]||{}).attributes||{};f.nodeActor.setValue([(a.actors||[]).toString()]);f.nodeSvcIn.setValue([(a.svcIn||[]).toString()]);f.nodeSvcOut.setValue([(a.svcOut||[]).toString()]);f.nodeJoinType.setValue(a.joinType);
f.nodeReject.prop("checked",false);f.nodeAttrCamel.prop("checked",false);a.start?f.nodeType.setValue("start"):f.nodeType.setValue("work");ja(a.type);var e={screen:"",timeProcess:"0",timeUnit:"2",reject:"0",camel:"0"};e=iNet.apply(e,a.attributes||{});e=iNet.apply(e,b);for(var h in e)if(h=="screen")f.nodeScreen.setValue(e[h]);else if(h=="timeProcess")f.nodeTimeProcess.val(e[h]);else if(h=="timeUnit")f.nodeTimeUnit.setValue(e[h]);else if(h=="reject")e[h]=="1"?f.nodeReject.prop("checked",true):f.nodeReject.prop("checked",
false);else if(h=="camel")e[h]=="1"?f.nodeAttrCamel.prop("checked",true):f.nodeAttrCamel.prop("checked",false);else c.owner.nodeAttr.push({id:"_"+h,value:e[h]})},xa=function(){var d={joinParam:"",guard:"",zone:c.owner.graph.zone,graph:c.owner.graph.uuid,name:f.nodeName.val(),multiDecision:f.nodeMultiDecision.prop("checked"),type:f.nodeBusiness.getValue(),actor:f.nodeActor.getValue().toString(),svcIn:f.nodeSvcIn.getValue().toString(),svcOut:f.nodeSvcOut.getValue().toString()};if(!iNet.isEmpty(f.nodeScreen.getValue()))d._screen=
f.nodeScreen.getValue();if(!iNet.isEmpty(f.nodeTimeProcess.val())&&!iNet.isEmpty(f.nodeTimeUnit.getValue()))if(iNet.isNumber(Number(f.nodeTimeProcess.val()))){d._timeProcess=f.nodeTimeProcess.val();d._timeUnit=f.nodeTimeUnit.getValue()}console.log("create node reject, camel >> ",f.nodeReject.prop("checked"),f.nodeAttrCamel.prop("checked"));if(f.nodeReject.prop("checked"))d._reject="1";if(f.nodeAttrCamel.prop("checked"))d._camel="1";var a=c.owner.nodeUI;if(a.task&&a.task=="temp"){d.x=a.x;d.y=a.y}else{d.x=
c.owner.nodeTemp.x;d.y=c.owner.nodeTemp.y}d.start=true;d.endway=false;a="";for(var b=0;b<c.owner.nodeAttr.length;b++){a=c.owner.nodeAttr[b]||{};d[a.id]=a.value}var e=function(h){var i=h||{};if(i.status==0)H(g.wfNode.title,String.format(g.wfConstant.save_error,""));else i.status==1&&X(g.wfNode.title,g.wfConstant.save_success);Q()};aa(d,e)},ya=function(){var d={joinParam:"",guard:"",task:c.owner.nodeUuid,graph:c.owner.graph.uuid,zone:c.owner.graph.zone,name:f.nodeName.val(),multiDecision:f.nodeMultiDecision.prop("checked"),
joinType:f.nodeJoinType.getValue(),type:f.nodeBusiness.getValue(),actor:f.nodeActor.getValue().toString(),svcIn:f.nodeSvcIn.getValue().toString(),svcOut:f.nodeSvcOut.getValue().toString(),_screen:"",_timeProcess:"",_timeUnit:"",_reject:"0",_camel:"0"};if(!iNet.isEmpty(f.nodeScreen.getValue()))d._screen=f.nodeScreen.getValue();if(!iNet.isEmpty(f.nodeTimeProcess.val())&&!iNet.isEmpty(f.nodeTimeUnit.getValue()))if(iNet.isNumber(Number(f.nodeTimeProcess.val()))){d._timeProcess=f.nodeTimeProcess.val();
d._timeUnit=f.nodeTimeUnit.getValue()}console.log("update node reject, camel >> ",f.nodeReject.prop("checked"),f.nodeAttrCamel.prop("checked"));if(f.nodeReject.prop("checked"))d._reject="1";if(f.nodeAttrCamel.prop("checked"))d._camel="1";for(var a="",b=0;b<c.owner.nodeAttr.length;b++){a=c.owner.nodeAttr[b]||{};d[a.id]=a.value}a=f.nodeType.getValue();if(a=="start"){d.start=true;d.endway=false}else if(a=="work"){d.start=false;d.endway=false}var e=function(h){var i=h||{};if(i.status==0)H(g.wfNode.title,
String.format(g.wfConstant.save_error,""));else i.status==1&&X(g.wfNode.title,g.wfConstant.save_success);Q()};aa(d,e)};K.NODEADD.click(function(d,a){if(c.owner.graph.version!="PRODUCTION"){var b={};b.id=c.owner.nodeTemp.uuid;b.name=c.owner.nodeTemp.nodeName;b.start=c.owner.nodeTemp.start;b.endway=c.owner.nodeTemp.endway;b.x=!iNet.isEmpty(a.x)?a.x-50:c.owner.nodeTemp.x;b.y=!iNet.isEmpty(a.y)?a.y-220:c.owner.nodeTemp.y;b.type=c.owner.nodeTemp.type;b.icon=c.owner.nodeTemp.icon;if(b.x<0)b.x=0;if(b.y<
0)b.y=0;E.removeNode("temp");E.addNode(b);c.owner.nodeTemp.x=b.x;c.owner.nodeTemp.y=b.y;ia(c.owner.nodeTemp);c.owner.nodeClick=true;c.owner.connClick=false;M(false)}});K.NODESAVE.click(function(){var d=[];if(iNet.isEmpty(f.nodeName.val())){f.nodeName.focus();d.push(String.format(g.wfConstant.is_not_blank,g.wfNode.name))}if(iNet.isEmpty(f.nodeActor.getValue().toString()))d.push((d.length>0?"<br/>":"")+String.format(g.wfConstant.is_not_blank,g.wfNode.actor));var a=f.nodeName.val().trim().toLowerCase();
$.each(c.owner.nodes||[],function(b,e){if(e.nodeName.trim().toLowerCase()==a&&c.owner.nodeUuid!=e.uuid){d.push((d.length>0?"<br/>":"")+String.format(g.wfConstant.is_exists,g.wfNode.name));return false}});if(d.length>0)H(g.wfNode.title,String.format("{0}",d));else c.owner.nodeUuid=="temp"?xa():ya()});K.NODEDEL.click(function(){if(c.owner.nodeUuid=="temp"){E.removeNode(c.owner.nodeUuid);c.owner.nodeClick=false;M(false)}else{var d=0;if(c.owner.nodes.length>0)$.each(c.owner.nodes||[],function(b,e){var h=
e||{};h.start&&d++});if(d==1&&c.owner.node.start)H(g.wfNode.title,g.wfConstant.can_not_del_all_nodes_start);else{var a=va(g.wfNode.title,"Content",function(){var b={graph:c.owner.graph.uuid,zone:c.owner.graph.zone,task:c.owner.nodeUuid};$.postJSON(x.delNode,b,function(e){var h=e||{};if(iNet.isEmpty(h.uuid))H(g.wfNode.title,String.format(g.wfConstant.delete_error,""));else{c.owner.nodeClick=false;M(false);Q();X(g.wfNode.title,g.wfConstant.delete_success);a.hide()}},{mask:c.$mask,msg:g.wfConstant.process})});
a.setContent(String.format(g.wfConstant.delete_confirm,c.owner.node.nodeName));a.show()}}});K.ACTORADD.click(function(){f.nodeActorNew.show();f.nodeActorSelect.hide();f.nodeActorCode.val("actor"+iNet.generateId().substring(0,6));f.nodeActorName.val("")});K.ACTORCANCEL.click(function(){f.nodeActorSelect.show();f.nodeActorNew.hide()});K.ACTORSAVE.click(function(){var d={};d.zone=c.owner.zone;d.context=c.owner.context;d.actor=f.nodeActorCode.val();d.name=f.nodeActorName.val();iNet.isEmpty(d.actor)||
iNet.isEmpty(d.name)||$.postJSON(x.createNodeActor,d,function(a){var b=a||{};if(iNet.isEmpty(b.uuid))H(g.wfNode.title,String.format(g.wfConstant.load_error,""));else{f.nodeActorSelect.show();f.nodeActorNew.hide();$.postJSON(x.loadAlias,{zone:c.owner.zone,context:c.owner.context},function(e){var h=e||{};$.each(h.items||[],function(l,n){Y.push({id:n.actor,code:n.actor,name:n.name})});f.nodeActor=y("node-actor-cbo",Y,"id",1,true,true);var i=f.nodeActor.getValue()||[];i.push(f.nodeActorCode.val());f.nodeActor.setValue([(i||
[]).toString()])})}})});var za=function(d,a,b){var e=iNet.isFunction(b)?b.createDelegate(this):iNet.emptyFn;I||(I=new iNet.ui.dialog.ModalDialog({id:iNet.generateId(),title:d||"",content:a||"",buttons:[{text:iNet.resources.message.button.ok,cls:"btn-primary",icon:"icon-ok icon-white",fn:e},{text:iNet.resources.message.button.cancel,cls:"btn-default",icon:"icon-remove",fn:function(){this.hide()}}]}));return I},Aa=function(d){var a=d||{};console.log(">> assignScript data >>",a);var b=function(e){var h=
e||{};if(iNet.isEmpty(h.condition)&&iNet.isEmpty(h.script)){X(g.wfConnection.title,g.wfConstant.save_success);Q()}else $.postJSON(x.arcScript,{condition:h.condition,scriptTemplateID:h.scriptTemplateID,arc:h.arc,priority:h.priority},function(i){var l=i||{};if(l.type=="ERROR"){var n=[];$.each(l.errors||[],function(m,j){n.push(j.message)});H(g.wfConnection.title,String.format("{0}",n))}else X(g.wfConnection.title,g.wfConstant.save_success);Q()})};iNet.isEmpty(a.uuid)?$.postJSON(x.loadGraph,{graph:a.graph,
zone:a.zone},function(e){var h=e||{},i=h.arcs||[];console.log(">> assignScript result >>",i);$.each(i,function(l,n){if(n.arcName==a.label){b({condition:a.condition,scriptTemplateID:a.script,arc:n.uuid,priority:a.priority});return false}})},{mask:c.$mask,msg:g.wfConstant.process}):b({condition:a.condition,scriptTemplateID:a.script,arc:a.uuid,priority:a.priority})},V=function(d,a){var b=iNet.isFunction(a)?a.createDelegate(this):iNet.emptyFn,e=d||{},h=x.arcCreate;console.log(">> saveConn param >>",e);
if(iNet.isEmpty(e.uuid))$.postJSON(h,e,function(i){var l=i||{};console.log(">> saveConn result >>",l);if(iNet.isEmpty(l.uuid))b({status:0,result:l});else{f.conName.prop("readonly",true);b({status:1,result:l})}},{mask:c.$mask,msg:g.wfConstant.process});else{f.conName.prop("readonly",true);b({status:1,result:{}})}};K.CONNSAVE.click(function(){var d=c.owner.conn,a=[],b=f.conName.val();b=b.replace(/,/gi,"");if(iNet.isEmpty(b)){f.conName.focus();a.push(String.format(g.wfConstant.is_not_blank,g.wfConnection.name))}$.each(c.owner.arcs||
[],function(q,r){if(r.arcName.trim().toLowerCase()==b.trim().toLowerCase()&&d.sourceId==r.taskActorUUID&&r.uuid!=d.uuid){a.push((a.length>0?"<br/>":"")+String.format(g.wfConstant.is_exists,g.wfConnection.name));return false}});if(d.sourceId=="temp"||d.targetId=="temp")a.push(g.wfConstant.can_not_create_connection_node_temp);if(a.length>0)H(g.wfConnection.title,String.format("{0}",a));else{var e={uuid:c.owner.conn.uuid,graph:c.owner.graph.uuid,zone:c.owner.graph.zone,label:b,from:d.sourceId,to:d.targetId,
priority:iNet.isNumber(Number(f.conPriority.val()||0))?Number(f.conPriority.val()||0):0,condition:f.conValue.val(),script:f.conScript.getValue()},h=function(q){var r=q||{};if(r.status==0){Q();H(g.wfConnection.title,String.format(g.wfConstant.save_error,""))}else r.status==1&&Aa(e)},i=ea(d.sourceId,"uuid")||{},l=ea(d.targetId,"uuid")||{};if(l.start){var n=na(l||{});n.start=false;var m=function(q){var r=q||{};if(r.status==0)V(e,h);else if(r.status==1)if(i.start)V(e,h);else{var t=false;$.each(c.owner.arcs||
[],function(z,J){if(J.arcTo.toString().toLowerCase()==i.nodeName.toString().toLowerCase()){t=true;return false}});if(t)V(e,h);else{n=na(i||{});n.start=true;aa(n,m)}}};aa(n,m)}else if(i.start)V(e,h);else{var j=false;$.each(c.owner.arcs||[],function(q,r){if(r.arcTo.toString().toLowerCase()==i.nodeName.toString().toLowerCase()){j=true;return false}});if(j)V(e,h);else{n=na(i||{});n.start=true;m=function(q){var r=q||{};if(r.status==0)V(e,h);else r.status==1&&V(e,h)};aa(n,m)}}}});K.CONNDEL.click(function(){if(iNet.isEmpty(c.owner.conn.uuid)){$.each(c.owner.conns||
[],function(e,h){h.sourceId==c.owner.conn.sourceId&&h.targetId==c.owner.conn.targetId&&c.owner.conns.splice(c.owner.conns.indexOf(h),1)});E.detach(c.owner.conn);c.owner.connClick=false;M(false)}else{var d=c.owner.conn.uuid||"",a={};$.each(c.owner.arcs||[],function(e,h){if(h.uuid==d){a=h;return false}});var b=za(g.wfConnection.title,"Content",function(){var e={from:c.owner.conn.sourceId,to:c.owner.conn.targetId,graph:c.owner.graph.uuid,zone:c.owner.graph.zone};$.postJSON(x.arcDelete,e,function(h){var i=
h||{};if(iNet.isEmpty(i.uuid))H(g.wfConnection.title,String.format(g.wfConstant.delete_error,""));else{c.owner.connClick=false;M(false);Q();X(g.wfConnection.title,g.wfConstant.delete_success);b.hide()}},{mask:c.$mask,msg:g.wfConstant.process})});b.setContent(String.format(g.wfConstant.delete_confirm,a.arcName));b.show()}});$(window).on("resize",function(){ca()});c.hide()};iNet.extend(iNet.ui.workflow.Workflow,iNet.Component,{constructor:iNet.ui.workflow.Workflow,version:"1.0",resetData:function(){this.resetData()},
loadGraph:function(k){this.loadGraph(k)},getOwner:function(){return this.owner},show:function(){this.$id.show()},hide:function(){this.$id.hide()}})});