$(function(){iNet.ns("iNet.ui.xgate","iNet.ui.xgate.BfProcess");iNet.ui.xgate.BfProcess=function(M){this.id="briefcase-process-div";var O=M||{},e=this,H=null,L={external:function(){var a="";a+='<ul style="list-style-type: none; margin-left: 0;">';a+=' <div class="dd" style="max-width: 100%; padding-right: 10px;">';a+='     <ol class="dd-list">';a+='         <li class="dd-item dd2-item" data-id="15">';a+='             <button data-action="collapse" data-css="dd-collapsed" type="button" style="display: block;">collapse</button>';
a+='             <button data-action="expand" data-css="dd-collapsed" type="button" style="display: none;">expand</button>';a+='             <div class="dd-handle dd2-handle" style="height: 100%;">';a+='                 <i class="normal-icon ace-icon fa fa-user blue bigger-130"></i>';a+='                 <i class="drag-icon ace-icon fa fa-arrows bigger-125"></i>';a+="             </div>";a+='             <div class="dd2-content">{0}</div>';a+="         </li>{1}";a+="     </ol>";a+=" </div>";a+="</ul>";
return a},attachment:function(){var a="";a+='<ol class="dd-list" style="">';a+=' <li class="dd-item dd2-item" data-id="16">';a+='     <div class="dd-handle dd2-handle" style="height: 100%;">';a+='         <i class="normal-icon ace-icon fa fa-file orange bigger-130"></i>';a+='         <i class="drag-icon ace-icon fa fa-arrows bigger-125"></i>';a+="     </div>";a+='     <div class="dd2-content" style="display: flex;">';a+="         <div>{1}</div>";a+='         <div style="margin-left: 8px;" class="pull-right action-buttons">';
a+='             <a data-action="deletefile" title="" data-request="{2}" data-file="{1}" data-id="{0}" class="red" href="#">';a+='                 <i class="icon-trash bigger-130"></i>';a+="             </a>";a+="         </div>";a+='         <div style="margin-left: 8px;" class="pull-right action-buttons hide">';a+='             <a data-action="verifyfile" title="" data-request="{2}" data-file="{1}" data-id="{0}"class="orange" href="#">';a+='                 <i class="icon-key bigger-130"></i>';
a+="             </a>";a+="         </div>";a+='         <div style="margin-left: 8px;" class="pull-right action-buttons hide">';a+='             <a data-action="viewfile" title="" data-request="{2}" data-file="{1}" data-id="{0}" class="green" href="#">';a+='                 <i class="ace-icon fa fa-eye bigger-130"></i>';a+="             </a>";a+="         </div>";a+='         <div style="margin-left: 8px;" class="pull-right action-buttons hide">';a+='             <a data-action="downfile" title="" data-request="{2}" data-file="{1}" data-id="{0}" class="blue" href="#">';
a+='                 <i class="ace-icon fa fa-download bigger-130"></i>';a+="             </a>";a+="         </div>";a+="     </div>";a+=" </li>";a+="</ol>";return a}},f={task:iNet.resources.task.task,BfProcess:iNet.resources.xgate.BfProcess,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},r={executor_task:iNet.getUrl("firmtask/process/executor"),update_task:iNet.getUrl("firmtask/process/additional"),reject_task:iNet.getUrl("firmtask/process/reject"),
late_task:iNet.getUrl("firmtask/process/latemark"),comment_task:iNet.getUrl("firmtask/comment/create"),photo:iNet.getUrl("system/userprofile/photo"),task_toolbar:iNet.getUrl("cloud/workflow/ruleengine"),task_toolbar_actor:iNet.getUrl("cloud/workflow/arc2node"),load_user:iNet.getUrl("system/account/role"),external_upload:iNet.getUrl("onegate/externaldata/upload"),external_reqload:iNet.getUrl("onegate/externaldata/reqload"),external_list:iNet.getUrl("onegate/externaldata/list"),external_remove:iNet.getUrl("onegate/externaldata/delete")},
F=iNet.getLayout().window.parent.taskMenu;F.on("menuchange",function(){});F.on("create",function(){});var u=iNet.getLayout().window.taskFrame;u.on("typechange",function(a){a=="min"?b.setMenuButton(true):b.setMenuButton(false)});var v=new iNet.ui.modalview;v.on("success",function(){this.hide();u.refresh();F.refresh("task")});var I=function(){b.reset();var a=u.getTaskDataIndex(),g=((a||{}).history||{}).taskID||"",d=((a||{}).history||{}).graphID||"",h=((a||{}).request||{}).status||"",n=((a||{}).request||
{}).uuid||"";n!=""&&$.postJSON(r.external_list,{taskRequestID:n},function(o){var l=o||{};b.dataContent.$additionalView.html("");if(CommonService.isSuccess(l)){var y="",D=l.externalData||[];$.each(D,function(s,c){var t=c||{};if(t.creatorCode==iNet.usercode){var A=t.attachments||[],p="";$.each(A,function(i,j){var m=j||{};p+=String.format(L.attachment(),m.uuid,m.file,l.uuid)});var w=t.description+" ("+(new Date(t.completed)).format("h:i d/m/Y")+")";y+=String.format(L.external(),w,p)}});b.dataContent.$additionalView.append(y);
b.dataContent.$additionalView.on("click","[data-action]",function(){var s=$(this).attr("data-action"),c=$(this).attr("data-id"),t=$(this).attr("data-file"),A=$(this).attr("data-request");if(s=="deletefile")if(c!=""){e.confirmDialog(f.constant.del_title,e.getNotifyContent(f.constant.del_content,t),function(){$.postJSON(r.external_remove,e.dialog.getOptions(),function(w){e.dialog.hide();if((w||{}).uuid=="SUCCESS")I()})});e.dialog.setContent(e.getNotifyContent(f.constant.del_content,t));e.dialog.setOptions({taskRequestID:A,
attachID:c});e.dialog.show()}if(s=="collapse"||s=="expand"){var p=$(this).parent().parent();if(p.hasClass("dd-collapsed")){p.removeClass("dd-collapsed");p.find('[data-action="collapse"]').css("display","block");p.find('[data-action="expand"]').css("display","none")}else{p.addClass("dd-collapsed");p.find('[data-action="collapse"]').css("display","none");p.find('[data-action="expand"]').css("display","block")}}})}});if(h=="SUBMITTED"||h=="UPDATE"){$("#briefcase-process-additional-attachment-list").html("");
$("#briefcase-process-additional-attachment-description").val("");b.toolbar.$taskExecutorBtn.attr("direction","");var k=function(o,l,y,D){b.setDataContent("view");var s=o||"",c=l||"",t=y||"",A=D||"";b.dataContent.$process.find('[data-action="rule"]').html(s);b.dataContent.$process.find('[data-action="execute"]').html(c);b.dataContent.$process.find('[data-action="plugin"]').html(t);b.dataContent.$process.find('[data-action="function"]').html(A);b.dataContent.$process.find('[data-action="note"]').on("change",
function(i){b.toolbar.$taskCompletedBtn.attr("note",$(i.currentTarget).val());b.toolbar.$taskExecutorBtn.attr("note",$(i.currentTarget).val())});b.dataContent.$process.find('[data-action="noteLate"]').on("change",function(i){b.toolbar.$taskCompletedBtn.attr("noteLate",$(i.currentTarget).val());b.toolbar.$taskExecutorBtn.attr("noteLate",$(i.currentTarget).val())});b.dataContent.$process.find('[data-action="check"]').on("change",function(){var i="";b.dataContent.$process.find('[data-action="check"]').each(function(j,
m){$(m).find('[data-action="member"]').attr("checked",$(m).find("[type]").prop("checked"));if($(m).find("[type]").prop("checked")){var x=$(m).attr("direction")||"";i+=x+","}});b.toolbar.$taskExecutorBtn.attr("direction",i)});var p=b.dataContent.$process.find('[data-action="check"]').length;p>=1&&b.dataContent.$process.find('[data-action="check"] input[type]:first').trigger("click");var w=function(){b.dataContent.$process.find('[data-action="memberselect"]').on("change",function(i){var j=$(i.currentTarget).attr("task"),
m=$(i.currentTarget).attr("direction")||"";i=b.dataContent.$process.find('[data-action="memberselect"][task="'+j+'"][direction="'+m+'"]');var x=b.dataContent.$process.find('[data-action="memberinfo"][task="'+j+'"][direction="'+m+'"]'),q="";x.text("");i.each(function(K,B){if($(B).prop("checked"))q+=($(B).attr("data-member-name")||"")+"; "});if(!iNet.isEmpty(q)){q=" ("+q.substring(0,q.length-2)+")";x.text(q)}})};b.dataContent.$process.find('[data-action="member"]').on("click",function(i){b.dataContent.$process.find('[data-action="memberview"]').hide();
var j=$(i.currentTarget).attr("task"),m=$(i.currentTarget).attr("direction")||"";$.postJSON(r.task_toolbar_actor,{task:j,direction:m},function(x){var q="";q+="<tr>";q+="<td>";q+='<label class="checkbox">';q+='<input data-action="memberselect" data-member="{0}" data-member-name="{2}" data-nodeName="{1}" exists="1" task="'+j+'" direction="'+m+'" type="checkbox" class="ace"><span class="lbl"></span>';q+="</label>";q+="</td>";q+="<td>{2}</td>";q+="</tr>";var K=x||{},B=b.dataContent.$process.find('[data-action="memberlist"][task="'+
j+'"][direction="'+m+'"]');x=b.dataContent.$process.find('[data-action="memberinfo"][task="'+j+'"][direction="'+m+'"]');B.find("[data-member]").attr("exists","0");x.text("");var E="";$.each(K.members||[],function(N,J){var G=J||{};B.find('[data-member="'+J+'"]').length<=0?B.append(String.format(q,G.usercode,K.nodeName,G.username)):B.find('[data-member="'+G.usercode+'"]').attr("exists","1");if(B.find('[data-member="'+G.usercode+'"]').prop("checked"))E+=G.usercode+"; "});if(!iNet.isEmpty(E)){E=" ("+
E.substring(0,E.length-2)+")";x.text(E)}B.find('[data-member][exists="0"]').each(function(N,J){$(J).parent().parent().parent().remove()});w();b.dataContent.$process.find('[data-action="memberview"][task="'+j+'"][direction="'+m+'"]').show()})});b.dataContent.$process.find('[data-action="memberclose"]').on("click",function(i){var j=$(i.currentTarget).attr("task"),m=$(i.currentTarget).attr("direction")||"";b.dataContent.$process.find('[data-action="memberview"]').hide()})};switch(h){case "UPDATE":var z=
"",C="";z+='<span class="alert alert-danger bold span12">'+f.task.updateWarning+"</span>";b.dataContent.$process.find('[data-action="description"]').hide();b.dataContent.$process.find('[data-action="exclusive"]').hide();k(z,C);break;case "SUBMITTED":b.dataContent.$process.find('[data-action="description"]').show();b.dataContent.$process.find('[data-action="exclusive"]').show();$.postJSON(r.task_toolbar,{task:g,graph:d},function(o){console.log(">> get_task_toolbar result >>",o);var l=o||{},y=l||{},
D=l.content||"",s="",c="",t="",A=false,p="",w=y.lines||{},i=y.multiDecision||false,j;for(j in w){A=true;if(w[j])p+=j+",";c+='<div class="row-fluid">';c+='<span class="span12" data-action="check" task="'+g+'" direction="'+j+'">';c+="<label "+(i?"":'class="radio"')+">";c+='<span title="'+f.task.memberSelect+'" data-action="member" task="'+g+'" direction="'+j+'" style="padding-right: 10px; padding-top: 5px; padding-bottom: 5px;">';c+='<i class="icon-user" style="border: 1px solid #DDD;padding: 5px;border-radius: 15px;"></i>';
c+="</span>";c+='<input type="'+(i?"checkbox":"radio")+'" name="'+("multiDecision_"+i)+'" class="ace" value="" '+(w[j]<=0?"":'checked="checked"')+'">';c+='<span class="lbl"> '+j+"</span>";c+='<span class="lbl" data-action="memberinfo" task="'+g+'" direction="'+j+'"></span>';c+="</label>";c+="</span>";c+="</div>";c+='<div class="row-fluid">';c+='<span class="span12 hide" data-action="memberview" task="'+g+'" direction="'+j+'">';c+='<table class="table table-bordered">';c+="<thead>";c+="<tr>";c+='<th><i style="cursor: pointer;" class="icon-remove-sign" data-action="memberclose" task="'+
g+'" direction="'+j+'"></i></th>';c+="<th>"+f.task.memberName+"</th>";c+="</tr>";c+="</thead>";c+='<tbody data-action="memberlist" task="'+g+'" direction="'+j+'">';c+="</tbody>";c+="</table>";c+="</span>";c+="</div>"}if(A){b.toolbar.$taskExecutorBtn.show();b.toolbar.$taskCompletedBtn.hide()}else{b.toolbar.$taskCompletedBtn.show();b.toolbar.$taskExecutorBtn.hide()}$.each(l.toolbar||[],function(m,x){s+='<button onclick="eval('+x["function"]+'())" '+(m==0?"":'style="margin-left: 5px;"')+' class="btn btn-primary">';
s+='<i class="icon-ok-sign"></i> '+(x.label||"");s+="</button>"});k(c,t,D,s)},{mask:e.getMask(),msg:iNet.resources.ajaxLoading.loading})}}},b=new iNet.ui.itemview({id:"briefcase-process",resource:f,url:r,toolbar:function(){this.id="briefcase-process-toolbar";this.intComponent=function(){var a=u.getTaskDataIndex();this.$taskToolbar=$("#briefcase-process-task-toolbar");this.$additionalToolbar=$("#briefcase-process-additional-toolbar");this.$backBtn=$("#briefcase-process-back-btn");this.$backBtn.on("click",
function(){e.fireEvent("back");if(H!=null){H.show();e.hide()}}.createDelegate(this));this.$additionalUploadBtn=$("#briefcase-process-additional-upload-btn");this.$additionalUploadBtn.on("click",function(){var d=this;$(d).attr("disabled","disabled");var h=u.getTaskDataIndex(),n=((h||{}).history||{}).taskID||"",k=((h||{}).history||{}).graphID||"",z=((h||{}).request||{}).uuid||"";if(iNet.isEmpty($("#briefcase-process-additional-attachment-description").val())){$(d).removeAttr("disabled");e.notifyError(f.constant.warning_title,
f.task.description)}else{var C=false;$("#briefcase-process-additional-attachment-list").find('[type="file"]').each(function(o,l){if(!iNet.isEmpty($(l).val())){C=true;return false}});if(C){$("#"+b.ajaxMaskId).show();FormService.appendHiddenField(b.dataContent.$form,"task",n);FormService.appendHiddenField(b.dataContent.$form,"graph",k);b.dataContent.$form.ajaxSubmit({url:r.external_upload,beforeSubmit:function(){},uploadProgress:function(){},success:function(){},complete:function(o){$(d).removeAttr("disabled");
$("#"+b.ajaxMaskId).hide();var l=o.responseJSON||{},y=o.responseText||{};if(CommonService.isSuccess(l.request||{})){e.notifySuccess(f.constant.submit_title,f.constant.submit_success);I()}else e.notifyError(f.constant.submit_title,e.getNotifyContent(f.constant.submit_error,l.errors||[]))}})}else $.postJSON(r.comment_task,{task:z,note:$("#briefcase-process-additional-attachment-description").val()},function(o){$(d).removeAttr("disabled");var l=o||{};if(CommonService.isSuccess(l)){e.notifySuccess(f.constant.submit_title,
f.constant.submit_success);I()}else e.notifyError(f.constant.submit_title,e.getNotifyContent(f.constant.submit_error,l.errors||[]))},{mask:e.getMask(),msg:iNet.resources.ajaxLoading.processing})}});this.$taskCompletedBtn=$("#briefcase-process-completeTask-btn");this.$taskCompletedBtn.on("click",function(){var d=u.getTaskDataIndex(),h=((d||{}).history||{}).taskID||"",n=((d||{}).history||{}).expiredTask||0,k=$(this).attr("direction")||"",z=$(this).attr("note")||"",C=$(this).attr("noteLate")||"",o=function(){k=
k.substr(0,k.length-1);var l={task:h,direction:k,note:z,exclusive:b.dataContent.$exclusive.getValue().toString()};$.postJSON(r.executor_task,l,function(){u.refresh();F.refresh("task")},{mask:e.getMask(),msg:iNet.resources.ajaxLoading.loading})};if((new Date).getTime()>n&&n>0){b.dataContent.$noteLate.show();iNet.isEmpty(C)?e.notifyError(f.constant.warning_title,e.getNotifyContent(f.validate.is_not_blank,f.task.noteLate)):$.postJSON(r.late_task,{task:h,reason:C},function(){o()},{mask:e.getMask(),msg:iNet.resources.ajaxLoading.loading})}else{b.dataContent.$noteLate.hide();
o()}});this.$taskExecutorBtn=$("#briefcase-process-executorTask-btn");this.$taskExecutorBtn.on("click",function(){var d=u.getTaskDataIndex(),h=((d||{}).history||{}).taskID||"",n=((d||{}).history||{}).expiredTask||0,k=$(this).attr("direction")||"",z=$(this).attr("note")||"",C=b.dataContent.$exclusive!=null?b.dataContent.$exclusive.getValue().toString()||"":"",o=$(this).attr("noteLate")||"",l=function(){k=k.substr(0,k.length-1);var y="",D=[];$(k.split(",")).each(function(c,t){b.dataContent.$process.find('[data-action="memberlist"][task="'+
h+'"][direction="'+t+'"] [data-action="memberselect"]').each(function(A,p){if($(p).prop("checked")){var w=$(p).attr("data-member")||"",i=$(p).attr("data-nodeName")||"";D.push({username:w,role:"",direction:t,nodeName:i});y+=w+","}})});var s={task:h,direction:k,note:z,exclusive:C,member:iNet.JSON.encode(D)};console.log(">> __fnExecutor __params >>",s);iNet.isEmpty(k)||$.postJSON(r.executor_task,s,function(){u.refresh();F.refresh("task")},{mask:e.getMask(),msg:iNet.resources.ajaxLoading.loading})};if((new Date).getTime()>
n&&n>0){b.dataContent.$noteLate.show();iNet.isEmpty(o)?e.notifyError(f.constant.warning_title,e.getNotifyContent(f.validate.is_not_blank,f.task.noteLate)):$.postJSON(r.late_task,{task:h,reason:o},function(){l()},{mask:e.getMask(),msg:iNet.resources.ajaxLoading.loading})}else{b.dataContent.$noteLate.hide();l()}});this.$taskUpdateBtn=$("#briefcase-process-updateTask-btn");this.$taskUpdateBtn.on("click",function(){var d=u.getTaskDataIndex(),h=((d||{}).history||{}).taskID||"";v.setTitle($(this).text());
v.setDescription(f.task.updateDescription);v.setParams({task:h});v.setUrl(r.update_task);v.show()});this.$taskUpdateBtn.hide();this.$taskRejectBtn=$("#briefcase-process-rejectTask-btn");this.$taskRejectBtn.on("click",function(){var d=u.getTaskDataIndex(),h=((d||{}).history||{}).processUUID||"",n=((d||{}).history||{}).taskID||"",k=((d||{}).history||{}).graphID||"";v.setTitle($(this).text());v.setDescription(f.task.rejectDescription);v.setParams({process:h});v.setAdditional(r.external_upload,{task:n,
graph:k});v.setUrl(r.reject_task);v.show()});var g=(((a||{}).history||{}).attributes||{}).reject||"0";g=="1"?this.$taskRejectBtn.show():this.$taskRejectBtn.hide()}},dataContent:function(){this.id="briefcase-process-data-content";this.intComponent=function(){var a=this;this.$additionalView=$("#briefcase-process-additional-attachment-view");this.$additionalAddBtn=$("#briefcase-process-additional-attachment-add");this.$tab=$('a[data-toggle="tab"]');this.$process=$("#briefcase-process-form-content");
this.$exclusive=FormService.createSelect("briefcase-process-exclusive",[],"id",1,true,true);$.postJSON(r.load_user,{},function(g){var d=g||{};if(CommonService.isSuccess(d)){var h=[];$.each(d.items||[],function(n,k){h.push({id:k.username,code:k.username,name:k.fullname})});a.$exclusive=FormService.createSelect("briefcase-process-exclusive",h,"id",1,true,true)}});this.$noteLate=$("#briefcase-process-noteLate");this.$form=$("#briefcase-process-additional-form");this.$tab.on("shown.bs.tab",function(g){if($(g.target).attr("href")==
"#tab-process-additional"){b.toolbar.$additionalToolbar.show();b.toolbar.$taskToolbar.hide()}else{var d=false;iNet.isEmpty($("#briefcase-process-additional-attachment-description").val())||(d=true);$("#briefcase-process-additional-attachment-list").find('[type="file"]').each(function(k,z){if(!iNet.isEmpty($(z).val())){d=true;return false}});d&&e.notifyError(f.constant.warning_title,f.task.additionalwarningsave);b.toolbar.$additionalToolbar.hide();b.toolbar.$taskToolbar.show();var h=u.getTaskDataIndex(),
n=((h||{}).history||{}).expiredTask||0;(new Date).getTime()>n&&n>0?b.dataContent.$noteLate.show():b.dataContent.$noteLate.hide()}});this.$additionalAddBtn.on("click",function(){var g="";g+='<div class="row-fluid">';g+='    <label class="span2">'+f.task.attachment+"</label>";g+='    <div class="ace-file-input span10" data-container data-name="{0}">';g+='         <label data-title="Click here" class="ace-file-container file-label">';g+='             <span data-title="..." class="ace-file-name file-name"><i class="icon-upload-alt ace-icon"></i></span>';
g+="         </label>";g+='         <a data-remove data-name="{0}" class="remove" href="#"><i class=" ace-icon fa fa-times"></i></a>';g+="    </div>";g+='    <input type="file" name="{0}" style="display:none;" data-file data-name="{0}"/>';g+="</div>";var d=iNet.generateId();$("#briefcase-process-additional-attachment-list").append(String.format(g,d));$('#briefcase-process-additional-attachment-list [data-file][data-name="'+d+'"]').on("change",function(){console.log(">>data-file>> click");if(this.files.length<
1)this.files=[];else{var h=$(this).attr("data-name"),n=this.files[0].name;$(this).parent().find("span[data-title]").attr("data-title",n);$(this).parent().find(".ace-file-container").addClass("selected")}});$('#briefcase-process-additional-attachment-list [data-remove][data-name="'+d+'"]').on("click",function(){$(this).parent().parent().remove()});$('#briefcase-process-additional-attachment-list [data-container][data-name="'+d+'"]').on("click",function(){console.log(">>data-container>> click",$(this).attr("data-name"));
var h=$(this).attr("data-name");$('#briefcase-process-additional-attachment-list [data-file][data-name="'+h+'"]').trigger("click")});$('#briefcase-process-additional-attachment-list [data-file][data-name="'+d+'"]').trigger("click")})}},ajaxMaskId:"ajax-mask",headerDetails:{subject:"briefcase-process-subject-details",sender:"briefcase-process-sender-details"}});b.on("menuclick",function(){u.setListTaskType("menu")});this.load=function(){I()};this.setPageBack=function(a,g){H=a;H!=null&&g!=false?b.toolbar.$backBtn.show():
b.toolbar.$backBtn.hide()};this.setType=function(a){$("#"+e.id+' [data-id="item-view-control"].item-view').removeClass("full").addClass(a)};iNet.ui.xgate.BfProcess.superclass.constructor.call(this)};iNet.extend(iNet.ui.xgate.BfProcess,iNet.ui.app.widget)});