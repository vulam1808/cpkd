$(function(){iNet.ns("iNet.ui.admin");iNet.ui.admin.ProcedureDetailWidget=function(d){var c=d||{};iNet.apply(this,c);this.id=this.id||"procedure-detail-widget";iNet.ui.admin.ProcedureDetailWidget.superclass.constructor.call(this);var a=this;this.$toolbar={CREATE:$("#procedure-btn-create"),SAVE:$("#procedure-btn-save"),BACK:$("#procedure-btn-back")};this.resource={procedure:iNet.resources.xgate.admin.procedure,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate};
var f=null;this.$filesContainer=$("#procedure-files-container");this.$infoContainer=$("#procedure-info-container");this.$form=$("#procedure-frm-detail");this.$file=$("#procedure-files");this.$fileLabel=$("#procedure-files-label");this.$fileRemove=$("#procedure-files-remove");this.$btnCollapse=$("#procedure-info-collapse");this.$input={industry:$("#procedure-select-industry"),level:$("#procedure-select-level"),subject:$("#procedure-txt-subject"),code:$("#procedure-txt-code"),content:$("#procedure-txt-content"),
hours:$("#procedure-txt-hours"),isPostOffice:$("#procedure-chk-isPostOffice"),maxTimeWait:$("#procedure-txt-maxTimeWait"),serviceLevel3:$("#procedure-chk-servicel3"),serviceLevel4:$("#procedure-chk-servicel4")};this.industrySelect=new iNet.ui.form.select.Select({id:this.$input.industry.prop("id"),formatResult:function(b){var g=b||{},e=g.children||[],i=$(g.element).data("pattern")||"__:__";if(e.length>0)return String.format('<span class="badge badge-warning"><i class="icon-book"></i></span> {0}',g.text);
return String.format('<span class="label label-info">{0}</span> {1}',i,g.text)},formatSelection:function(b){var g=b||{},e=$(g.element).data("pattern")||"__:__";return String.format('<span class="label label-info" style="height: auto !important;">{0}</span> {1}',e,g.text)}});this.industrySelect.on("change",function(){var b=a.industrySelect.getData(),g=$(b.element);a.$input.code.val(g.data("pattern"))});this.levelSelect=new iNet.ui.form.select.Select({id:this.$input.level.prop("id"),formatResult:function(b){var g=
b||{};return String.format('<span><i class="icon-building"></i> {0}</span>',g.text)},formatSelection:function(b){var g=b||{};return String.format('<span><i class="icon-building"></i> {0}</span>',g.text)}});this.$redactorContent=this.$input.content.redactor({autoresize:false,mobile:true,lang:"vi",source:true});var j=function(){f||(f=new iNet.ui.dialog.ModalDialog({id:"procedure-modal-confirm-file-delete",title:iNet.resources.constant.del_title,content:iNet.resources.constant.del_content,buttons:[{text:iNet.resources.message.button.ok,
cls:"btn-danger",icon:"icon-ok icon-white",fn:function(){var b=this.getData(),g=this,e=b.element,i=e.attr("data-id");iNet.isEmpty(i)||$.postJSON(iNet.getUrl("onegate/material/delete"),{procedure:b.procedure,contentID:i},function(h){g.hide();if(h=="SUCCESS"){e.remove();a.resize()}})}},{text:iNet.resources.message.button.cancel,icon:"icon-remove",fn:function(){this.hide()}}]}));f.show();return f};this.$filesContainer.on("click","a[data-file-action]",function(){var b=$(this),g=b.attr("data-file-action"),
e=$(b.parent()),i=a.ownerData;switch(g){case "delete":var h=j();$.each(i.attachments||[],function(k,l){l.contentID==e.attr("data-id")&&h.setContent(String.format(iNet.resources.constant.del_content,l.filename))});h.setData({element:e,procedure:i.uuid});h.show();break;case "download":$.download(iNet.getUrl("glbgate/prodmaterial/download"),{procedure:i.uuid,contentID:e.attr("data-id")});break;case "used":h=a.createConfirmExportUsed();h.setData({procedure:i.uuid,contentID:e.attr("data-id"),exportUsed:true,
fn:function(k){if(k=="SUCCESS"){e.find('[data-file-action="used"]').remove();e.find('[data-span="footer"]').remove();e.append('<a data-file-action="notused" href="javascript:;"> '+a.resource.procedure.exportNoUsed+'</a><span data-span="footer"> ]</span>')}}});h.setContent(a.resource.procedure.exportUsedContent);h.show();break;case "notused":h=a.createConfirmExportUsed();h.setData({procedure:i.uuid,contentID:e.attr("data-id"),exportUsed:false,fn:function(k){if(k=="SUCCESS"){e.find('[data-file-action="notused"]').remove();
e.find('[data-span="footer"]').remove();e.append('<a data-file-action="used" href="javascript:;"> '+a.resource.procedure.exportUsed+'</a><span data-span="footer"> ]</span>')}}});h.setContent(a.resource.procedure.exportNoUsedContent);h.show()}});c.bootstrap=="v2"&&this.$fileLabel.click(function(){a.$file.trigger("click")}.createDelegate(this));this.$file.change(function(){a.setFiles(this.files||[])});this.$fileRemove.click(function(){a.clearFile()});this.validate=new iNet.ui.form.Validate({id:this.id,
rules:[{id:this.$input.subject.prop("id"),validate:function(b){if(iNet.isEmpty(b))return"T\u00ean th\u1ee7 t\u1ee5c kh\u00f4ng \u0111\u01b0\u1ee3c \u0111\u1ec3 r\u1ed7ng"}},{id:this.$input.code.prop("id"),validate:function(b){if(iNet.isEmpty(b))return"M\u00e3 th\u1ee7 t\u1ee5c kh\u00f4ng \u0111\u01b0\u1ee3c \u0111\u1ec3 r\u1ed7ng"}},{id:"procedure-select-industry-container",validate:function(){if(a.industrySelect){var b=a.industrySelect.getData()||{};if(iNet.isEmpty(b.id))return"L\u0129nh v\u1ef1c kh\u00f4ng \u0111\u01b0\u1ee3c \u0111\u1ec3 r\u1ed7ng"}}}]});
this.$toolbar.BACK.on("click",function(){this.hide();this.fireEvent("back",this)}.createDelegate(this));this.$toolbar.CREATE.on("click",function(){this.resetData()}.createDelegate(this));this.$toolbar.SAVE.on("click",function(){if(this.check()){var b=this,g=this.getData(),e;iNet.isEmpty(g.procedure)?this.$form.ajaxSubmit({url:iNet.getUrl("glbgate/prodmaterial/create"),data:g,beforeSubmit:function(){e=new iNet.ui.form.LoadingItem({maskBody:b.$form,msg:iNet.resources.ajaxLoading.saving})},success:function(i){e&&
e.destroy();var h=i||{};b.setData(h);b.fireEvent("saved",true,h)}}):this.$form.ajaxSubmit({url:iNet.getUrl("onegate/material/update"),data:g,beforeSubmit:function(){e=new iNet.ui.form.LoadingItem({maskBody:b.$form,msg:iNet.resources.ajaxLoading.saving})},success:function(i){e&&e.destroy();var h=i||{};if(CommonService.isSuccess(h)){b.notifySuccess(b.resource.constant.save_title,b.resource.constant.save_success);b.loadById(g.procedure,"profile")}else b.notifyError(b.resource.constant.save_title,b.getNotifyContent(b.resource.constant.save_error,
h.errors||[]))}})}}.createDelegate(this));this.$btnCollapse.on("click",function(){var b=$(this).find("i");if(a.$infoContainer.is(":hidden")){b.attr("class","icon-chevron-up");a.$infoContainer.show()}else{a.$infoContainer.hide();b.attr("class","icon-chevron-down")}a.resize()});$(window).on("resize",function(){a.resize()})};iNet.extend(iNet.ui.admin.ProcedureDetailWidget,iNet.ui.app.widget,{resize:function(){this.$input.content.prev().height($(window).height()-195)},check:function(){return this.validate.check()},
setIndustry:function(d){this.industrySelect.setData(d);this.$input.code.val($(d.element).data("pattern"))},resetData:function(){this.ownerData={};this.$input.serviceLevel3.prop("checked",false);this.$input.serviceLevel4.prop("checked",false);this.$input.isPostOffice.prop("checked",false);this.$redactorContent.setCode("");var d=this.industrySelect.getData();this.$input.code.val($(d.element).data("pattern"));if(this.hasPattern()){this.industrySelect.disable();this.levelSelect.disable()}else{this.industrySelect.enable();
this.levelSelect.enable()}this.$input.subject.val("").focus();this.$input.hours.val("0");this.$input.maxTimeWait.val("0");this.fillFiles([]);this.clearFile()},setData:function(d){var c=d||{serviceL3:false,serviceL4:false,attachments:[]};c=this.ownerData=iNet.apply(this.ownerData||{},c);this.$input.subject.val(c.subject);this.$input.code.val(c.code);d=this.$input.industry.find(String.format('option[value="{0}"]',c.industry));this.industrySelect.setData({id:c.code,text:c.industry,element:d});d=this.$input.level.find(String.format('option[value="{0}"]',
c.level));this.levelSelect.setData({id:c.level,text:d.text(),element:d});if(this.hasPattern()){this.industrySelect.disable();this.levelSelect.disable();this.$input.subject.prop("disabled",true)}else{this.levelSelect.enable();this.industrySelect.enable();this.$input.subject.prop("disabled",false)}this.$input.serviceLevel3.prop("checked",c.serviceL3);this.$input.serviceLevel4.prop("checked",c.serviceL4);this.$input.isPostOffice.prop("checked",c.postOffice);if(!iNet.isEmpty(this.profile)){this.$input.subject.prop("disabled",
true);this.$input.code.prop("disabled",true);this.$input.industry.prop("disabled",true);this.$input.level.prop("disabled",true)}this.$input.hours.val(c.hours||0);this.$input.maxTimeWait.val(c.maxTimeWait||0);this.$redactorContent.setCode(c.html||"");this.clearFile();this.fillFiles(c.attachments||[]);this.check()},getData:function(){var d=this.industrySelect.getData(),c=this.levelSelect.getData(),a={code:this.$input.code.val(),level:c.id,industry:d.id,serviceL4:this.$input.serviceLevel4.prop("checked"),
postOffice:this.$input.isPostOffice.prop("checked")?"true":"false",html:this.$redactorContent.getCode()},f=this.ownerData||{};if(!iNet.isEmpty(f.uuid))a.procedure=f.uuid;if(!iNet.isEmpty(this.profile)){a.profileID=this.profile;a.materialUUID=f.uuid}return a},loadById:function(d,c){var a=this,f={};f.procedure=d;if(!iNet.isEmpty(c))a.profile=c;$.getJSON(iNet.getUrl("onegate/prodload"),f,function(j){var b=j||{};if(CommonService.isSuccess(b))a.setData(b);else{a.notifyError(a.resource.constant.warning_title,
a.getNotifyContent(a.resource.constant.warning_error,b.errors||[]));a.$toolbar.BACK.trigger("click")}},{mask:this.getMask(),msg:iNet.resources.ajaxLoading.loading})},clearFile:function(){this.$fileLabel.removeClass("selected").data("title",this.resource.procedure.clickHere);this.$fileLabel.find("span[data-title]").attr("data-title","...");this.$file.val("")},setFiles:function(d){var c=d||[];if(!(c.length<1)){var a=[];for(d=0;d<c.length;d++){var f=c[d]||{};a.push(f.name)}this.$fileLabel.addClass("selected").attr("data-title",
this.resource.procedure.clickHere);c.length==1?this.$fileLabel.find("span[data-title]").attr("data-title",a[0]):this.$fileLabel.find("span[data-title]").attr("data-title",String.format("{0} "+this.resource.procedure.file+": {1} ",a.length,a.join(", ")))}},fillFiles:function(d){this.$filesContainer.empty();var c=d||[],a="";for(d=0;d<c.length;d++){var f=c[d]||{},j='<span data-span="header">[ </span>';j+='<a data-file-action="delete" class="remove" href="javascript:;"><i class="icon-trash red"></i></a>';
j+='<span data-span="middle"> | </span>';j+=f.exportUsed?'<a data-file-action="notused" href="javascript:;"> '+this.resource.procedure.exportNoUsed+"</a>":'<a data-file-action="used" href="javascript:;"> '+this.resource.procedure.exportUsed+"</a>";j+='<span data-span="footer"> ]</span>';if(iNet.isEmpty(f.pathDownload))f.pathDownload="javascript:;";a+=String.format('<li data-id="{0}"><a href="{4}"><i class="{1}"></i>{2}</a> {3}</li>',f.contentID,iNet.FileFormat.getFileIcon(f.filename),f.filename,j,
f.pathDownload)}this.$filesContainer.append(a);c.length>0&&this.$filesContainer.is(":hidden")&&this.$filesContainer.show();this.resize()},createConfirmExportUsed:function(){if(!this.confirmExportUsed)this.confirmExportUsed=new iNet.ui.dialog.ModalDialog({id:"modal-procedure-confirm-export-used",title:"Bi\u1ec3u m\u1eabu k\u1ebft xu\u1ea5t ?",buttons:[{text:"\u0110\u1ed3ng \u00fd",cls:"btn-primary",icon:"icon-ok icon-white",fn:function(){var d=this,c=d.getData(),a=c.procedure,f=c.contentID,j=c.exportUsed,
b=c.fn||iNet.emptyFn;iNet.isEmpty(f)||$.postJSON(iNet.getUrl("onegate/material/exportUsed"),{procedure:a,contentID:f,exportUsed:j},function(g){var e=g||{};if(e.uuid!="FAIL"){b(e);d.hide()}},{mask:this.getMask(),msg:"&nbsp;"})}},{text:"\u0110\u00f3ng",icon:"icon-remove",fn:function(){this.hide()}}]});return this.confirmExportUsed}})});