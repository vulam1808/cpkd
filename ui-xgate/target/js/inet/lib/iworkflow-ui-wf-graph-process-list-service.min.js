$(function(){iNet.ns("iNet.ui.workflow","iNet.ui.workflow.WFGraphProcessList","iNet.ui.workflow.WFGraphProcessCopy");iNet.ui.workflow.WFGraphProcessCopy=function(){this.id="graph-process-list-modal-copy";var j=$("#graph-process-list-modal-copy"),i=this,d={name:$("#graph-process-list-modal-copy-name")},l={submit:$("#graph-process-list-modal-copy-submit-btn"),close:$("#graph-process-list-modal-copy-close-btn")};this.show=function(){d.name.val("");j.modal("show")};this.hide=function(){j.modal("hide")};
var k=function(){i.fireEvent("finish",d.name.val());i.hide()}.createDelegate(this);l.submit.on("click",k);l.close.on("click",function(){i.hide()})};iNet.extend(iNet.ui.workflow.WFGraphProcessCopy,iNet.Component);iNet.ui.workflow.WFGraphProcessList=function(){this.id="graph-process-list-div";var j=iNet.zone,i=iNet.context,d=this,l=null,k=null,p=null,c={graphprocess:iNet.resources.workflow.graphprocess,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},
h={CREATE:$("#graph-process-list-create-btn"),DELETE:$("#graph-process-list-delete-btn"),COPY:$("#graph-process-list-copy-btn")};h.DELETE.hide();h.COPY.hide();roleCreate?h.CREATE.show():h.CREATE.hide();var m={view:iNet.getUrl("cloud/workflow/defproc/list"),create:iNet.getUrl("cloud/workflow/defproc/create"),update:iNet.getUrl("cloud/workflow/defproc/update"),del:iNet.getUrl("cloud/workflow/defproc/delete"),published:iNet.getUrl("cloud/workflow/defproc/published"),detach:iNet.getUrl("firmtask/uiform/detach"),
assign:iNet.getUrl("firmtask/process/assign"),copy:iNet.getUrl("cloud/workflow/defproc/copy"),metaupdate:iNet.getUrl("cloud/workflow/defproc/metaupdate")},o=this.confirmDialog(iNet.resources.message.dialog_confirm_title,d.getNotifyContent(c.constant.del_content,p),function(){if(!iNet.isEmpty(k)){o.hide();$.postJSON(m.del,{zone:j,context:i,process:k},function(a){var b=a||{};if(CommonService.isSuccess(b)){var e=k.split(",");for(a=0;a<e.length;a++)f.remove(e[a]);k=null;h.DELETE.hide();d.notifySuccess(c.constant.del_title,
c.constant.del_success)}else d.notifyError(c.constant.del_title,d.getNotifyContent(c.constant.del_error,b.errors||[]))},{mask:d.getMask(),msg:iNet.resources.ajaxLoading.deleting})}}),z=[{value:"AUTOMATIC",text:c.graphprocess["ProcessType.AUTOMATIC"]},{value:"MANUAL",text:c.graphprocess["ProcessType.MANUAL"]},{value:"SEMI_AUTOMATIC",text:c.graphprocess["ProcessType.SEMI_AUTOMATIC"]}],t=[{value:"DESIGN",text:c.graphprocess["VersionState.DESIGN"]},{value:"PRODUCTION",text:c.graphprocess["VersionState.PRODUCTION"]}],
y=new DataSource({columns:[{property:"name",label:c.graphprocess.name,sortable:true,disabled:true,type:"text",validate:function(a){if($.trim(a)=="")return String.format(c.validate.is_not_blank,c.graphprocess.name)}},{property:"brief",label:c.graphprocess.brief,sortable:true,type:"text"},{property:"version",label:c.graphprocess.version,type:"select",editData:t,disabled:true,width:150,validate:function(a){if($.trim(a)=="")return String.format(c.validate.is_not_blank,c.graphprocess.version)}},{label:"",
type:"action",width:140,align:"center",buttons:[{text:iNet.resources.message.button.edit,icon:"icon-edit",labelCls:"label label-warning",fn:function(a){d.hide();var b=u();b.loadData(a);b.setPageBack(d);b.show()}},{text:c.graphprocess["VersionState.DESIGN"],icon:"icon-globe",labelCls:"label label-default",fn:function(a){v(a)},visibled:function(a){var b=a||{};return b.version=="PRODUCTION"}},{text:c.graphprocess["VersionState.PRODUCTION"],icon:"icon-globe",labelCls:"label label-info",fn:function(a){w(a)},
visibled:function(a){var b=a||{};return b.version=="DESIGN"}},{text:c.graphprocess.map,icon:"icon-cogs",labelCls:"label label-success",fn:function(a){d.hide();var b=x();b.loadData(a);b.setPageBack(d);b.show()},visibled:function(a){var b=a||{};return b.version=="PRODUCTION"}},{text:iNet.resources.message.button.del,icon:"icon-trash",labelCls:"label label-important",fn:function(a){k=a.uuid.toString();p=a.name;o.setContent(String.format(c.constant.del_content,p));o.show()},visibled:function(a){var b=
a||{};return b.version=="DESIGN"}}]}],delay:250}),f=new iNet.ui.grid.Grid({id:"graph-process-list-grid",url:m.view,params:{zone:j,context:i},convertData:function(a){var b=a||{};return b.items||[]},dataSource:y,stretchHeight:false,editable:true,firstLoad:true,idProperty:"uuid"});f.on("beforeedit",function(a,b){var e=f.getColumnModel().getColumnByName("version").getCellEditor(b,a.uuid);e.setDisabled(a.version=="DESIGN")});f.on("click",function(a){d.graphData=a;h.COPY.show()});f.on("loaded",function(){d.graphData=
{};h.COPY.hide()});f.on("save",function(a){var b=a||{};if(!iNet.isEmpty(b.brief))b.brief=b.name;b.zone=j;b.context=i;b.type="AUTOMATIC";$.postJSON(m.create,b,function(e){var g=e||{};if(CommonService.isSuccess(g)){f.insert(g);d.notifySuccess(c.constant.save_title,c.constant.save_success)}else d.notifyError(c.constant.save_title,d.getNotifyContent(c.constant.save_error,g.errors||[]))})});f.on("update",function(a,b){var e=iNet.apply(b,a)||{};e.zone=j;e.context=i;e.type="AUTOMATIC";$.postJSON(m.metaupdate,
e,function(g){var n=g||{};if(CommonService.isSuccess(n)){f.update(n);f.commit();d.notifySuccess(c.constant.save_title,c.constant.save_success)}else d.notifyError(c.constant.save_title,d.getNotifyContent(c.constant.save_error,n.errors||[]))},{msg:iNet.resources.ajaxLoading.updating,mask:d.getMask()})});f.on("blur",function(a,b){a=="update"?f.endEdit():b.save()});f.on("selectionchange",function(a){a=a.getSelection();for(var b=a.length,e=[],g=[],n=0;n<b;n++){var s=a[n];e.push(s.uuid);g.push(s.name)}k=
e.join(iNet.splitChar);p=g.join(iNet.splitChar)});var q=null,u=function(){if(q==null){q=new iNet.ui.workflow.WFGraphProcess;q.on("finish",function(){if(roleView||roleCreate)f.load()})}return q},r=null,x=function(){if(r==null){r=new iNet.ui.workflow.WFGraphProcessMap;r.on("finish",function(){})}return r},w=function(a){var b=a||{},e={graph:b.uuid,zone:b.zone};$.postJSON(m.published,e,function(g){if(CommonService.isSuccess(g)){d.notifySuccess(c.constant.submit_title,c.constant.submit_success);f.load()}else d.notifyError(c.constant.submit_title,
d.getNotifyContent(c.constant.submit_error,g.errors||[]))},{msg:iNet.resources.ajaxLoading.updating,mask:d.getMask()})},v=function(a){var b=a||{};b.zone=j;b.context=i;b.type="AUTOMATIC";b.version="DESIGN";$.postJSON(m.metaupdate,b,function(e){if(CommonService.isSuccess(e)){d.notifySuccess(c.constant.submit_title,c.constant.submit_success);f.load()}else d.notifyError(c.constant.submit_title,d.getNotifyContent(c.constant.submit_error,e.errors||[]))},{msg:iNet.resources.ajaxLoading.updating,mask:d.getMask()})};
h.CREATE.on("click",function(){h.DELETE.hide();f.newRecord({version:"DESIGN"});var a=f.getColumnModel(),b=a.getColumnByName("name").getCellAdd(1);b.setDisabled(false);b.setValue("");var e=a.getColumnByName("brief").getCellAdd(1);e.setDisabled(false);e.setValue("");var g=a.getColumnByName("version").getCellAdd(1);g.setDisabled(true);g.setValue("DESIGN")});h.DELETE.on("click",function(){o.setContent(iNet.resources.message.dialog_confirm_selected_content);o.show()});h.COPY.on("click",function(){if(l==
null)l=new iNet.ui.workflow.WFGraphProcessCopy;l.on("finish",function(a){if(!iNet.isEmpty(a)){var b=d.graphData||{},e={process:b.uuid,zone:b.zone,name:a};$.postJSON(m.copy,e,function(g){if(CommonService.isSuccess(g)){d.notifySuccess(c.constant.submit_title,c.constant.submit_success);f.load()}else d.notifyError(c.constant.submit_title,d.getNotifyContent(c.constant.submit_error,g.errors||[]))},{msg:iNet.resources.ajaxLoading.processing,mask:d.getMask()})}});l.show()});iNet.ui.workflow.WFGraphProcessList.superclass.constructor.call(this)};
iNet.extend(iNet.ui.workflow.WFGraphProcessList,iNet.ui.app.widget);(new iNet.ui.workflow.WFGraphProcessList).show()});