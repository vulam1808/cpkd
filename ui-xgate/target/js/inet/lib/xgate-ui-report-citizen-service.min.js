$(function(){iNet.ns("iNet.ui.report","iNet.ui.report.Citizen");iNet.ui.report.Citizen=function(){this.id="report-citizen-div";var g=this,c={citizen:iNet.resources.xgate.report.citizen,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},h={SEARCH:$("#report-citizen-search-btn"),PRINT:$("#report-citizen-print-btn"),VIEW:$("#report-citizen-view-btn"),EXPORT:$("#report-citizen-export-btn")},i={procedureList:iNet.getUrl("onegate/procedure/maplist"),
report:iNet.getUrl("firmtask/report/task"),view:iNet.getUrl("onegate/deptrecord/report"),generator:iNet.getUrl("onegate/excel/generator"),chkstatus:iNet.getUrl("report/file/chkstatus"),download:iNet.getUrl("report/file/download")},b={fromDate:$("#report-citizen-from"),toDate:$("#report-citizen-to"),procedure:$("#report-citizen-procedure"),status:$("#report-citizen-status"),report:$("#report-citizen-content")},m=b.fromDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",function(){m.hide()}).data("datepicker");
b.fromDate.val(CommonService.getFirstDate());var n=b.toDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",function(){n.hide()}).data("datepicker");b.toDate.val(CommonService.getCurrentDate());b.procedure=FormService.createSelect("report-citizen-procedure",[],"id",1,true,false);$.postJSON(i.procedureList,{},function(a){var d=a||{};if(CommonService.isSuccess(d)){var e=[];$.each(d.elements||[],function(f,j){e.push({id:j.uuid,code:j.uuid,name:j.subject})});b.procedure=FormService.createSelect("report-citizen-procedure",
e,"id",1,true,false)}});var o=[{id:"",code:"",name:c.citizen.statusAll},{id:"INPROCESS",code:"INPROCESS",name:c.citizen.statusINPROCESS},{id:"COMPLETED",code:"COMPLETED",name:c.citizen.statusCOMPLETED},{id:"REJECTED",code:"REJECTED",name:c.citizen.statusREJECTED},{id:"PUBLISHED",code:"PUBLISHED",name:c.citizen.statusPUBLISHED}];b.status=FormService.createSelect("report-citizen-status",o,"id",1,true,false);b.status.setValue("");var p=new DataSource({columns:[{property:"procedureName",label:c.citizen.procedureName,
sortable:true,disabled:true},{property:"subject",label:c.citizen.subject,sortable:true,disabled:true},{property:"fullName",label:c.citizen.fullName,sortable:true,disabled:true},{property:"status",label:c.citizen.status,sortable:true,disabled:true},{property:"created",label:c.citizen.created,sortable:true,disabled:true},{property:"appointment",label:c.citizen.appointment,sortable:true,disabled:true},{property:"completed",label:c.citizen.completed,sortable:true,disabled:true}],delay:250}),k=new iNet.ui.grid.Grid({id:"report-citizen-grid",
url:i.view,params:{},convertData:function(a){var d=a||{};$.each(d.items||[],function(e,f){f.status=c.citizen["status"+f.status]||"";f.created=f.created>0?(new Date(f.created)).format("H:i d/m/Y"):"";f.appointment=f.appointment>0?(new Date(f.appointment)).format("H:i d/m/Y"):"";f.completed=f.completed>0?(new Date(f.completed)).format("H:i d/m/Y"):""});return d.items},dataSource:p,stretchHeight:false,editable:false,firstLoad:false,idProperty:"uuid"});h.SEARCH.on("click",function(){var a={};a.from=b.fromDate.val().dateToLong();
a.to=b.toDate.val().endDateToLong();a.procedure=b.procedure.getValue()||"";a.status=b.status.getValue()||"";$.postJSON(i.report,a,function(d){var e=d||{};h.PRINT.hide();if(CommonService.isSuccess(e)){b.report.html(e);h.PRINT.show()}else g.notifyError(c.constant.submit_title,g.getNotifyContent(c.constant.submit_error,e.errors||[]))},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})});h.PRINT.on("click",function(){var a=document.createElement("iframe");a.name="framePrint";a.style.position=
"absolute";a.style.top="-1000000px";document.body.appendChild(a);var d=a.contentWindow?a.contentWindow:a.contentDocument.document?a.contentDocument.document:a.contentDocument;d.document.open();d.document.write(b.report.html());d.document.close();setTimeout(function(){window.frames.framePrint.focus();window.frames.framePrint.print();document.body.removeChild(a)},500)});h.VIEW.on("click",function(){var a={};a.from=b.fromDate.val().dateToLong();a.to=b.toDate.val().endDateToLong();a.procedure=b.procedure.getValue()||
"";a.status=b.status.getValue()||"";k.setParams(a);k.load();h.EXPORT.show()});var l=function(a){$.postJSON(i.chkstatus,{reportID:a},function(d){var e=d||0;if(e==2)window.location.href=i.download+"?reportID="+a;else e==1&&setTimeout(function(){l(a)},2E3)},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})};h.EXPORT.on("click",function(){var a=k.getParams()||{};a.type="Record";$.postJSON(i.generator,a,function(d){var e=d||{};CommonService.isSuccess(e)?setTimeout(function(){l(e.uuid)},2E3):g.notifyError(c.constant.submit_title,
g.getNotifyContent(c.constant.submit_error,e.errors||[]))},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})});iNet.ui.report.Citizen.superclass.constructor.call(this)};iNet.extend(iNet.ui.report.Citizen,iNet.ui.app.widget);(new iNet.ui.report.Citizen).show()});