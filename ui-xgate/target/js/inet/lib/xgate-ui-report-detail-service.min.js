$(function(){iNet.ns("iNet.ui.report","iNet.ui.report.Detail");iNet.ui.report.Detail=function(){this.id="report-detail-div";var j=this,f={source:{procedureList:[],industry:[],procedure:[]}},g={detail:iNet.resources.xgate.report.detail,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},k={SEARCH:$("#report-detail-search-btn"),PRINT:$("#report-detail-print-btn"),VIEW:$("#report-detail-view-btn"),EXPORT:$("#report-detail-export-btn")},
i={report:iNet.getUrl("onegate/detailreport"),view:iNet.getUrl("onegate/detailreport"),procedurelist:iNet.getUrl("onegate/procedurelist"),procedureAttr:iNet.getUrl("onegate/prodattr"),loadGraphs:iNet.getUrl("onegate/deptgraphs/load"),generator:iNet.getUrl("onegate/excel/generator"),chkstatus:iNet.getUrl("report/file/chkstatus"),download:iNet.getUrl("report/file/download")},b={fromDate:$("#report-detail-from"),toDate:$("#report-detail-to"),report:$("#report-detail-content"),industry:$("#report-detail-industry"),
procedure:$("#report-detail-procedure"),keyword:$("#report-detail-keyword"),serialNo:$("#report-detail-serialNo"),receiptNo:$("#report-detail-receiptNo"),attr:$("#report-detail-attr")};b.industry=FormService.createSelect("report-detail-industry",f.source.industry,"id",1,true,false);b.procedure=FormService.createSelect("report-detail-procedure",f.source.procedure,"id",1,true,false);b.attr=FormService.createSelect("report-detail-attr",[],"id",1,true,true);var q=b.fromDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",
function(){q.hide()}).data("datepicker");b.fromDate.val(CommonService.getFirstDate());var r=b.toDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",function(){r.hide()}).data("datepicker");b.toDate.val(CommonService.getCurrentDate());var n=function(){b.attr=FormService.createSelect("report-detail-attr",[],"id",1,true,true);iNet.isEmpty(b.procedure.getValue())||$.postJSON(i.procedureAttr,{procedure:b.procedure.getValue()},function(a){var d=a||{};if(CommonService.isSuccess(d))b.attr=FormService.createSelect("report-detail-attr",
d.elements||[],"id",1,true,true)})};(function(){$.postJSON(i.procedurelist,{},function(a){var d=a||{};f.source.procedureList=d.elements||[];f.source.industry=[];f.source.procedure=[];var h=";";$.each(f.source.procedureList,function(c,e){if(h.indexOf(";"+e.industry+";")<0){f.source.industry.push({id:e.industry,code:e.industry,name:e.industry});h+=e.industry+";"}f.source.procedure.push({id:e.uuid,code:e.uuid,name:e.subject})});b.industry=FormService.createSelect("report-detail-industry",f.source.industry,
"id",1,true,false);b.industry.on("change",function(){f.source.procedure=[];b.procedure.setValue("");$.each(f.source.procedureList,function(c,e){if(e.industry.indexOf(b.industry.getValue())>=0||b.industry.getValue()=="")f.source.procedure.push({id:e.uuid,code:e.uuid,name:e.subject})});b.procedure=FormService.createSelect("report-detail-procedure",f.source.procedure,"id",1,true,false);b.procedure.on("change",function(){n()});b.attr=FormService.createSelect("report-detail-attr",[],"id",1,true,true)});
b.procedure=FormService.createSelect("report-detail-procedure",f.source.procedure,"id",1,true,false);b.procedure.on("change",function(){n()});b.attr=FormService.createSelect("report-detail-attr",[],"id",1,true,true)})})();var s=new DataSource({columns:[{property:"subject",label:g.detail.subject,sortable:true,disabled:true},{property:"serialNo",label:g.detail.serialNo,sortable:true,disabled:true},{property:"receiptNo",label:g.detail.receiptNo,sortable:true,disabled:true},{property:"fullName",label:g.detail.fullName,
sortable:true,disabled:true},{property:"created",label:g.detail.created,sortable:true,disabled:true},{property:"appointment",label:g.detail.appointment,sortable:true,disabled:true},{property:"completed",label:g.detail.completed,sortable:true,disabled:true}],delay:250}),m=new iNet.ui.grid.Grid({id:"report-detail-grid",url:i.view,params:{pageNumber:0,pageSize:10},convertData:function(a){var d=a||{};m.setTotal(d.total);$.each(d.items||[],function(h,c){c.created=c.created>0?(new Date(c.created)).format("H:i d/m/Y"):
"";c.appointment=c.appointment>0?(new Date).getTime()>c.appointment&&c.completed==0||c.completed>c.appointment?'<label style="color: #ff0511;font-weight: bolder;">'+(new Date(c.appointment)).format("H:i d/m/Y")+"</label>":'<label style="color:#0000C0;font-weight: bolder;">'+(new Date(c.appointment)).format("H:i d/m/Y")+"</label>":"";c.completed=c.completed>0?(new Date(c.completed)).format("H:i d/m/Y"):"";c.status=g.detail["status"+c.status]||""});return d.items||[]},dataSource:s,stretchHeight:false,
editable:false,firstLoad:false,remotePaging:true,idProperty:"uuid"}),o=function(){var a=m.getParams()||{};a.from=b.fromDate.val().dateToLong();a.to=b.toDate.val().endDateToLong();a.keyword=b.keyword.val();a.serial=b.serialNo.val();a.receipt=b.receiptNo.val();if(b.procedure!=null)a.procedure=b.procedure.getValue();if(b.industry!=null)a.industry=b.industry.getValue();if(b.attr!=null)a.attrs=b.attr.getValue().toString();return a};k.SEARCH.on("click",function(){$.postJSON(i.report,o(),function(a){var d=
a||{};k.PRINT.hide();if(CommonService.isSuccess(d)){b.detail.html(d);k.PRINT.show()}else j.notifyError(g.constant.submit_title,j.getNotifyContent(g.constant.submit_error,d.errors||[]))},{mask:j.getMask(),msg:iNet.resources.ajaxLoading.loading})});k.PRINT.on("click",function(){var a=document.createElement("iframe");a.name="framePrint";a.style.position="absolute";a.style.top="-1000000px";document.body.appendChild(a);var d=a.contentWindow?a.contentWindow:a.contentDocument.document?a.contentDocument.document:
a.contentDocument;d.document.open();d.document.write(b.detail.html());d.document.close();setTimeout(function(){window.frames.framePrint.focus();window.frames.framePrint.print();document.body.removeChild(a)},500)});k.VIEW.on("click",function(){m.setParams(o());m.load();k.EXPORT.show()});var p=function(a){$.postJSON(i.chkstatus,{reportID:a},function(d){var h=d||0;if(h==2)window.location.href=i.download+"?reportID="+a;else h==1&&setTimeout(function(){p(a)},2E3)},{mask:j.getMask(),msg:iNet.resources.ajaxLoading.loading})};
k.EXPORT.on("click",function(){var a=m.getParams()||{};a.attrs="";a.labels="";$.postJSON(i.loadGraphs,{},function(d){var h=d||[];console.log(">>graphs>>",h,h.toString());a.graphs=h.toString();if(b.attr!=null){var c=(b.attr.getData()||[]).length-1;$(b.attr.getData()||[]).each(function(e,l){a.attrs+=l.id+(c==e?"":",");a.labels+=l.name+(c==e?"":",")})}a.type=iNet.isEmpty(a.attrs)?"Detail":"ProcedureDetail";$.postJSON(i.generator,a,function(e){var l=e||{};CommonService.isSuccess(l)?setTimeout(function(){p(l.uuid)},
2E3):j.notifyError(g.constant.submit_title,j.getNotifyContent(g.constant.submit_error,l.errors||[]))},{mask:j.getMask(),msg:iNet.resources.ajaxLoading.loading})})});iNet.ui.report.Detail.superclass.constructor.call(this)};iNet.extend(iNet.ui.report.Detail,iNet.ui.app.widget);(new iNet.ui.report.Detail).show()});