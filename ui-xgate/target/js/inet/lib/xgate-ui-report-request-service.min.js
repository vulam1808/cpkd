$(function(){iNet.ns("iNet.ui.report","iNet.ui.report.Request");iNet.ui.report.Request=function(){this.id="report-request-div";var g=this,e={report:iNet.resources.xgate.report.request,global:iNet.resources.global,errors:iNet.resources.errors,constant:iNet.resources.constant,validate:iNet.resources.validate},h={SEARCH:$("#report-request-search-btn"),PRINT:$("#report-request-print-btn"),VIEW:$("#report-request-view-btn"),EXPORT:$("#report-request-export-btn")},i={graphList:iNet.getUrl("cloud/workflow/defproc/list"),
userList:iNet.getUrl("system/account/role"),report:iNet.getUrl("firmtask/report/requester"),view:iNet.getUrl("firmtask/view/request"),generator:iNet.getUrl("onegate/excel/generator"),chkstatus:iNet.getUrl("report/file/chkstatus"),download:iNet.getUrl("report/file/download")},b={fromDate:$("#report-request-from"),toDate:$("#report-request-to"),requester:$("#report-request-requester"),graph:$("#report-request-graph"),report:$("#report-request-content")},m=b.fromDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",
function(){m.hide()}).data("datepicker");b.fromDate.val(CommonService.getFirstDate());var n=b.toDate.datepicker({format:"dd/mm/yyyy"}).on("changeDate",function(){n.hide()}).data("datepicker");b.toDate.val(CommonService.getCurrentDate());b.requester=FormService.createSelect("report-request-requester",[],"id",1,true,false);$.postJSON(i.userList,{},function(a){var c=a||{};if(CommonService.isSuccess(c)){var d=[];$.each(c.items||[],function(f,j){d.push({id:j.username,code:j.username,name:j.fullname})});
b.requester=FormService.createSelect("report-request-requester",d,"id",1,true,false)}});b.graph=FormService.createSelect("report-request-graph",[],"id",1,true,false);$.postJSON(i.graphList,{zone:iNet.zone,context:iNet.context,version:"PRODUCTION"},function(a){var c=a||{};if(CommonService.isSuccess(c)){var d=[];$.each(c.items||[],function(f,j){d.push({id:j.uuid,code:j.uuid,name:j.name})});b.graph=FormService.createSelect("report-request-graph",d,"id",1,true,false)}});var o=new DataSource({columns:[{property:"subject",
label:e.report.subject,sortable:true,disabled:true},{property:"requestorName",label:e.report.requestorName,sortable:true,disabled:true},{property:"requestTime",label:e.report.requestTime,sortable:true,disabled:true},{property:"completedTime",label:e.report.completedTime,sortable:true,disabled:true},{property:"status",label:e.report.status,sortable:true,disabled:true}],delay:250}),k=new iNet.ui.grid.Grid({id:"report-request-grid",url:i.view,params:{},convertData:function(a){var c=a||{};$.each(c.items||
[],function(d,f){f.status=e.report.statusCreated;if(f.completedTime>0)f.status=e.report.statusCompleted;f.completedTime=(f.completedTime||0)>0?(f.completedTime||0).longToDate():"";f.requestTime=(f.requestTime||0).longToDate()});return c.items},dataSource:o,stretchHeight:false,editable:false,firstLoad:false,idProperty:"uuid"});h.SEARCH.on("click",function(){var a={};a.from=b.fromDate.val().dateToLong();a.to=b.toDate.val().endDateToLong();a.requester=b.requester.getValue()||"";a.graph=b.graph.getValue()||
"";$.postJSON(i.report,a,function(c){var d=c||{};h.PRINT.hide();if(CommonService.isSuccess(d)){b.report.html(d);h.PRINT.show()}else g.notifyError(e.constant.submit_title,g.getNotifyContent(e.constant.submit_error,d.errors||[]))},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})});h.PRINT.on("click",function(){var a=document.createElement("iframe");a.name="framePrint";a.style.position="absolute";a.style.top="-1000000px";document.body.appendChild(a);var c=a.contentWindow?a.contentWindow:a.contentDocument.document?
a.contentDocument.document:a.contentDocument;c.document.open();c.document.write(b.report.html());c.document.close();setTimeout(function(){window.frames.framePrint.focus();window.frames.framePrint.print();document.body.removeChild(a)},500)});h.VIEW.on("click",function(){var a={};a.from=b.fromDate.val().dateToLong();a.to=b.toDate.val().endDateToLong();a.requester=b.requester.getValue()||"";a.graph=b.graph.getValue()||"";k.setParams(a);k.load();h.EXPORT.show()});var l=function(a){$.postJSON(i.chkstatus,
{reportID:a},function(c){var d=c||0;if(d==2)window.location.href=i.download+"?reportID="+a;else d==1&&setTimeout(function(){l(a)},2E3)},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})};h.EXPORT.on("click",function(){var a=k.getParams()||{};a.type="Request";$.postJSON(i.generator,a,function(c){var d=c||{};CommonService.isSuccess(d)?setTimeout(function(){l(d.uuid)},2E3):g.notifyError(e.constant.submit_title,g.getNotifyContent(e.constant.submit_error,d.errors||[]))},{mask:g.getMask(),msg:iNet.resources.ajaxLoading.loading})});
iNet.ui.report.Request.superclass.constructor.call(this)};iNet.extend(iNet.ui.report.Request,iNet.ui.app.widget);(new iNet.ui.report.Request).show()});